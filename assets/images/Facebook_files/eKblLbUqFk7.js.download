;/*FB_PKG_DELIM*/

__d("EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="30303731999218226"}),null);
__d("EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery.graphql",["EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"request_uuid"},c={defaultValue:null,kind:"LocalArgument",name:"virtual_device_id"},d={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},e={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},f={alias:null,args:null,concreteType:"FetchVirtualDeviceInfoMinosEpochSerializablePayload",kind:"LinkedField",name:"minos_epoch",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"self_epoch_signature",storageKey:null}],storageKey:null};d=[{alias:null,args:[{fields:[{kind:"Variable",name:"request_uuid",variableName:"request_uuid"},{kind:"Variable",name:"virtual_device_id",variableName:"virtual_device_id"}],kind:"ObjectValue",name:"request"}],concreteType:"FetchVirtualDeviceInfoResponseWrapper",kind:"LinkedField",name:"fetch_virtual_device_info_for_device_addition_v2",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ok",storageKey:null},{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoError",kind:"LinkedField",name:"error",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"code",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoResponse",kind:"LinkedField",name:"data",plural:!1,selections:[{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoEncryptedSecretValues",kind:"LinkedField",name:"encrypted_secret_values",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"encrypted_epoch_anon_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_epoch_root_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_epoch_storage_private_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mailbox_root_key_blob",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_oblivious_validation_token_blob",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_ocmf_client_state",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_orf_client_state_v2",storageKey:null}],storageKey:null},d,{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_epoch_id",storageKey:null},{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoSyncEpochsPayload",kind:"LinkedField",name:"sync_epochs",plural:!0,selections:[d,{alias:null,args:null,kind:"ScalarField",name:"encrypted_epoch_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},e,{alias:null,args:null,kind:"ScalarField",name:"epoch_auth_public_key",storageKey:null},{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoEpochDataSerializablePayload",kind:"LinkedField",name:"epoch_data_v2",plural:!1,selections:[e,{alias:null,args:null,kind:"ScalarField",name:"epoch_root_key",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"is_active_epoch",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_epoch_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"prev_epoch_id",storageKey:null},f],storageKey:null},f],storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:[a,c],kind:"Fragment",metadata:null,name:"EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery",selections:d,type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,a],kind:"Operation",name:"EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery",selections:d},params:{id:b("EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery_facebookRelayOperation"),metadata:{},name:"EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBGetLSVirtualDevices",["ReQL"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.encrypted_backups_virtual_devices))}g.getLSVirtualDevices=a}),98);
__d("LSHandleWrongRecoveryCode",["LSAppendDataTraceAddon","LSIsMobileClient","LSLogMebClientEvent.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure] Beginning execution."),a[0]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,1021646192]),a[0],"dasm_handle_wrong_recovery_code_sproc_start"):c.resolve()},function(d){return a[0]!==void 0?a[1]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,1021646192]),a[0],"dasm_handle_wrong_recovery_code_error_message",a[1]):c.resolve():c.resolve()},function(e){return c.sequence([function(d){return a[0]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),a[0],c.i64.cast([0,1415]),c.i64.cast([0,2]),a[1],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[7]=a[0],a})},function(a){return d[7]?d[8]=!0:d[8]=!1,d[8]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[10]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[10]].join("")),d[9]=c.createArray(),void 0!==void 0?d[11]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[10],d[9],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,3])})},function(e){return a[2]?c.resolve(0):a[1]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure] ","",a[1]].join("")),d[7]=c.createArray(),void 0!==void 0?d[8]=(d[7].push(void 0),d[7]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure",a[1],d[7],c.i64.cast([0,3]))):c.resolve()},function(d){return a[0]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,1021646192]),a[0],"dasm_handle_wrong_recovery_code_sproc_end"):c.resolve()},function(a){return d[1]=c.i64.of_float(Date.now()),d[2]=c.i64.random(),d[4]="Finishing execution. Execution time: ",d[5]=c.i64.to_string(c.i64.sub(d[1],d[0])),d[6]=" ms",d[3]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure] ",d[3],d[4],d[3],d[5],d[3],d[6]].join("")),c.i64.eq(c.i64.mod_(d[2],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[7]=",",d[8]=c.createArray(),void 0!==void 0?d[9]=(d[8].push(void 0),d[8]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure",[d[4],d[7],d[5],d[7],d[6]].join(""),d[8],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure";a.__tables__=["secure_encrypted_backups_recovery_code_status"];e.exports=a}),null);
__d("LSIsValidEpochAnonIdFlow",[],(function(a,b,c,d,e,f){"use strict";var g=11;function a(a){if(a.byteLength>g)return!1;a=new Int8Array(a);var b=0;for(var c=0;c<a.length;c++)b|=+(a[c]<48),b|=+(a[c]>57);return b===0}f.call=a}),66);
__d("LSIsValidEpochAnonId.nop",["LSIsValidEpochAnonIdFlow","LSResult","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a,e,f){return(h||(h=b("Promise"))).resolve(c("LSResult")(d("LSIsValidEpochAnonIdFlow").call(f)))};a.__nop_name__="LSIsValidEpochAnonId";g["default"]=a}),98);
__d("LSAddDeviceWithVirtualDeviceAndDecryptionKey",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Decode.nop","LSBase64Encode.nop","LSCreateAuthKeyPair.nop","LSCreateDebugToken.nop","LSCreateDerivedKeys.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignatureWithArmadilloKey.nop","LSCreateSignature_v2.nop","LSDeleteBackupOnClient","LSGetArmadilloPublicKey.nop","LSGetBlobFromString.nop","LSHandleWrongRecoveryCode","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIsValidEpochAnonId.nop","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop","LSPublicEncryptionCreateDecryptedData.nop","LSQplAnnotateInt.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop","LSSymmetricEncryptionCreateDecryptedString.nop","justknobx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(f){return d.sequence([function(c){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] Beginning execution."),a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_sproc_start"):d.resolve()},function(f){return d.filter(d.db.table(168).fetch(),function(a){return d.i64.eq(a.authorityLevel,d.i64.cast([0,80]))}).next().then(function(f,g){g=f.done;f=f.value;return g?d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_delete_client_state_start"):d.resolve()},function(a){return d.db.table(168).fetch().next().then(function(a,c){var e=a.done;a=a.value;return e?0:(c=a.item,d.storedProcedure(b("LSDeleteBackupOnClient"),c.backupId,void 0,!1,void 0,"null",!0))})},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_delete_client_state_end"):d.resolve()},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_decrypt_virtual_device_secrets_start"):d.resolve()},function(c){return e[8]=a[3].get("encrypted_ocmf_client_state"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),e[8]).then(function(a){return a=a,e[9]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[9]).then(function(a){return a=a,e[10]=a[0],a})},function(c){return d.blobs.neq(e[10],void 0)?d.resolve(e[11]=e[10]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[8]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[11]=e[41]}])},function(c){return e[12]=a[3].get("encrypted_oblivious_validation_token_blob"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),e[12]).then(function(a){return a=a,e[13]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[13]).then(function(a){return a=a,e[14]=a[0],a})},function(c){return d.blobs.neq(e[14],void 0)?d.resolve(e[15]=e[14]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[12]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[15]=e[41]}])},function(c){return e[16]=a[3].get("encrypted_epoch_anon_id"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),e[16]).then(function(a){return a=a,e[17]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[17]).then(function(a){return a=a,e[18]=a[0],a})},function(c){return d.blobs.neq(e[18],void 0)?d.resolve(e[19]=e[18]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[16]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[19]=e[41]}])},function(a){return d.blobs.neq(e[19],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSIsValidEpochAnonId.nop"),e[19]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return e[20]=e[40]}]):d.resolve(e[20]=!1)},function(c){return e[20]?e[21]=e[19]:e[21]=void 0,e[22]=a[3].get("encrypted_epoch_root_key"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),e[22]).then(function(a){return a=a,e[23]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[23]).then(function(a){return a=a,e[24]=a[0],a})},function(c){return d.blobs.neq(e[24],void 0)?d.resolve(e[25]=e[24]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[22]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[25]=e[41]}])},function(c){return e[26]=a[3].get("encrypted_mailbox_root_key_blob"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),e[26]).then(function(a){return a=a,e[27]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[27]).then(function(a){return a=a,e[28]=a[0],a})},function(c){return d.blobs.neq(e[28],void 0)?d.resolve(e[29]=e[28]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[26]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[29]=e[41]}])},function(c){return e[30]=a[3].get("encrypted_epoch_storage_private_key"),e[30]!==void 0?d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),e[30]).then(function(a){return a=a,e[40]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(c){return d.blobs.neq(e[41],void 0)?d.resolve(e[42]=e[41]):d.sequence([function(c){return d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),a[9],d.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),e[30]).then(function(a){return a=a,e[43]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[43]).then(function(a){return a=a,e[44]=a[0],a})},function(a){return e[42]=e[44]}])},function(a){return e[31]=e[42]}]):d.resolve(e[31]=void 0)},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_decrypt_virtual_device_secrets_end"):d.resolve()},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_generate_keys_start"):d.resolve()},function(a){return d.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,e[32]=a[0],e[33]=a[1],a})},function(a){return d.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,e[34]=a[0],e[35]=a[1],a})},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[32],d.blob("MA=="),e[35]).then(function(a){return a=a,e[36]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateAuthKeyPair.nop")).then(function(a){return a=a,e[37]=a[0],e[38]=a[1],a})},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[32],d.blob("MQ=="),e[38]).then(function(a){return a=a,e[39]=a[0],a})},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_generate_keys_end"):d.resolve()},function(f){return d.blobs.neq(e[11],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),e[11]).then(function(a){return a=a,e[40]=a[0],e[41]=a[1],a})},function(a){return d.blobs.neq(void 0,void 0)?d.sequence([function(a){return d.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),void 0).then(function(a){return a=a,e[46]=a[0],e[47]=a[1],a})},function(a){return a=[e[40],e[41],e[46],e[47]],e[42]=a[0],e[43]=a[1],e[44]=a[2],e[45]=a[3],a}]):d.resolve((a=[e[40],e[41],void 0,void 0],e[42]=a[0],e[43]=a[1],e[44]=a[2],e[45]=a[3],a))},function(f){return d.blobs.neq(e[21],void 0)?d.blobs.neq(e[25],void 0)?d.blobs.neq(e[15],void 0)?d.blobs.neq(e[29],void 0)?d.sequence([function(c){return a[12]!==void 0?(e[61]=a[12].get("epoch_head"),e[46]=e[61]):e[46]=void 0,e[47]=d.createArray(),d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,0])).then(function(a){return a=a,e[48]=a[0],a})},function(a){return e[48]?e[61]=(e[47].push(d.i64.cast([0,0])),e[47]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,2])).then(function(a){return a=a,e[49]=a[0],a})},function(a){return e[49]?e[61]=(e[47].push(d.i64.cast([0,2])),e[47]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,3])).then(function(a){return a=a,e[50]=a[0],a})},function(a){return e[50]?e[61]=(e[47].push(d.i64.cast([0,3])),e[47]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,4])).then(function(a){return a=a,e[51]=a[0],a})},function(a){return e[51]?e[61]=(e[47].push(d.i64.cast([0,4])),e[47]):0,e[52]="",e[53]=d.i64.of_int32(e[47].length),d.i64.gt(e[53],d.i64.cast([0,0]))?d.loopAsync(e[53],function(a){return e[61]=a,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[47],e[61]).then(function(a){return a=a,e[62]=a[0],e[63]=a[1],a})},function(a){return e[52]=[e[52],"_",d.i64.to_string(e[62])].join("")}])}):d.resolve()},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),["supported_versions_",e[52],"revision_version_",d.i64.to_string(d.i64.cast([0,1]))].join("")).then(function(a){return a=a,e[54]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[32],d.blob("Mg=="),e[54]).then(function(a){return a=a,e[55]=a[0],a})},function(a){return d.blobs.neq(e[55],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[55]).then(function(a){return a=a,e[61]=a[0],a})},function(a){return e[56]=e[61]}]):d.resolve(e[56]=void 0)},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_cleanup_state_start"):d.resolve()},function(a){return d.forEach(d.db.table(168).fetch(),function(a){return a["delete"]()})},function(a){return d.forEach(d.db.table(169).fetch(),function(a){return a["delete"]()})},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_cleanup_state_end"):d.resolve()},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_insert_optimisitc_client_state_start"):d.resolve()},function(b){return d.forEach(d.filter(d.db.table(168).fetch([[[a[1]]]]),function(b){return d.i64.eq(b.backupId,a[1])&&d.i64.lt(b.authorityLevel,d.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(b){return d.db.table(168).add({backupId:a[1],devicePublicKeyBlob:e[33],devicePrivateKeyBlob:e[32],epochStoragePublicKeyBlob:e[35],epochStoragePrivateKeyBlob:e[34],epochAuthPublicKeyBlob:e[38],epochAuthPrivateKeyBlob:e[37],mailboxRootKeyBlob:e[29],ocmfClientStateBlob:e[42],obliviousValidationTokenBlob:e[15],encryptionVersion:d.i64.cast([0,0]),revisionVersion:d.i64.cast([0,1]),authorityLevel:d.i64.cast([0,20]),backupTenancy:a[7]})},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_insert_optimisitc_client_state_end"):d.resolve()},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_insert_epoch_data_start"):d.resolve()},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_populate_epochs_table_start"):d.resolve()},function(b){return d.forEach(d.filter(d.db.table(169).fetch([[[a[2]]]]),function(b){return d.i64.eq(b.epochId,a[2])&&d.i64.lt(b.authorityLevel,d.i64.cast([0,80]))}),function(a){return a["delete"]()})},function(b){return d.db.table(169).add({epochId:a[2],authorityLevel:d.i64.cast([0,80]),backupId:a[1],epochAnonIdBlob:e[21],epochRootKeyBlob:e[25],epochStatus:d.i64.cast([0,1]),epochHead:e[46]})},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_populate_epochs_table_end"):d.resolve()},function(c){return e[57]=a[5].keys(),e[58]=d.i64.of_int32(e[57].length),a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateInt.nop"),d.i64.cast([0,1021646192]),a[8],"num_epochs",e[58]):d.resolve()},function(f){return d.i64.eq(e[58],d.i64.cast([0,1]))?d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_epoch_derivation_skipped"):d.resolve()},function(c){return e[61]=a[5].has(d.i64.to_string(a[2])),e[61]?d.resolve(0):(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] sync_epochs does not contain base epoch"),e[63]="sync_epochs does not contain base epoch",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",e[63]].join("")),e[62]=d.createArray(),void 0!==void 0?e[64]=(e[62].push(void 0),e[62]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e[63],e[62],d.i64.cast([0,3])))}]):d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_epoch_derivation_start"):d.resolve()},function(a){return function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] Triggering epoch derivation."),e[61]=c("justknobx")._("1310"),void 0!==void 0?e[61]?d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,2866]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[62]=a[0],a})},function(a){return e[62]?e[63]=!0:e[63]=!1,e[63]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[65]="LSDataTraceMciTraceLog native op not supported",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",e[65]].join("")),e[64]=d.createArray(),void 0!==void 0?e[66]=(e[64].push(void 0),e[64]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",e[65],e[64],d.i64.cast([0,3]))):d.resolve()}]):d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,2867]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[62]=a[0],a})},function(a){return e[62]?e[63]=!0:e[63]=!1,e[63]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[65]="LSDataTraceMciTraceLog native op not supported",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",e[65]].join("")),e[64]=d.createArray(),void 0!==void 0?e[66]=(e[64].push(void 0),e[64]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",e[65],e[64],d.i64.cast([0,3]))):d.resolve()}]):d.resolve()},function(c){return e[61]===!1?function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] Epoch rotation is disabled for the user but received more than one epoch."):0,d.blobs.neq(e[31],void 0)?d.sequence([function(a){return e[65]="Starting epoch derivation at base epoch of anon id (base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[21]).then(function(a){return a=a,e[62]=a[0],a})},function(a){return e[66]=e[62]==null?"":e[62],e[63]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[63],e[65],e[63],e[66]].join("")),d.resolve()},function(c){return e[64]=a[5].get(d.i64.to_string(a[2])),e[64]!==void 0?d.sequence([function(b){return e[67]=e[64].get("minos_epoch"),e[67]!==void 0?(e[79]=e[67].get("epoch_head"),e[68]=e[79]):e[68]=void 0,e[69]=e[64].get("is_active_epoch"),e[69]?e[70]=d.i64.cast([0,1]):e[70]=d.i64.cast([0,2]),d.forEach(d.db.table(169).fetch([[[a[2]]]]),function(a){var b=a.update;a.item;return b({authorityLevel:d.i64.cast([0,80]),epochStatus:e[70],epochHead:e[68]})})},function(c){return e[71]=new d.Map(),e[71].set("epoch_id",a[2]),e[71].set("authority_level",d.i64.cast([0,80])),e[71].set("backup_id",a[1]),e[71].set("epoch_anon_id_blob",e[21]),e[71].set("epoch_root_key_blob",e[25]),e[71].set("epoch_status",d.i64.cast([0,1])),e[71].set("epoch_head",e[46]),e[72]=e[71],e[73]=a[5].keys(),e[74]=d.i64.of_int32(e[73].length),d.i64.gt(e[74],d.i64.cast([0,0]))?d.loopAsync(e[74],function(c){return e[79]=c,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[73],e[79]).then(function(a){return a=a,e[80]=a[0],e[81]=a[1],a})},function(c){return e[82]=e[72].get("epoch_id"),e[83]=e[72].get("backup_id"),e[84]=e[72].get("epoch_anon_id_blob"),e[85]=e[72].get("epoch_root_key_blob"),e[86]=e[72].get("epoch_status"),e[87]=e[72].get("authority_level"),e[88]=e[72].get("epoch_head"),e[89]=a[5].get(d.i64.to_string(e[82])),e[89]!==void 0?d.sequence([function(c){return e[98]=e[89].get("next_epoch_id"),d.i64.neq(e[98],void 0)?d.sequence([function(c){return e[106]=a[5].get(d.i64.to_string(e[98])),e[106]!==void 0?d.sequence([function(a){return e[114]=e[106].get("backup_id"),e[115]=e[106].get("is_active_epoch"),e[115]?e[116]=d.i64.cast([0,1]):e[116]=d.i64.cast([0,2]),e[117]=e[106].get("epoch_anon_id"),e[118]=e[106].get("minos_epoch"),e[118]!==void 0?(e[137]=e[118].get("epoch_head"),e[119]=e[137]):e[119]=void 0,e[120]=d.createArray(),e[137]=(e[120].push(d.i64.cast([0,32])),e[120]),e[137]=(e[120].push(d.i64.cast([0,32])),e[120]),e[121]="_",d.nativeOperation(b("LSGetBlobFromString.nop"),["epoch_chaining",e[121],d.blobs.to_string(e[84]),e[121],d.i64.to_string(e[82])].join("")).then(function(a){return a=a,e[122]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),e[122],void 0,e[85],e[120]).then(function(a){return a=a,e[123]=a[0],a})},function(a){return e[123]?e[124]=!1:e[124]=!0,e[124]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] Failed to generate epoch_chaining_key and epoch_distribution_pre_shared_key."),e[138]="Failed to generate epoch_chaining_key and epoch_distribution_pre_shared_key.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[138]].join("")),e[137]=d.createArray(),void 0!==void 0?e[141]=(e[137].push(void 0),e[137]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[138],e[137],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[139]=a[0],a})},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[140]=a[0],a})},function(a){return a=[e[139],e[140]],e[125]=a[0],e[126]=a[1],a}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[123],d.i64.cast([0,0])).then(function(a){return a=a,e[137]=a[0],e[138]=a[1],a})},function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[123],d.i64.cast([0,1])).then(function(a){return a=a,e[139]=a[0],e[140]=a[1],a})},function(a){return a=[e[137],e[139]],e[125]=a[0],e[126]=a[1],a}])},function(c){return e[127]=e[106].get("encrypted_epoch_key"),d.blobs.neq(e[127],void 0)?d.sequence([function(c){return e[137]=e[106].get("epoch_auth_public_key"),e[138]=e[106].get("epoch_anon_id"),d.nativeOperation(b("LSPublicEncryptionCreateDecryptedData.nop"),a[6],e[31],e[137],e[126],d.blobs.of_string(["epoch_","_",d.blobs.to_string(e[138])].join("")),e[127]).then(function(a){return a=a,e[139]=a[0],a})},function(a){return d.blobs.neq(e[139],void 0)?d.resolve(e[140]=e[139]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] Couldn't decrypt epoch key. Returning null entropy"),e[142]="Couldn't decrypt epoch key. Returning null entropy",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[142]].join("")),e[141]=d.createArray(),void 0!==void 0?e[143]=(e[141].push(void 0),e[141]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[142],e[141],d.i64.cast([0,3]))},function(a){return e[140]=void 0}])},function(a){return e[128]=e[140]}]):d.sequence([function(a){return e[140]="encrypted_epoch_key is null. Can't generate epoch entropy. epoch_anon_id(base64) = ",e[137]=e[106].get("epoch_anon_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[137]).then(function(a){return a=a,e[138]=a[0],a})},function(a){return e[141]=e[138]==null?"":e[138],e[139]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[139],e[140],e[139],e[141]].join("")),e[142]=d.createArray(),void 0!==void 0?e[143]=(e[142].push(void 0),e[142]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[140],",",e[141]].join(""),e[142],d.i64.cast([0,3]))},function(a){return e[128]=void 0}])},function(a){return d.blobs.neq(e[128],void 0)?d.sequence([function(a){return e[137]=d.createArray(),e[142]=(e[137].push(d.i64.cast([0,32])),e[137]),d.nativeOperation(b("LSGetBlobFromString.nop"),"epoch_root_key").then(function(a){return a=a,e[138]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),e[138],e[125],e[128],e[137]).then(function(a){return a=a,e[139]=a[0],a})},function(a){return e[139]?e[140]=!1:e[140]=!0,e[140]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] Unable to generate epoch root key."),e[143]="Unable to generate epoch root key.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[143]].join("")),e[142]=d.createArray(),void 0!==void 0?e[145]=(e[142].push(void 0),e[142]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[143],e[142],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[144]=a[0],a})},function(a){return e[141]=e[144]}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[139],d.i64.cast([0,0])).then(function(a){return a=a,e[142]=a[0],e[143]=a[1],a})},function(a){return e[141]=e[142]}])},function(a){return e[129]=e[141]}]):d.sequence([function(a){return e[140]="epoch entropy is null. Can't generate epoch root key. epoch_anon_id(base64) = ",e[137]=e[106].get("epoch_anon_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[137]).then(function(a){return a=a,e[138]=a[0],a})},function(a){return e[141]=e[138]==null?"":e[138],e[139]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[139],e[140],e[139],e[141]].join("")),e[142]=d.createArray(),void 0!==void 0?e[143]=(e[142].push(void 0),e[142]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[140],",",e[141]].join(""),e[142],d.i64.cast([0,3]))},function(a){return e[129]=void 0}])},function(a){return d.blobs.neq(e[129],void 0)?d.sequence([function(a){return d.filter(d.db.table(169).fetch([[[e[98]]]]),function(a){return d.i64.eq(a.epochId,e[98])&&d.i64.gt(a.authorityLevel,d.i64.cast([0,80]))}).next().then(function(a){var b=a.done;a.value;return b?d.db.table(169).put({epochId:e[98],backupId:e[114],epochAnonIdBlob:e[117],epochRootKeyBlob:e[129],epochStatus:e[116],authorityLevel:d.i64.cast([0,80]),epochHead:e[119]}):0})},function(a){return a=[e[98],e[114],e[117],e[129],e[116],e[119],d.i64.cast([0,80])],e[130]=a[0],e[131]=a[1],e[132]=a[2],e[133]=a[3],e[134]=a[4],e[135]=a[5],e[136]=a[6],a}]):d.sequence([function(a){return e[140]="Epoch root key is null. Can't write the epoch to the table. epoch_anon_id(base64) = ",e[137]=e[106].get("epoch_anon_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[137]).then(function(a){return a=a,e[138]=a[0],a})},function(a){return e[141]=e[138]==null?"":e[138],e[139]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[139],e[140],e[139],e[141]].join("")),e[142]=d.createArray(),void 0!==void 0?e[143]=(e[142].push(void 0),e[142]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[140],",",e[141]].join(""),e[142],d.i64.cast([0,3]))},function(a){return a=[e[82],e[83],e[84],e[85],e[86],e[88],e[87]],e[130]=a[0],e[131]=a[1],e[132]=a[2],e[133]=a[3],e[134]=a[4],e[135]=a[5],e[136]=a[6],a}])},function(a){return a=[e[130],e[131],e[132],e[133],e[134],e[135],e[136]],e[107]=a[0],e[108]=a[1],e[109]=a[2],e[110]=a[3],e[111]=a[4],e[112]=a[5],e[113]=a[6],a}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Unexpected error! New epoch is null even though we have a new_epoch_id value"),e[115]="Unexpected error! New epoch is null even though we have a new_epoch_id value",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ","",e[115]].join("")),e[114]=d.createArray(),void 0!==void 0?e[116]=(e[114].push(void 0),e[114]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",e[115],e[114],d.i64.cast([0,3]))},function(a){return a=[e[82],e[83],e[84],e[85],e[86],e[88],e[87]],e[107]=a[0],e[108]=a[1],e[109]=a[2],e[110]=a[3],e[111]=a[4],e[112]=a[5],e[113]=a[6],a}])},function(a){return a=[e[107],e[108],e[109],e[110],e[111],e[112],e[113]],e[99]=a[0],e[100]=a[1],e[101]=a[2],e[102]=a[3],e[103]=a[4],e[104]=a[5],e[105]=a[6],a}]):d.sequence([function(a){return e[108]="New epoch is null. This is expected if epoch_id is the root or last epoch. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[84]).then(function(a){return a=a,e[106]=a[0],a})},function(a){return e[109]=e[106]==null?"":e[106],e[110]=" , is_forward = ",e[111]="1",e[107]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[107],e[108],e[107],e[109],e[107],e[110],e[107],e[111]].join("")),d.resolve()},function(a){return a=[e[82],e[83],e[84],e[85],e[86],e[88],e[87]],e[99]=a[0],e[100]=a[1],e[101]=a[2],e[102]=a[3],e[103]=a[4],e[104]=a[5],e[105]=a[6],a}])},function(a){return a=[e[99],e[100],e[101],e[102],e[103],e[104],e[105]],e[90]=a[0],e[91]=a[1],e[92]=a[2],e[93]=a[3],e[94]=a[4],e[95]=a[5],e[96]=a[6],a}]):d.sequence([function(a){return e[100]="Unexpected error! server epoch is null even though we have epoch_id. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[84]).then(function(a){return a=a,e[98]=a[0],a})},function(a){return e[101]=e[98]==null?"":e[98],e[99]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[99],e[100],e[99],e[101]].join("")),e[102]=d.createArray(),void 0!==void 0?e[103]=(e[102].push(void 0),e[102]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[100],",",e[101]].join(""),e[102],d.i64.cast([0,3]))},function(a){return a=[e[82],e[83],e[84],e[85],e[86],e[88],e[87]],e[90]=a[0],e[91]=a[1],e[92]=a[2],e[93]=a[3],e[94]=a[4],e[95]=a[5],e[96]=a[6],a}])},function(a){return e[97]=new d.Map(),e[97].set("epoch_id",e[90]),e[97].set("backup_id",e[91]),e[97].set("epoch_anon_id_blob",e[92]),e[97].set("epoch_root_key_blob",e[93]),e[97].set("epoch_status",e[94]),e[97].set("epoch_head",e[95]),e[97].set("authority_level",e[96]),e[72]=e[97]}])}):d.resolve()},function(a){return d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,1438]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[79]=a[0],a})},function(a){return e[79]?e[80]=!0:e[80]=!1,e[80]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[82]="LSDataTraceMciTraceLog native op not supported",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",e[82]].join("")),e[81]=d.createArray(),void 0!==void 0?e[83]=(e[81].push(void 0),e[81]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",e[82],e[81],d.i64.cast([0,3]))):d.resolve()}])},function(c){return e[75]=new d.Map(),e[75].set("epoch_id",a[2]),e[75].set("authority_level",d.i64.cast([0,80])),e[75].set("backup_id",a[1]),e[75].set("epoch_anon_id_blob",e[21]),e[75].set("epoch_root_key_blob",e[25]),e[75].set("epoch_status",d.i64.cast([0,1])),e[75].set("epoch_head",e[46]),e[76]=e[75],e[77]=a[5].keys(),e[78]=d.i64.of_int32(e[77].length),d.i64.gt(e[78],d.i64.cast([0,0]))?d.loopAsync(e[78],function(c){return e[79]=c,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[77],e[79]).then(function(a){return a=a,e[80]=a[0],e[81]=a[1],a})},function(c){return e[82]=e[76].get("epoch_id"),e[83]=e[76].get("backup_id"),e[84]=e[76].get("epoch_anon_id_blob"),e[85]=e[76].get("epoch_root_key_blob"),e[86]=e[76].get("epoch_status"),e[87]=e[76].get("authority_level"),e[88]=e[76].get("epoch_head"),e[89]=a[5].get(d.i64.to_string(e[82])),e[89]!==void 0?d.sequence([function(c){return e[98]=e[89].get("prev_epoch_id"),d.i64.neq(e[98],void 0)?d.sequence([function(c){return e[106]=a[5].get(d.i64.to_string(e[98])),e[106]!==void 0?d.sequence([function(a){return e[114]=e[106].get("backup_id"),e[115]=e[106].get("is_active_epoch"),e[115]?e[116]=d.i64.cast([0,1]):e[116]=d.i64.cast([0,2]),e[117]=e[89].get("epoch_data_v2"),e[117]!==void 0?d.sequence([function(a){return e[125]=d.createArray(),e[144]=(e[125].push(d.i64.cast([0,32])),e[125]),d.nativeOperation(b("LSBase64Encode.nop"),e[84]).then(function(a){return a=a,e[126]=a[0],a})},function(a){return e[126]!==void 0?d.sequence([function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blobs.of_string(["epoch_data_storage","_",e[126]].join("")),void 0,e[85],e[125]).then(function(a){return a=a,e[144]=a[0],a})},function(a){return e[144]?e[145]=!1:e[145]=!0,e[145]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),e[148]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[148]].join("")),e[147]=d.createArray(),void 0!==void 0?e[150]=(e[147].push(void 0),e[147]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[148],e[147],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[149]=a[0],a})},function(a){return e[146]=e[149]}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[144],d.i64.cast([0,0])).then(function(a){return a=a,e[147]=a[0],e[148]=a[1],a})},function(a){return e[146]=e[147]}])},function(a){return e[127]=e[146]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),e[145]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[145]].join("")),e[144]=d.createArray(),void 0!==void 0?e[147]=(e[144].push(void 0),e[144]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[145],e[144],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[146]=a[0],a})},function(a){return e[127]=e[146]}])},function(a){return e[128]=e[117].get("epoch_anon_id"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),e[127],d.blob("ZXBvY2hfZGF0YV9tZXRhZGF0YQ=="),e[128]).then(function(a){return a=a,e[129]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[129]).then(function(a){return a=a,e[130]=a[0],a})},function(a){return d.blobs.neq(e[130],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSIsValidEpochAnonId.nop"),e[130]).then(function(a){return a=a,e[144]=a[0],a})},function(a){return e[131]=e[144]}]):d.resolve(e[131]=!1)},function(a){return e[131]?e[132]=e[130]:e[132]=void 0,e[133]=e[117].get("epoch_root_key"),d.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),e[127],d.blob("ZXBvY2hfZGF0YV9tZXRhZGF0YQ=="),e[133]).then(function(a){return a=a,e[134]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Decode.nop"),e[134]).then(function(a){return a=a,e[135]=a[0],a})},function(a){return d.blobs.neq(e[132],void 0)?d.sequence([function(a){return d.blobs.neq(e[135],void 0)?d.resolve((e[145]=new d.Map(),e[145].set("epoch_anon_id",e[132]),e[145].set("epoch_root_key",e[135]),e[144]=e[145])):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Error while decrypting epoch_root_key. Returning null"),e[146]="Error while decrypting epoch_root_key. Returning null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ","",e[146]].join("")),e[145]=d.createArray(),void 0!==void 0?e[147]=(e[145].push(void 0),e[145]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",e[146],e[145],d.i64.cast([0,3]))},function(a){return e[144]=void 0}])},function(a){return e[136]=e[144]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Error while decrypting epoch_anon_id. Returning null"),e[145]="Error while decrypting epoch_anon_id. Returning null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ","",e[145]].join("")),e[144]=d.createArray(),void 0!==void 0?e[146]=(e[144].push(void 0),e[144]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",e[145],e[144],d.i64.cast([0,3]))},function(a){return e[136]=void 0}])},function(a){return e[136]!==void 0?d.sequence([function(a){return e[144]=e[136].get("epoch_anon_id"),e[145]=e[136].get("epoch_root_key"),e[146]=e[106].get("minos_epoch"),e[146]!==void 0?(e[148]=e[146].get("epoch_head"),e[147]=e[148]):e[147]=void 0,d.filter(d.db.table(169).fetch([[[e[98]]]]),function(a){return d.i64.eq(a.epochId,e[98])&&d.i64.gt(a.authorityLevel,d.i64.cast([0,80]))}).next().then(function(a){var b=a.done;a.value;return b?d.db.table(169).put({epochId:e[98],backupId:e[114],epochAnonIdBlob:e[144],epochRootKeyBlob:e[145],epochStatus:e[116],authorityLevel:d.i64.cast([0,80]),epochHead:e[147]}):0})},function(a){return a=[e[98],e[114],e[144],e[145],e[116],e[147],d.i64.cast([0,80])],e[137]=a[0],e[138]=a[1],e[139]=a[2],e[140]=a[3],e[141]=a[4],e[142]=a[5],e[143]=a[6],a}]):d.sequence([function(a){return e[146]="Error while decrypting epoch data of epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[84]).then(function(a){return a=a,e[144]=a[0],a})},function(a){return e[147]=e[144]==null?"":e[144],e[145]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[145],e[146],e[145],e[147]].join("")),e[148]=d.createArray(),void 0!==void 0?e[149]=(e[148].push(void 0),e[148]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[146],",",e[147]].join(""),e[148],d.i64.cast([0,3]))},function(a){return a=[e[82],e[83],e[84],e[85],e[86],e[88],e[87]],e[137]=a[0],e[138]=a[1],e[139]=a[2],e[140]=a[3],e[141]=a[4],e[142]=a[5],e[143]=a[6],a}])},function(a){return a=[e[137],e[138],e[139],e[140],e[141],e[142],e[143]],e[118]=a[0],e[119]=a[1],e[120]=a[2],e[121]=a[3],e[122]=a[4],e[123]=a[5],e[124]=a[6],a}]):d.sequence([function(a){return e[127]="Error while reading epoch_data_v2. This is expected if this is the root epoch. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[84]).then(function(a){return a=a,e[125]=a[0],a})},function(a){return e[128]=e[125]==null?"":e[125],e[126]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[126],e[127],e[126],e[128]].join("")),d.resolve()},function(a){return a=[e[82],e[83],e[84],e[85],e[86],e[88],e[87]],e[118]=a[0],e[119]=a[1],e[120]=a[2],e[121]=a[3],e[122]=a[4],e[123]=a[5],e[124]=a[6],a}])},function(a){return a=[e[118],e[119],e[120],e[121],e[122],e[123],e[124]],e[107]=a[0],e[108]=a[1],e[109]=a[2],e[110]=a[3],e[111]=a[4],e[112]=a[5],e[113]=a[6],a}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Unexpected error! New epoch is null even though we have a new_epoch_id value"),e[115]="Unexpected error! New epoch is null even though we have a new_epoch_id value",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ","",e[115]].join("")),e[114]=d.createArray(),void 0!==void 0?e[116]=(e[114].push(void 0),e[114]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",e[115],e[114],d.i64.cast([0,3]))},function(a){return a=[e[82],e[83],e[84],e[85],e[86],e[88],e[87]],e[107]=a[0],e[108]=a[1],e[109]=a[2],e[110]=a[3],e[111]=a[4],e[112]=a[5],e[113]=a[6],a}])},function(a){return a=[e[107],e[108],e[109],e[110],e[111],e[112],e[113]],e[99]=a[0],e[100]=a[1],e[101]=a[2],e[102]=a[3],e[103]=a[4],e[104]=a[5],e[105]=a[6],a}]):d.sequence([function(a){return e[108]="New epoch is null. This is expected if epoch_id is the root or last epoch. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[84]).then(function(a){return a=a,e[106]=a[0],a})},function(a){return e[109]=e[106]==null?"":e[106],e[110]=" , is_forward = ",e[111]="0",e[107]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[107],e[108],e[107],e[109],e[107],e[110],e[107],e[111]].join("")),d.resolve()},function(a){return a=[e[82],e[83],e[84],e[85],e[86],e[88],e[87]],e[99]=a[0],e[100]=a[1],e[101]=a[2],e[102]=a[3],e[103]=a[4],e[104]=a[5],e[105]=a[6],a}])},function(a){return a=[e[99],e[100],e[101],e[102],e[103],e[104],e[105]],e[90]=a[0],e[91]=a[1],e[92]=a[2],e[93]=a[3],e[94]=a[4],e[95]=a[5],e[96]=a[6],a}]):d.sequence([function(a){return e[100]="Unexpected error! server epoch is null even though we have epoch_id. epoch_anon_id(base64) = ",d.nativeOperation(b("LSBase64Encode.nop"),e[84]).then(function(a){return a=a,e[98]=a[0],a})},function(a){return e[101]=e[98]==null?"":e[98],e[99]="",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochDerivationUtils] ",e[99],e[100],e[99],e[101]].join("")),e[102]=d.createArray(),void 0!==void 0?e[103]=(e[102].push(void 0),e[102]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[e[100],",",e[101]].join(""),e[102],d.i64.cast([0,3]))},function(a){return a=[e[82],e[83],e[84],e[85],e[86],e[88],e[87]],e[90]=a[0],e[91]=a[1],e[92]=a[2],e[93]=a[3],e[94]=a[4],e[95]=a[5],e[96]=a[6],a}])},function(a){return e[97]=new d.Map(),e[97].set("epoch_id",e[90]),e[97].set("backup_id",e[91]),e[97].set("epoch_anon_id_blob",e[92]),e[97].set("epoch_root_key_blob",e[93]),e[97].set("epoch_status",e[94]),e[97].set("epoch_head",e[95]),e[97].set("authority_level",e[96]),e[76]=e[97]}])}):d.resolve()},function(a){return d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,1439]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[79]=a[0],a})},function(a){return e[79]?e[80]=!0:e[80]=!1,e[80]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[82]="LSDataTraceMciTraceLog native op not supported",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",e[82]].join("")),e[81]=d.createArray(),void 0!==void 0?e[83]=(e[81].push(void 0),e[81]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",e[82],e[81],d.i64.cast([0,3]))):d.resolve()}])}]):(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochDerivationUtils] Unexpected Error. A base epoch exists on client but not found on server"),e[67]=d.createArray(),void 0!==void 0?e[68]=(e[67].push(void 0),e[67]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils","Unexpected Error. A base epoch exists on client but not found on server",e[67],d.i64.cast([0,3])))}]):d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: epoch storage private key is null"):d.resolve()},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch storage private key is null"),e[63]="epoch storage private key is null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",e[63]].join("")),e[62]=d.createArray(),void 0!==void 0?e[64]=(e[62].push(void 0),e[62]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e[63],e[62],d.i64.cast([0,3]))}])},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_epoch_derivation_end"):d.resolve()}])},function(c){return d.db.table(169).fetch([[[a[4]]]]).next().then(function(c,f){var g=c.done;c=c.value;return g?d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: No epochs keys found."):d.resolve()},function(a){return function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] No epochs keys found."),e[59]=void 0}]):(f=c.item,e[61]=new d.Map(),e[61].set("epoch_root_key",f.epochRootKeyBlob),e[61].set("epoch_anon_id",f.epochAnonIdBlob),e[61].set("epoch_id",a[4]),e[61].set("epoch_head",f.epochHead),e[59]=e[61])})},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_insert_epoch_data_end"):d.resolve()},function(c){return e[59]!==void 0?d.sequence([function(a){return e[61]=e[59].get("epoch_anon_id"),e[62]=e[59].get("epoch_root_key"),e[63]=d.createArray(),e[69]=(e[63].push(d.i64.cast([0,32])),e[63]),d.nativeOperation(b("LSBase64Encode.nop"),e[61]).then(function(a){return a=a,e[64]=a[0],a})},function(a){return e[64]!==void 0?d.sequence([function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blobs.of_string(["epoch_devices","_",e[64]].join("")),void 0,e[62],e[63]).then(function(a){return a=a,e[69]=a[0],a})},function(a){return e[69]?e[70]=!1:e[70]=!0,e[70]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),e[73]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[73]].join("")),e[72]=d.createArray(),void 0!==void 0?e[75]=(e[72].push(void 0),e[72]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[73],e[72],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[74]=a[0],a})},function(a){return e[71]=e[74]}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[69],d.i64.cast([0,0])).then(function(a){return a=a,e[72]=a[0],e[73]=a[1],a})},function(a){return e[71]=e[72]}])},function(a){return e[65]=e[71]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),e[70]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[70]].join("")),e[69]=d.createArray(),void 0!==void 0?e[72]=(e[69].push(void 0),e[69]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[70],e[69],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[71]=a[0],a})},function(a){return e[65]=e[71]}])},function(a){return d.nativeOperation(b("LSHmac_v2.nop"),e[65],e[33]).then(function(a){return a=a,e[66]=a[0],a})},function(a){return e[67]=e[59].get("epoch_root_key"),d.blobs.neq(e[67],void 0)?d.sequence([function(a){return e[69]=d.createArray(),e[75]=(e[69].push(d.i64.cast([0,18])),e[69]),d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,e[67],e[69]).then(function(a){return a=a,e[70]=a[0],a})},function(a){return e[70]!==void 0?d.sequence([function(a){return e[75]=d.i64.of_int32(e[70].length),d.i64.ge(e[75],d.i64.cast([0,1]))?d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[70],d.i64.cast([0,0])).then(function(a){return a=a,e[77]=a[0],e[78]=a[1],a})},function(a){return e[76]=e[77]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),e[78]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",e[78]].join("")),e[77]=d.createArray(),void 0!==void 0?e[79]=(e[77].push(void 0),e[77]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",e[78],e[77],d.i64.cast([0,3]))},function(a){return e[76]=void 0}])},function(a){return e[71]=e[76]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),e[76]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",e[76]].join("")),e[75]=d.createArray(),void 0!==void 0?e[77]=(e[75].push(void 0),e[75]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",e[76],e[75],d.i64.cast([0,3]))},function(a){return e[71]=void 0}])},function(a){return d.blobs.neq(e[71],void 0)?e[72]=!0:e[72]=!1,e[72]?0:(function(a){d.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),d["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d.nativeOperation(b("LSBase64Encode.nop"),e[71]).then(function(a){return a=a,e[73]=a[0],a})},function(a){return e[73]!==void 0?e[74]=e[73]:e[74]="encodingfailed",e[68]=e[74]}]):d.resolve(e[68]="null")},function(c){return d.blobs.neq(e[66],void 0)?d.sequence([function(a){return e[69]=e[59].get("epoch_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[33]).then(function(a){return a=a,e[70]=a[0],a})},function(a){return e[88]=e[70]==null?"":e[70],d.nativeOperation(b("LSBase64Encode.nop"),e[66]).then(function(a){return a=a,e[71]=a[0],a})},function(a){return e[87]=e[71]==null?"":e[71],d.nativeOperation(b("LSBase64Encode.nop"),e[35]).then(function(a){return a=a,e[72]=a[0],a})},function(a){return e[89]=e[72]==null?"":e[72],d.nativeOperation(b("LSBase64Encode.nop"),e[36]==null?d.blob("bnVsbA=="):e[36]).then(function(a){return a=a,e[73]=a[0],a})},function(a){return e[90]=e[73]==null?"":e[73],d.nativeOperation(b("LSBase64Encode.nop"),e[38]).then(function(a){return a=a,e[74]=a[0],a})},function(a){return e[91]=e[74]==null?"":e[74],d.nativeOperation(b("LSBase64Encode.nop"),e[39]==null?d.blob("bnVsbA=="):e[39]).then(function(a){return a=a,e[75]=a[0],a})},function(a){return e[92]=e[75]==null?"":e[75],d.nativeOperation(b("LSBase64Encode.nop"),e[43]).then(function(a){return a=a,e[76]=a[0],a})},function(c){return e[93]=e[76]==null?"":e[76],d.nativeOperation(b("LSBase64Encode.nop"),a[10]).then(function(a){return a=a,e[77]=a[0],a})},function(a){return e[94]=e[77]==null?"":e[77],d.blobs.neq(e[29],void 0)?d.sequence([function(a){return e[95]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[29],"private_key",e[32],d.i64.cast([0,1]),e[95]).then(function(a){return a=a,e[96]=a[0],a})},function(a){return d.blobs.neq(e[96],void 0)?e[97]=e[96]:e[97]=void 0,e[78]=e[97]}]):d.resolve(e[78]=void 0)},function(a){return d.blobs.neq(e[78],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[78]).then(function(a){return a=a,e[95]=a[0],a})},function(a){return e[79]=e[95]}]):d.resolve(e[79]=void 0)},function(a){return d.blobs.neq(e[29],void 0)?d.sequence([function(a){return e[95]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[29],"ocmf_client_state",e[42],d.i64.cast([0,1]),e[95]).then(function(a){return a=a,e[96]=a[0],a})},function(a){return d.blobs.neq(e[96],void 0)?e[97]=e[96]:e[97]=void 0,e[80]=e[97]}]):d.resolve(e[80]=void 0)},function(a){return d.blobs.neq(e[80],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[80]).then(function(a){return a=a,e[95]=a[0],a})},function(a){return e[81]=e[95]}]):d.resolve(e[81]=void 0)},function(a){return d.blobs.neq(e[29],void 0)?d.sequence([function(a){return e[95]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[29],"epoch_storage_private_key",e[34],d.i64.cast([0,1]),e[95]).then(function(a){return a=a,e[96]=a[0],a})},function(a){return d.blobs.neq(e[96],void 0)?e[97]=e[96]:e[97]=void 0,e[82]=e[97]}]):d.resolve(e[82]=void 0)},function(a){return d.blobs.neq(e[82],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[82]).then(function(a){return a=a,e[95]=a[0],a})},function(a){return e[83]=e[95]}]):d.resolve(e[83]=void 0)},function(c){return e[84]=new d.Map(),e[84].set("supported_encryption_versions",e[47]),e[84].set("client_version",d.i64.cast([0,1])),e[84].set("version_sig",e[56]==null?"":e[56]),a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_issue_add_device_task_start"):d.resolve()},function(c){return d.i64.eq(a[7],d.i64.cast([0,2]))?d.resolve(e[85]=void 0):d.sequence([function(a){return d.nativeOperation(b("LSGetArmadilloPublicKey.nop")).then(function(a){return a=a,e[95]=a[0],a})},function(a){return e[85]=e[95]}])},function(a){return d.blobs.neq(e[85],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSCreateSignatureWithArmadilloKey.nop"),e[33]).then(function(a){return a=a,e[95]=a[0],a})},function(a){return d.blobs.neq(e[95],void 0)?d.resolve(e[96]=e[95]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create labyrinth signature"),e[101]="Failed to create labyrinth signature",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",e[101]].join("")),e[100]=d.createArray(),void 0!==void 0?e[102]=(e[100].push(void 0),e[100]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",e[101],e[100],d.i64.cast([0,3]))},function(a){return e[96]=void 0}])},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[32],d.blob("Mw=="),e[85]).then(function(a){return a=a,e[97]=a[0],a})},function(a){return d.blobs.neq(e[97],void 0)?d.resolve(e[98]=e[97]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create armadillo signature"),e[101]="Failed to create armadillo signature",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",e[101]].join("")),e[100]=d.createArray(),void 0!==void 0?e[102]=(e[100].push(void 0),e[100]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",e[101],e[100],d.i64.cast([0,3]))},function(a){return e[98]=void 0}])},function(a){return d.blobs.neq(e[98],void 0)?(d.blobs.neq(e[96],void 0)?(e[101]=new d.Map(),e[101].set("armadillo_public_key",e[85]),e[101].set("armadillo_key_signature",e[98]),e[101].set("labyrinth_key_signature",e[96]),e[100]=e[101]):e[100]=void 0,e[99]=e[100]):e[99]=void 0,e[86]=e[99]}]):d.resolve(e[86]=void 0)},function(c){return e[86]!==void 0?d.sequence([function(a){return e[95]=e[86].get("armadillo_public_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[95]).then(function(a){return a=a,e[96]=a[0],a})},function(a){return e[97]=e[86].get("armadillo_key_signature"),d.nativeOperation(b("LSBase64Encode.nop"),e[97]).then(function(a){return a=a,e[98]=a[0],a})},function(a){return e[99]=e[86].get("labyrinth_key_signature"),d.nativeOperation(b("LSBase64Encode.nop"),e[99]).then(function(a){return a=a,e[100]=a[0],a})},function(c){return e[105]=d.i64.cast([0,1e3]),e[101]=e[105],e[102]=new d.Map(),e[102].set("backup_id",a[1]),e[102].set("device_epoch_hmac",e[87]),e[102].set("epoch_root_key_fingerprint",e[68]),e[102].set("device_public_key",e[88]),e[102].set("epoch_storage_pubkey",e[89]),e[102].set("epoch_storage_pubkey_sig",e[90]),e[102].set("epoch_auth_pubkey",e[91]),e[102].set("epoch_auth_pubkey_sig",e[92]),e[102].set("ocmf_rotation_token",e[93]),e[102].set("virtual_device_id",e[94]),e[102].set("device_registration_id",a[11]),e[102].set("base_epoch_id",e[69]),e[102].set("encryption_version_data",e[84]),e[102].set("private_key_debug_token",e[79]),e[102].set("ocmf_client_state_debug_token",e[81]),e[102].set("epoch_storage_pvtkey_debug_token",e[83]),e[102].set("trace_id",a[8]),e[102].set("occam_only_eligible",!0),e[102].set("armadillo_public_key",e[96]==null?"":e[96]),e[102].set("armadillo_key_signature",e[98]==null?"":e[98]),e[102].set("labyrinth_key_signature",e[100]==null?"":e[100]),e[103]=d.toJSON(e[102]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50006]),e[103],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,e[101]).then(function(a){return a=a,e[104]=a[0],a})}]):(function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] failed to get armadillo key and device signatures"),e[99]=d.i64.cast([0,1e3]),e[95]=e[99],e[96]=new d.Map(),e[96].set("backup_id",a[1]),e[96].set("device_epoch_hmac",e[87]),e[96].set("epoch_root_key_fingerprint",e[68]),e[96].set("device_public_key",e[88]),e[96].set("epoch_storage_pubkey",e[89]),e[96].set("epoch_storage_pubkey_sig",e[90]),e[96].set("epoch_auth_pubkey",e[91]),e[96].set("epoch_auth_pubkey_sig",e[92]),e[96].set("ocmf_rotation_token",e[93]),e[96].set("virtual_device_id",e[94]),e[96].set("device_registration_id",a[11]),e[96].set("base_epoch_id",e[69]),e[96].set("encryption_version_data",e[84]),e[96].set("private_key_debug_token",e[79]),e[96].set("ocmf_client_state_debug_token",e[81]),e[96].set("epoch_storage_pvtkey_debug_token",e[83]),e[96].set("trace_id",a[8]),e[96].set("occam_only_eligible",!0),e[97]=d.toJSON(e[96]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50006]),e[97],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,e[95]).then(function(a){return a=a,e[98]=a[0],a}))},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_issue_add_device_task_end"):d.resolve()}]):d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: $device_epoch_hmac found to be null"):d.resolve()},function(a){return d.db.table(178).put({pk:d.i64.cast([0,1]),recoveryCodeStatus:d.i64.cast([0,4])})},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $device_epoch_hmac found to be null"),e[70]="$device_epoch_hmac found to be null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",e[70]].join("")),e[69]=d.createArray(),void 0!==void 0?e[71]=(e[69].push(void 0),e[69]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e[70],e[69],d.i64.cast([0,3]))}])}]):d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: $latest_epoch_data is null."):d.resolve()},function(a){return d.db.table(178).put({pk:d.i64.cast([0,1]),recoveryCodeStatus:d.i64.cast([0,4])})},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $latest_epoch_data is null."),e[62]="$latest_epoch_data is null.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",e[62]].join("")),e[61]=d.createArray(),void 0!==void 0?e[63]=(e[61].push(void 0),e[61]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e[62],e[61],d.i64.cast([0,3]))}])}]):d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: $mailbox root key is null"):d.resolve()},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $mailbox root key is null"),e[47]="$mailbox root key is null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",e[47]].join("")),e[46]=d.createArray(),void 0!==void 0?e[48]=(e[46].push(void 0),e[46]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e[47],e[46],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $mailbox root key is null",!1)}]):d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: oblivious validation token is null"):d.resolve()},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] oblivious validation token is null"),e[47]="oblivious validation token is null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",e[47]].join("")),e[46]=d.createArray(),void 0!==void 0?e[48]=(e[46].push(void 0),e[46]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e[47],e[46],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] oblivious validation token is null",!1)}]):d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: epoch root key is null"):d.resolve()},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch root key is null"),e[47]="epoch root key is null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",e[47]].join("")),e[46]=d.createArray(),void 0!==void 0?e[48]=(e[46].push(void 0),e[46]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e[47],e[46],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch root key is null",!1)}]):d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: epoch anon id is null"):d.resolve()},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch anon id is null"),e[47]="epoch anon id is null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",e[47]].join("")),e[46]=d.createArray(),void 0!==void 0?e[48]=(e[46].push(void 0),e[46]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e[47],e[46],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch anon id is null",!1)}])}]):d.sequence([function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: orf client state v1 is null"):d.resolve()},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] orf client state v1 is null"),e[41]="orf client state v1 is null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",e[41]].join("")),e[40]=d.createArray(),void 0!==void 0?e[42]=(e[40].push(void 0),e[40]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e[41],e[40],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] orf client state v1 is null",!1)}])},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_sproc_end"):d.resolve()}]):(f.item,d.sequence([function(a){return function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] An authoritative row already exists, aborting execution of addDeviceFromVirtualDevice"),d.db.table(178).put({pk:d.i64.cast([0,1]),recoveryCodeStatus:d.i64.cast([0,2])})},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_device_already_added"):d.resolve()},function(c){return a[8]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[8],"dasm_add_device_with_virtual_device_and_decryption_key_sproc_end"):d.resolve()}]))})},function(a){return e[2]=d.i64.of_float(Date.now()),e[3]=d.i64.random(),e[5]="Finishing execution. Execution time: ",e[6]=d.i64.to_string(d.i64.sub(e[2],e[0])),e[7]=" ms",e[4]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ",e[4],e[5],e[4],e[6],e[4],e[7]].join("")),d.i64.eq(d.i64.mod_(e[3],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[8]=",",e[9]=d.createArray(),void 0!==void 0?e[10]=(e[9].push(void 0),e[9]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",[e[5],e[8],e[6],e[8],e[7]].join(""),e[9],d.i64.cast([0,4]))):d.resolve()}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_recovery_code_status","secure_encrypted_backups_epochs"];d=a;g["default"]=d}),98);
__d("LSAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",["LSAddDeviceWithVirtualDeviceAndDecryptionKey","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSAddDeviceWithVirtualDeviceAndDecryptionKey"),e.taskId,e.backupId,e.epochId,e.encryptedSecretValues,e.lastEpochId,e.syncEpochs,e.epochStoragePublicKey,e.backupTenancy,e.traceId,e.blobDecryptionKey,e.virtualDeviceId,e.deviceRegistrationId,e.minosEpoch);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("EBAddDeviceGraphQL",["CometRelay","EBAPIQPLPoints","EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery.graphql","EBGetLSVirtualDevices","EBMinosCheckWasmFeatureSupport","FBLogger","I64","LSAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","LSDict","LSEncryptedBackupsBackupTenancy","LSFactory","LSParseRecoveryCode_v2.nop","LSShape","LSVec","MWEncryptedBackupsDeviceRegistrationId","ReQL","WAArrayBufferUtils","WABase64","WAResultOrError","WorkerRelay","WorkerRelayNetwork","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=h!==void 0?h:h=b("EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery.graphql");function a(a){var b=a.backupId,c=a.qplFlow,e=a.recoveryCode,f=a.storage,g=a.userId;return d("WorkerRelayNetwork").getWorkerNetworkExecute().then(function(){return k({backupId:b,fetchQueryGraphQLFn:function(a,b){return d("WorkerRelay").createWorkerQuery(a,b)},qplFlow:c,recoveryCode:e,storage:f,userId:g})}).catch(function(){return d("WAResultOrError").makeError("worker-environment-error")})}function e(a){var b=a.backupId,c=a.environment,e=a.qplFlow,f=a.recoveryCode,g=a.storage;a=a.userId;return k({backupId:b,fetchQueryGraphQLFn:function(a,b){return d("CometRelay").fetchQuery(c,a,b,{fetchPolicy:"network-only"}).toPromise()},qplFlow:e,recoveryCode:f,storage:g,userId:a})}async function k(a){var b=a.backupId,e=a.fetchQueryGraphQLFn,g=a.qplFlow,h=a.recoveryCode,k=a.storage,p=a.userId,q=await d("EBMinosCheckWasmFeatureSupport").checkWasFeatureSupportAndGK();try{return o(k).then(function(a){var b=a!=null?a:p;g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_PARSE_RECOVERY_CODE_START);return Promise.all([k.runInTransaction(function(a){return c("LSParseRecoveryCode_v2.nop")(a,0,h,b,c("LSVec").ofArray([]))},"readwrite","ui",void 0,f.id+":208"),Promise.resolve(b)])}).then(function(a){g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_PARSE_RECOVERY_CODE_END);var h=a[0][0],o=a[0][1];a=a[1];if(h==null||o==null)return d("WAResultOrError").makeError("missing-mandatory-field");var p=d("WABase64").encodeB64(h);g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_FETCH_VD_GRAPHQL_START);return e(j,{request_uuid:a,virtual_device_id:p}).then(function(a){var e,j;if((a==null||(e=a.fetch_virtual_device_info_for_device_addition_v2)==null?void 0:e.ok)===!1){var p,r,s;g.addAnnotations({string:{fetch_vd_info_error_code:(p=a==null||(r=a.fetch_virtual_device_info_for_device_addition_v2)==null||(r=r.error)==null?void 0:r.code)!=null?p:""}});g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_FETCH_VD_GRAPHQL_END);return(a==null||(s=a.fetch_virtual_device_info_for_device_addition_v2)==null||(s=s.error)==null?void 0:s.code)==="NO_VIRTUAL_DEVICE_FOUND"?d("EBGetLSVirtualDevices").getLSVirtualDevices(k).then(function(a){a.length>0&&g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_VIRTUAL_DEVICE_EXISTS);return d("WAResultOrError").makeError("graphql-fetch-vd-error")}):d("WAResultOrError").makeError("graphql-fetch-vd-error")}g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_FETCH_VD_GRAPHQL_END);p=a==null||(j=a.fetch_virtual_device_info_for_device_addition_v2)==null?void 0:j.data;a=d("MWEncryptedBackupsDeviceRegistrationId").getDeviceRegistrationId();var t=(p==null?void 0:p.encrypted_secret_values)!=null?n(p==null?void 0:p.encrypted_secret_values):null,u=p==null?void 0:p.epoch_storage_public_key,v=p==null?void 0:p.epoch_id,w=p==null?void 0:p.last_epoch_id;if(p==null||a===""||t==null||v==null||u==null||w==null){var x=[];p==null&&x.push("payload");a===""&&x.push("deviceRegistrationId");t==null&&x.push("validated_encrypted_secret_values");v==null&&x.push("epoch_id");u==null&&x.push("epoch_storage_public_key");w==null&&x.push("last_epoch_id");g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_MISSING_GRAPHQL_FIELDS,{string_array:{missing_mandatory_field:x}});return d("WAResultOrError").makeError("missing-mandatory-field")}var y=new(c("LSDict"))();p.sync_epochs.forEach(function(a){var b=l(a);b!=null&&a.epoch_id!=null&&y.set(a.epoch_id,d("LSShape").ofRecord(b))});p=m({epoch_head:(x=p.minos_epoch)==null?void 0:x.epoch_head,self_epoch_signature:(x=p.minos_epoch)==null?void 0:x.self_epoch_signature});g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_VIRTUAL_DEVICE_KEY_SPROC_START);var z={backupId:b,backupTenancy:(i||(i=d("I64"))).of_int32(c("LSEncryptedBackupsBackupTenancy").PRODUCTION),blobDecryptionKey:o,deviceRegistrationId:a,encryptedSecretValues:d("LSShape").ofRecord(t),epochId:i.of_string(v),epochStoragePublicKey:d("WABase64").decodeB64(u),lastEpochId:i.of_string(w),syncEpochs:y,taskId:i.of_int32(0),traceId:g.getQPLAttrs().instanceKey.toString(),virtualDeviceId:h};(q||c("gkx")("17219"))&&(z=babelHelpers.extends({},z,{minosEpoch:p}));return k.runInTransaction(function(a){return c("LSAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure")(c("LSFactory")(a),z)},"readwrite",void 0,void 0,f.id+":381").then(function(){g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_VIRTUAL_DEVICE_KEY_SPROC_END);return d("WAResultOrError").makeResult()}).catch(function(a){g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_VIRTUAL_DEVICE_KEY_SPROC_FAIL,{string:{error_message:a.message}});return d("WAResultOrError").makeError("vd-and-decryption-key-sproc-error")})}).catch(function(a){g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_FETCH_VD_GRAPHQL_FAIL,{string:{error_message:a.message}});return d("WAResultOrError").makeError("graphql-fetch-vd-error")})}).catch(function(a){g.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_PARSE_RECOVERY_CODE_FAIL,{string:{error_message:a.message}});return d("WAResultOrError").makeError("parse-recovery-code-error")})}catch(a){c("FBLogger")("wmi_eb").catching(a).mustfix("Runtime error performing EBAddDeviceGraphQL: %s",a);g.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_RUNTIME_ERROR,{string:{error_message:a.message}});return Promise.resolve(d("WAResultOrError").makeError("runtime-error"))}}function l(a){var b=a.backup_id,e=a.encrypted_epoch_key,f=a.epoch_anon_id,g=a.epoch_auth_public_key,h=a.epoch_data_v2,j=a.epoch_id,k=a.is_active_epoch,l=a.minos_epoch,m=a.next_epoch_id;a=a.prev_epoch_id;if(b==null||f==null||g==null||j==null||k==null)return null;var n=l==null?void 0:l.epoch_head;l=l==null?void 0:l.self_epoch_signature;n=n!=null&&l!=null?d("LSShape").ofRecord({epoch_head:d("WABase64").decodeB64(n),self_epoch_signature:d("WABase64").decodeB64(l)}):void 0;l=h==null?void 0:h.epoch_anon_id;h=h==null?void 0:h.epoch_root_key;l=l!=null&&h!=null?{epoch_anon_id:l,epoch_root_key:h}:null;h={backup_id:(i||(i=d("I64"))).of_string(b),encrypted_epoch_key:e!=null?d("WABase64").decodeB64(e):null,epoch_anon_id:d("WAArrayBufferUtils").stringToArrayBuffer(f),epoch_auth_public_key:d("WABase64").decodeB64(g),epoch_data_v2:l?d("LSShape").ofRecord(l):null,epoch_id:i.of_string(j),is_active_epoch:k,next_epoch_id:m!=null?(i||(i=d("I64"))).of_string(m):null,prev_epoch_id:a!=null?(i||(i=d("I64"))).of_string(a):null};(c("gkx")("2760")||c("gkx")("17219"))&&(h=babelHelpers.extends({},h,{minos_epoch:n}));return h}function m(a){var b=a.epoch_head;a=a.self_epoch_signature;return b==null||a==null?void 0:d("LSShape").ofRecord({epoch_head:d("WABase64").decodeB64(b),self_epoch_signature:d("WABase64").decodeB64(a)})}function n(a){var b=a.encrypted_epoch_anon_id,c=a.encrypted_epoch_root_key,d=a.encrypted_epoch_storage_private_key,e=a.encrypted_mailbox_root_key_blob,f=a.encrypted_oblivious_validation_token_blob,g=a.encrypted_ocmf_client_state;a=a.encrypted_orf_client_state_v2;return b==null||c==null||e==null||f==null||g==null?null:{encrypted_epoch_anon_id:b,encrypted_epoch_root_key:c,encrypted_epoch_storage_private_key:d,encrypted_mailbox_root_key_blob:e,encrypted_oblivious_validation_token_blob:f,encrypted_ocmf_client_state:g,encrypted_orf_client_state_v2:a}}function o(a){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.encrypted_backups)).then(function(a){a=a==null?void 0:a.encryptionManagementDelegatorId;return a!=null?(i||(i=d("I64"))).to_string(a):null})}g.addDeviceGraphQLWorker=a;g.addDeviceGraphQL=e}),98);
__d("LSOnboardFromExistingDeviceStart",["LSGetLatestEpochKeys","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][onboardFromExistingDeviceStart] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.db.table(282).add({stateKey:"auto_restored",stateValue:"true"})},function(b){return c.db.table(185).add({pk:c.i64.cast([0,1]),backupId:a[0],deviceRegistrationId:a[2],taskId:c.i64.cast([0,1])})},function(a){return c.storedProcedure(b("LSGetLatestEpochKeys"),!1).then(function(a){return a=a,d[2]=a[0],d[3]=a[1],a})},function(e){return d[2]!==void 0?c.sequence([function(e){return d[11]=d[2].get("epoch_keys"),d[12]=d[11].get("epoch_id"),d[13]=new c.Map(),d[13].set("existing_device_id",a[1]),d[13].set("base_epoch_id",d[12]),d[14]=new c.Map(),d[14].set("success",d[13]),d[15]=c.toJSON(d[14]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50036]),d[15],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[4]=void 0}]):c.sequence([function(a){return d[3]!==void 0?c.sequence([function(a){return d[12]=d[3].get("error_message"),d[13]=d[3].get("error_code"),d[14]=new c.Map(),d[14].set("error_code",d[13]),d[14].set("stored_procedure","onboardFromExistingDeviceStart"),d[14].set("error_message",d[12]),d[15]=new c.Map(),d[15].set("failure",d[14]),d[16]=c.toJSON(d[15]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50036]),d[16],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[17]=a[0],a})},function(a){return d[18]=new c.Map(),d[18].set("error_code",d[13]),d[18].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceStartStoredProcedure"),d[18].set("error_message",""),d[11]=d[18]}]):c.sequence([function(a){return d[12]=new c.Map(),d[12].set("error_code",c.i64.cast([0,603])),d[12].set("stored_procedure","onboardFromExistingDeviceStart"),d[12].set("error_message","Unknown error encountered"),d[13]=new c.Map(),d[13].set("failure",d[12]),d[14]=c.toJSON(d[13]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50036]),d[14],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[15]=a[0],a})},function(a){return d[16]=new c.Map(),d[16].set("error_code",c.i64.cast([0,603])),d[16].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceStartStoredProcedure"),d[16].set("error_message",""),d[11]=d[16]}])},function(a){return d[4]=d[11]}])},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][onboardFromExistingDeviceStart] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"onboardFromExistingDeviceStart",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[4]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsOnboardFromExistingDeviceStartStoredProcedure";a.__tables__=["experiences_shared_state","device_metadata"];e.exports=a}),null);
__d("LSOnboardFromExistingDeviceStartStoredProcedure",["LSOnboardFromExistingDeviceStart","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSOnboardFromExistingDeviceStart"),e.backupId,e.previousDeviceId,e.newDeviceRegistrationId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("EBAddDeviceWithKeys",["ClientConsistencyEventEmitter","CurrentAppID","EBAPIQPLPoints","EBDB","EBSMAPI","EBSMGatingUI","I64","LSAuthorityLevel","LSFactory","LSIntEnum","LSOnboardFromExistingDeviceStartStoredProcedure","LSShape","MWChatEncryptedBackupsLogging","MWChatEncryptedBackupsQPLEvents","MWEBODSEntityName.enum","MWEncryptedBackupsInitializeRestoreDeferred","MWEncryptedBackupsLocalStorageEntryEnum","MWEncryptedBackupsSharedState","ODS","Promise","QPLFlow","QPLUserFlow","ReQL","WAHashStringToNumber","WALogger","err","getErrorSafe","justknobx","promiseDone","qpl","requireDeferred","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t=c("requireDeferred")("MWEBUseLocalStorage").__setRef("EBAddDeviceWithKeys");function a(a){var e=a.backupId,g=a.db,o=a.newDeviceRegistrationId,v=a.previousDeviceId,w=a.source,x=a.trackAddingDevice;return new(s||(s=b("Promise")))(function(a,b){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys start"])));c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,"START_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC");var s=d("WAHashStringToNumber").hashStringToNumber(c("uuidv4")()),y=c("qpl")._(521473756,"2768"),z=w,A=d("QPLFlow").startQPLFlow(y,{annotations:{bool:{isEBAddDeviceWithKeys:!0,isInWorker:!1},string:{restore_type:z}},instanceKey:s,timeoutInMs:c("justknobx")._("2444")});A.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_START);(p||(p=d("ODS"))).bumpEntityKey(7319,z,"start");d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys caling LSOnboardFromExistingDeviceStartStoredProcedure"])));g.runInTransaction(function(a){return c("LSOnboardFromExistingDeviceStartStoredProcedure")(c("LSFactory")(a),{backupId:e,newDeviceRegistrationId:o,previousDeviceId:v})},"readwrite",void 0,void 0,f.id+":103").then(function(e){e=e[0];c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,"END_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC");A.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_END);if(e!=null){var f,h=d("LSShape").toRecord(e).error_message;c("QPLUserFlow").addPoint((f=d("MWChatEncryptedBackupsQPLEvents")).restoreDeviceAuthQplEvent,"FAIL_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC_WIPE_EBSM");c("QPLUserFlow").addPoint(f.restoreQplEvent,"FAIL_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC_WIPE_EBSM");d("MWChatEncryptedBackupsLogging").endFailure({errorName:h,event:f.restoreQplEvent});d("MWChatEncryptedBackupsLogging").endFailure({errorName:h,event:f.restoreDeviceAuthQplEvent,odsEntityName:c("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH});A.endFail(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_FAILURE,{string:{error_code:(q||(q=d("I64"))).to_string(d("LSShape").toRecord(e).error_code),error_message:h}});(p||(p=d("ODS"))).bumpEntityKey(7319,z,"fail");d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithKeys sproc failed, isInWorker: false, error: ",""])),h);c("promiseDone")(d("EBDB").clearEbStores());switch(d("CurrentAppID").getAppID()){case 772021112871879..toString():c("ClientConsistencyEventEmitter").emit("hardRefresh","eb_autorestore_error");break;default:c("ClientConsistencyEventEmitter").emit("softRefresh","eb_autorestore_error")}b(c("err")(h))}A.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SUBSCRIPTION_START);var i=d("ReQL").fromTableAscending(g.tables.secure_encrypted_backups_client_state).subscribe(function(e,f){if(f.operation==="delete"){i();e="[wmi][ebsm] EBAPI addDeviceWithKeys subscription failed, isInWorker: false, error: client state deleted";u(e,A,z);b(c("err")(e))}else if(f.operation==="add"||f.operation==="put"){e=f.value;f=e.authorityLevel;e=e.deviceId;(q||(q=d("I64"))).equal(f,(r||(r=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))&&(c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,"END_LS_ADD_DEVICE_WITH_EB_KEYS_TASK"),A.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SUBSCRIPTION_END),i(),c("promiseDone")(d("MWEncryptedBackupsSharedState").upsertEBSharedStateEntry({db:g,stateKey:c("MWEncryptedBackupsLocalStorageEntryEnum").ENCRYPTED_BACKUPS_RESTORED_SUCCESSFULLY})),d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys client state row added"]))),x(e),t.onReady(function(a){var b=a.mwEBCreateLocalStorageEntry;a=a.mwEBDeleteLocalStorageEntry;b(c("MWEncryptedBackupsLocalStorageEntryEnum").MW_EB_HAS_RESTORED_IN_CURRENT_SESSION);b(c("MWEncryptedBackupsLocalStorageEntryEnum").MW_EB_HAS_RESTORED_IN_CURRENT_SESSION_2);a(c("MWEncryptedBackupsLocalStorageEntryEnum").EBSM_CORRUPTION_WIPE)}),d("MWEncryptedBackupsInitializeRestoreDeferred").encryptedBackupsInitializeRestoreDeferred({db:g,onFailure:function(){d("MWChatEncryptedBackupsLogging").endFailure({annotations:{bool:{is_backend_setup:d("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},errorName:"FAILED_TO_RESTORE_ENCRYPTED_BACKUP",event:d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),d("MWChatEncryptedBackupsLogging").endFailure({annotations:{bool:{is_backend_setup:d("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},errorName:"FAILED_TO_RESTORE_ENCRYPTED_BACKUP",event:d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:c("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}),d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys initialize restore failed"])))},onSuccess:function(){c("QPLUserFlow").addAnnotations(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,{string:{restore_type:"auto_restore"}}),d("MWChatEncryptedBackupsLogging").endSuccess({annotations:{bool:{is_backend_setup:d("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},event:d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),d("MWChatEncryptedBackupsLogging").endSuccess({event:d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:c("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}),d("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys initialize restore success"])))}}),c("EBSMAPI").fetchBackupIds("EBAddDeviceWithKeys")["catch"](function(a){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["",""])),c("getErrorSafe")(a).message)}),A.endSuccess(),(p||(p=d("ODS"))).bumpEntityKey(7319,z,"success"),a())}})})["catch"](function(a){a="[wmi][ebsm] EBAPI addDeviceWithKeys sproc error, isInWorker: false, error: "+c("getErrorSafe")(a).message;u(a,A,z);b(c("err")(a))})})}function u(a,b,e){d("MWChatEncryptedBackupsLogging").endFailure({annotations:{bool:{isBackendSetupOnFail:d("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},errorName:a,event:d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),d("MWChatEncryptedBackupsLogging").endFailure({errorName:a,event:d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:c("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}),b.endFail(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_FAILURE,{string:{error_message:a}}),(p||(p=d("ODS"))).bumpEntityKey(7319,e,"fail"),d("WALogger").ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["",""])),a)}g.addDeviceWithEBKeys=a}),98);
__d("LSAddDevice",["LSArrayGetObjectAt","LSBase64Encode.nop","LSGetViewerFBID","LSHandleWrongRecoveryCode","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSParseRecoveryCode_v2.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop","justknobx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(g){return d.sequence([function(c){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Beginning execution."),a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_sproc_start"):d.resolve()},function(f){return c("justknobx")._("946")?d.sequence([function(a){return e[8]=d.createArray(),d.forEach(d.db.table(179).fetch(),function(a){var b=a.item;return d.sequence([function(a){return e[15]=b.taskId,d.db.table(2).fetch([[[e[15]]]]).next().then(function(a,b){b=a.done;a=a.value;return b?e[13]=!1:(a.item,e[13]=!0)})},function(a){return e[13]?0:e[16]=(e[8].push(e[15]),e[8])}])})},function(a){return e[9]=d.i64.of_int32(e[8].length),d.i64.gt(e[9],d.i64.cast([0,0]))?d.loopAsync(e[9],function(a){return e[13]=a,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[8],e[13]).then(function(a){return a=a,e[14]=a[0],e[15]=a[1],a})},function(a){return d.forEach(d.db.table(179).fetch([[[e[14]]]]),function(a){return a["delete"]()})}])}):d.resolve()},function(a){return d.db.table(179).fetch().next().then(function(a,b){b=a.done;a=a.value;return b?e[10]=!1:(a.item,e[10]=!0)})},function(c){return e[10]?d.sequence([function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_error","LSEncryptedBackupsAddDeviceStoredProcedure: add device task already pending"):d.resolve()},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] add device task already pending"),e[14]="add device task already pending",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] ","",e[14]].join("")),e[13]=d.createArray(),void 0!==void 0?e[15]=(e[13].push(void 0),e[13]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceStoredProcedure",e[14],e[13],d.i64.cast([0,3]))},function(a){return e[12]=d.i64.cast([0,1])}]):d.sequence([function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_vd_error_correction_start"):d.resolve()},function(b){return e[13]=d.createArray(),d.forEach(d.filter(d.db.table(184).fetch(),function(b){return d.i64.eq(b.backupId,a[0])}),function(a){a=a.item;return e[19]=new d.Map(),e[19].set("virtual_device_id",a.virtualDeviceId),e[20]=(e[13].push(e[19]),e[13])})},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_vd_error_correction_end"):d.resolve()},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_parse_recovery_code_start"):d.resolve()},function(a){return d.db.table(172).fetch().next().then(function(a,b){var c=a.done;a=a.value;return c?e[14]=void 0:(b=a.item,e[20]=b.encryptionManagementDelegatorId,d.i64.neq(e[20],void 0)?(d.i64.neq(e[20],d.i64.cast([0,0]))?e[21]=d.i64.to_string(e[20]):e[21]=void 0,e[19]=e[21]):e[19]=void 0,e[14]=e[19])})},function(a){return d.storedProcedure(b("LSGetViewerFBID")).then(function(a){return a=a,e[16]=a[0],a})},function(c){return d.nativeOperation(b("LSParseRecoveryCode_v2.nop"),a[1],e[14]==null?d.i64.to_string(e[16]):e[14],e[13]).then(function(a){return a=a,e[17]=a[0],e[18]=a[1],a})},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_parse_recovery_code_end"):d.resolve()},function(c){return d.blobs.neq(e[17],void 0)?d.blobs.neq(e[18],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[17]).then(function(a){return a=a,e[19]=a[0],a})},function(a){return d.db.table(178).put({pk:d.i64.cast([0,1]),recoveryCodeStatus:d.i64.cast([0,1])})},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_issue_fetch_virtual_device_task_start"):d.resolve()},function(c){return e[24]=d.i64.cast([0,1e3]),e[20]=e[24],e[21]=new d.Map(),e[21].set("backup_id",a[0]),e[21].set("virtual_device_id",e[19]==null?"":e[19]),e[21].set("trace_id",void 0),e[22]=d.toJSON(e[21]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50007]),e[22],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,e[20]).then(function(a){return a=a,e[23]=a[0],a})},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_issue_fetch_virtual_device_task_end"):d.resolve()},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_insert_device_registration_id_start"):d.resolve()},function(b){return d.db.table(185).add({pk:d.i64.cast([0,1]),backupId:a[0],deviceRegistrationId:a[2],taskId:e[23]})},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_insert_device_registration_id_end"):d.resolve()},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_insert_recovery_code_data_start"):d.resolve()},function(a){return d.db.table(179).add({taskId:e[23],virtualDeviceId:e[17],blobDecryptionKey:e[18]})},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_insert_recovery_code_data_end"):d.resolve()}]):d.sequence([function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_error","LSEncryptedBackupsAddDeviceStoredProcedure: Invalid recovery code. blob_decryption_key is null"):d.resolve()},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Invalid recovery code. blob_decryption_key is null",!0)}]):d.sequence([function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_error","LSEncryptedBackupsAddDeviceStoredProcedure: Invalid recovery code. virtual_device_id is null"):d.resolve()},function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Invalid recovery code. virtual_device_id is null"),e[20]="Invalid recovery code. virtual_device_id is null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] ","",e[20]].join("")),e[19]=d.createArray(),void 0!==void 0?e[21]=(e[19].push(void 0),e[19]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceStoredProcedure",e[20],e[19],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Invalid recovery code. virtual_device_id is null",!0)}])},function(a){return e[12]=d.i64.cast([0,0])}])},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_sproc_end"):d.resolve()},function(a){return e[1]=e[12]}]):d.sequence([function(c){return function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] addDeviceFlow is not enabled"),a[4]!==void 0?d.nativeOperation(b("LSQplAnnotateString.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_error","LSEncryptedBackupsAddDeviceStoredProcedure: add device flow is disabled"):d.resolve()},function(c){return a[4]!==void 0?d.nativeOperation(b("LSQplMarkPoint.nop"),d.i64.cast([0,1021646192]),a[4],"dasm_add_device_sproc_end"):d.resolve()},function(a){return e[1]=d.i64.cast([0,1])}])},function(a){return e[2]=d.i64.of_float(Date.now()),e[3]=d.i64.random(),e[5]="Finishing execution. Execution time: ",e[6]=d.i64.to_string(d.i64.sub(e[2],e[0])),e[7]=" ms",e[4]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] ",e[4],e[5],e[4],e[6],e[4],e[7]].join("")),d.i64.eq(d.i64.mod_(e[3],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[8]=",",e[9]=d.createArray(),void 0!==void 0?e[10]=(e[9].push(void 0),e[9]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceStoredProcedure",[e[5],e[8],e[6],e[8],e[7]].join(""),e[9],d.i64.cast([0,4]))):d.resolve()},function(a){return f[0]=e[1]}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsAddDeviceStoredProcedure";a.__tables__=["secure_recovery_code_data","pending_tasks","encrypted_backups_virtual_devices","encrypted_backups","secure_encrypted_backups_recovery_code_status","device_metadata"];d=a;g["default"]=d}),98);
__d("LSAddDeviceStoredProcedure",["LSAddDevice","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSAddDevice"),e.backupId,e.recoveryCode,e.deviceRegistrationId,e.backupTenancy,e.traceId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSEncryptedBackupsRecoveryCodeStatus",[],(function(a,b,c,d,e,f){a=Object.freeze({OPTIMISTIC:1,VALID:2,INVALID:3,SYSTEM_ERROR:4});f["default"]=a}),66);
__d("MWEncryptedBackupsRecoveryCodeStatus",["FBLogger","I64","LSEncryptedBackupsRecoveryCodeStatus"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){var b=a.onFailure,e=a.onInvalidRecoveryCode,f=a.onSuccess;a=a.recoveryCodeStatusData;if((a==null?void 0:a.length)!==1)return;a=a[0].recoveryCodeStatus;switch((h||(h=d("I64"))).to_int32(a)){case c("LSEncryptedBackupsRecoveryCodeStatus").OPTIMISTIC:return c("LSEncryptedBackupsRecoveryCodeStatus").OPTIMISTIC;case c("LSEncryptedBackupsRecoveryCodeStatus").INVALID:e==null||e();return c("LSEncryptedBackupsRecoveryCodeStatus").INVALID;case c("LSEncryptedBackupsRecoveryCodeStatus").VALID:f==null||f();return c("LSEncryptedBackupsRecoveryCodeStatus").VALID;case c("LSEncryptedBackupsRecoveryCodeStatus").SYSTEM_ERROR:b==null||b();return c("LSEncryptedBackupsRecoveryCodeStatus").SYSTEM_ERROR;default:b==null||b(),c("FBLogger")("wmi_eb").mustfix("Invalid Recovery Code Status type")}}g.encryptedBackupsGetRecoveryCodeStatus=a}),98);
__d("EBAddDeviceWithRecoveryCode",["EBAPIQPLPoints","EBAddDeviceGraphQL","EBDeps","FBLogger","I64","LSAddDeviceStoredProcedure","LSEncryptedBackupsBackupTenancy","LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","MAWWaitForBackendSetup","MWEncryptedBackupsDeviceRegistrationId","MWEncryptedBackupsRecoveryCodeStatus","ReQL","WALogger","WAResultOrError","isInstamadilloEB","justknobx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n=10;function o(a){var b=a.count,e=a.storage;return new Promise(function(a,f){if(b===n)return a();c("promiseDone")(d("ReQL").firstAsync(d("ReQL").fromTableAscending(e.tables.encrypted_backups)),function(c){c=c==null?void 0:c.backupId;if(c!=null)return a(c);window.setTimeout(function(){a(o({count:b+1,storage:e}))},1e3)},function(a){return f(a)})})}function a(a){var b=a.environment,e=a.qplFlow,g=a.recoveryCode,n=a.userId,r=function(){},s=!1;a=new Promise(function(a,b){window.setTimeout(function(){if(s)return;c("FBLogger")("wmi_eb").warn("Add device failed by timeout 90 sec");e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TIMEOUT);a("ADD_DEVICE_TIMEOUT")},c("justknobx")._("4226"))});var t=new Promise(async function(a,p){e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_WAIT_FOR_EBLS_START);var s=await d("EBDeps").getDeps().getLSDB();e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_WAIT_FOR_EBLS_END);r=s.tables.secure_encrypted_backups_recovery_code_status.subscribe(function(b,f){if(f.operation==="delete")return;b=[f.value];e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_CHECK_RC_STATUS);d("MWEncryptedBackupsRecoveryCodeStatus").encryptedBackupsGetRecoveryCodeStatus({onFailure:function(){q(e,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_FAILED_TO_GET_RC_STATUS),r(),a("ADD_DEVICE_FAILED_TO_GET_RC_STATUS")},onInvalidRecoveryCode:function(){q(e,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.INVALID_RECOVERY_CODE),r(),a("INVALID_RECOVERY_CODE")},onSuccess:function(){e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TASK_END),e.endSuccess({bool:{isBackendSetupOnSuccess:d("EBDeps").getDeps().isBackendSetupSuccessful()}}),r(),c("promiseDone")(d("EBDeps").getDeps().trackAddingNewDevice()),a("SUCCESS")},recoveryCodeStatusData:b})});c("promiseDone")(o({count:0,storage:s}),function(o){if(o!=null)if(!c("isInstamadilloEB")()){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device gql start"])));e.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_START);var t=b!=null?d("EBAddDeviceGraphQL").addDeviceGraphQL({backupId:o,environment:b,qplFlow:e,recoveryCode:g,storage:s,userId:n}):d("EBAddDeviceGraphQL").addDeviceGraphQLWorker({backupId:o,qplFlow:e,recoveryCode:g,storage:s,userId:n});return t.then(function(b){if(b.success)e.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_END),e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TASK_START),d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device gql success"])));else{q(e,d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_FAIL,{string:{fail_result:b.error}});e.addPoint(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_FAIL);r();return a("ADD_DEVICE_GRAPHQL_ERROR")}})}else{d("WALogger").LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device sproc start"])));var u=d("MWEncryptedBackupsDeviceRegistrationId").getDeviceRegistrationId();if(u===""){q(e,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_FAILED_DEVICE_REGISTRATION_ID_NULL);r();return p("deviceRegistrationId is not defined")}e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_START);return s.runInTransaction(function(a){return c("LSAddDeviceStoredProcedure")(c("LSFactory")(a),{backupId:o,backupTenancy:(l||(l=d("I64"))).of_int32(c("LSEncryptedBackupsBackupTenancy").PRODUCTION),deviceRegistrationId:u,recoveryCode:g})},"readwrite",void 0,void 0,f.id+":232").then(function(a){a=a[0];if(!(l||(l=d("I64"))).equal(a,(m||(m=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").SUCCESS))){q(e,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_FAILURE,{bool:{is_backend_setup:d("MAWWaitForBackendSetup").isBackendSetupSuccessful()}});r();return p("Add device sproc failed")}e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_END);e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TASK_START);d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device sproc success"])))}).catch(function(a){e.addAnnotations({string:{error_message:a.message}});throw a})}else{q(e,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_FAILURE_BACKUP_NOT_FOUND);r();return a("ADD_DEVICE_ERROR_BACKUP_ID_NOT_DEFINED")}},function(b){c("FBLogger")("wmi_eb").catching(b).mustfix("Add device failed. Could not find backup.");q(e,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_COULD_NOT_FIND_BACKUP,{string:{error_message:b.message}});r();return a("ADD_DEVICE_ERROR_COULD_NOT_READ_BACKUP_TABLE")})});return Promise.race([t,a]).then(function(a){s=!0;return p(a)})}function p(a){return a==="SUCCESS"?d("WAResultOrError").makeResult():d("WAResultOrError").makeError(a)}var q=function(a,b,c){a.endFail(b,babelHelpers.extends({},c!=null?c:{},{bool:{isBackendSetupOnFail:d("EBDeps").getDeps().isBackendSetupSuccessful()}}))};g.addDeviceWithRecoveryCode=a}),98);
__d("EBAddVirtualDevice",["EBDeps","EBLogger","I64","LSEncryptedBackupsOpStatus","LSEncryptedBackupsRecoveryCodeStatus","LSIntEnum","ReQL","WAResultOrError","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("requireDeferred")("MWEncryptedBackupsCreateExtraVirtualDeviceWithRecoveryCodeData").__setRef("EBAddVirtualDevice");async function a(a){var b=a.actionType,e=a.qplFlow,f=a.recoveryCodeData;e.addPoint("add_virtual_device_get_db_start");var g=await d("EBDeps").getDeps().getLSDB();e.addPoint("add_virtual_device_get_db_end");e.addPoint("add_virtual_device_sproc_start");return new Promise(function(a,k){return j.onReady(function(j){var k=g.tables.secure_encrypted_backups_recovery_code_status.subscribe(function(){c("promiseDone")(d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(g.tables.secure_encrypted_backups_recovery_code_status)),function(b){if(b==null)return;if(b.length!==1)return;b=b[0].recoveryCodeStatus;if((h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsRecoveryCodeStatus").VALID))){k();return a(d("WAResultOrError").makeResult())}else if((h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsRecoveryCodeStatus").INVALID))){k();return a(d("WAResultOrError").makeError("ADD_VIRTUAL_DEVICE_STATUS_INVALID"))}else return})});c("promiseDone")(j.initializeCreateExtraVirtualDeviceStoredProcedure(g,(h||(h=d("I64"))).of_int32(b),f),function(b){e.addPoint("add_virtual_device_sproc_end");b=b[0];if(!(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").SUCCESS)))if((h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE))){e.endFail("add_virtual_device_sproc_failure");d("EBLogger").EBLogger().mustfix("Error while creating extra virtual device - failure");return a(d("WAResultOrError").makeError("ADD_VIRTUAL_DEVICE_STATUS_FAILURE"))}else{e.addPoint("add_virtual_device_sproc_fail_unknown");d("EBLogger").EBLogger().mustfix("Error while creating extra virtual device - unknown");return a(d("WAResultOrError").makeError("ADD_VIRTUAL_DEVICE_STATUS_UNKNOWN"))}},function(){d("EBLogger").EBLogger().mustfix("Error while creating extra virtual device.");return a(d("WAResultOrError").makeError("ADD_VIRTUAL_DEVICE_ERROR"))})})})}g.addVirtualDevice=a}),98);
__d("EBBatchRequestResignCdnUrlQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="24784488421147370"}),null);
__d("EBBatchRequestResignCdnUrlQuery.graphql",["EBBatchRequestResignCdnUrlQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{defaultValue:null,kind:"LocalArgument",name:"request"}],c=[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"MessengerDefaultEncryptedBackup",kind:"LinkedField",name:"messenger_default_encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:[{kind:"Variable",name:"payloads",variableName:"request"}],concreteType:"XFBResignCdnUrlResponse",kind:"LinkedField",name:"batch_resigned_attachment_cdn_url",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"instance_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"path",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_message",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_enum",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:a,kind:"Fragment",metadata:null,name:"EBBatchRequestResignCdnUrlQuery",selections:c,type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:a,kind:"Operation",name:"EBBatchRequestResignCdnUrlQuery",selections:c},params:{id:b("EBBatchRequestResignCdnUrlQuery_facebookRelayOperation"),metadata:{},name:"EBBatchRequestResignCdnUrlQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBBatchRequestResignCdnUrl",["EBBatchRequestResignCdnUrlQuery.graphql","EBEnqueueResignCdnUrlRequests","FBLogger","WADirectPath","WAErrorMessage","WAMediaUtils","WAResultOrError","createWorkerQuery"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r=function(){return c("FBLogger")("wmi").tags(["labyrinth_web","resign_cdn_url"])};async function a(a){var b=d("EBEnqueueResignCdnUrlRequests").getGqlRestoredCdnUrlMap(),c=[];for(b of b.entries()){var e=b[0],f=b[1];f.pending||c.push([e,f])}if(c.length<1)return;e=c.map(function(a){return{instance_key:a[0],payload:a[1].payload}});c.forEach(function(b){var a=b[0];b=b[1];d("EBEnqueueResignCdnUrlRequests").setGqlRestoredCdnUrlMap(a,{payload:b.payload,pending:!0,resolvable:b.resolvable})});await s(a,e)}async function s(a,b){if(b.length<1)return;var e=d("EBEnqueueResignCdnUrlRequests").getGqlRestoredCdnUrlMap();a==null||a.addPoint("resign_cdn_url_query_start");try{var f,g,h=await c("createWorkerQuery")(t,{request:b.map(function(a){return{instance_key:a.instance_key,payload:a.payload.payload}})});a==null||a.addPoint("resign_cdn_url_query_end");h=h==null||(f=h.viewer)==null||(f=f.messenger_default_encrypted_backup)==null||(f=f.mailbox)==null?void 0:f.batch_resigned_attachment_cdn_url;r().DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Received "," requests"])),h==null?void 0:h.length);a==null||a.addAnnotations({int:{resign_cdn_url_gql_batch_size:(g=h==null?void 0:h.length)!=null?g:0}});h==null||h.forEach(function(b){var c=b.instance_key!=null?d("WAMediaUtils").stringToDeliveryObjectId(b.instance_key):null,f=b.path;if(c!=null){var g=d("WADirectPath").validateDirectPath(f);if(!g.success){r().WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",", graphql error: ",""])),g.error,b.exception_message);a==null||a.addAnnotations({string:{resign_cdn_url_exception_enum:(b=b.exception_enum)!=null?b:"unknown"}})}b=(b=e.get(c))==null?void 0:b.resolvable;b!=null?b.resolve(g):r().MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["No resolvable found for instance key: ",""])),c);e.delete(c)}else r().MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url came back with no instance key, ",""])),f)})}catch(c){g=d("WAErrorMessage").maybeGetMessageFromError(c);a==null||a.addPoint("resign_cdn_url_query_fail");a==null||a.addAnnotations({string:{resign_cdn_url_gql_error:g}});r().WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",""])),g);b.forEach(function(a){var b;b=(b=e.get(d("WAMediaUtils").stringToDeliveryObjectId(a.instance_key)))==null?void 0:b.resolvable;b!=null?b.resolve(d("WAResultOrError").makeError("resign-cdn-url-gql-error")):r().MUSTFIX(n||(n=babelHelpers.taggedTemplateLiteralLoose(["No resolvable found during error for instance key: ",""])),a.instance_key)})}finally{b.forEach(function(a){var b=d("WAMediaUtils").stringToDeliveryObjectId(a.instance_key);b=(b=e.get(b))==null?void 0:b.resolvable;(b==null?void 0:b.isSettled)===!1&&r().MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Resolvable was not properly settled"])));e.delete(d("WAMediaUtils").stringToDeliveryObjectId(a.instance_key))})}}async function e(a,b,e){a==null||a.addPoint("resign_cdn_url_query_start");try{var f;b=await c("createWorkerQuery")(t,{request:[{instance_key:b,payload:e.payload}]});a==null||a.addPoint("resign_cdn_url_query_end");e=b==null||(f=b.viewer)==null||(f=f.messenger_default_encrypted_backup)==null||(f=f.mailbox)==null?void 0:f.batch_resigned_attachment_cdn_url;(e==null?void 0:e.length)!==1&&(a==null||a.addPoint("resign_cdn_url_should_have_one_response"));b=e==null?void 0:e[0];e=b==null?void 0:b.path;e=d("WADirectPath").validateDirectPath(e);if(!e.success){r().WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",", graphql error: ",""])),e.error,b==null?void 0:b.exception_message);a==null||a.addAnnotations({string:{resign_cdn_url_exception_enum:(b=b==null?void 0:b.exception_enum)!=null?b:"unknown"}})}return e}catch(c){b=d("WAErrorMessage").maybeGetMessageFromError(c);a==null||a.addPoint("resign_cdn_url_query_fail");a==null||a.addAnnotations({string:{resign_cdn_url_gql_error:b}});r().WARN(q||(q=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",""])),b);return d("WAResultOrError").makeError("resign-cdn-url-gql-error")}}var t=h!==void 0?h:h=b("EBBatchRequestResignCdnUrlQuery.graphql");g.batchedResignCdnUrlFromMap=a;g.batchedResignCdnUrlWithGraphQL=s;g.resignCdnUrlWithGraphQL=e}),98);
__d("EBEnqueueResignCdnUrlRequests",["EBBatchRequestResignCdnUrl","WACustomError","WAPromiseDelays","WAPromiseTimeout","WAResolvable","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=function(){var a=!0;return{get:function(){return a},set:function(b){a=b}}}(),i=function(){var a=window.performance.now();return{get:function(){return a},set:function(b){a=b}}}(),j=new Map(),k=c("justknobx")._("4662"),l=c("justknobx")._("3244");function a(a,b,c){var e;e=(e=j.get(a))==null?void 0:e.resolvable;if(e!=null){c==null||c.addPoint("resign_cdn_url_map_hit");return m({mediaDownloadFlow:c,objectId:a,payload:b,promise:e.promise})}e=new(d("WAResolvable").Resolvable)();var f=j.size===0;j.set(a,{payload:b,pending:!1,resolvable:e});if(!h.get())return m({mediaDownloadFlow:c,objectId:a,payload:b,promise:e.promise});void n(f);return m({mediaDownloadFlow:c,objectId:a,payload:b,promise:e.promise})}function m(a){var b=a.mediaDownloadFlow,c=a.objectId,e=a.payload;a=a.promise;return d("WAPromiseTimeout").promiseTimeout(a,l).then(function(a){if(!a.success&&a.error==="direct-path-undefined"){j["delete"](c);return d("WAPromiseDelays").delayMs(l).then(function(){return d("EBBatchRequestResignCdnUrl").resignCdnUrlWithGraphQL(b,c,e)})}return a})["catch"](function(a){var f=a instanceof Error&&["NetworkTransportError","NetworkTimeoutError","NetworkRequestError"].includes(a.name);if(a instanceof d("WACustomError").TimeoutError||f){b==null||b.addPoint("resign-cdn-url-gql-timeout");j["delete"](c);return d("EBBatchRequestResignCdnUrl").resignCdnUrlWithGraphQL(b,c,e)}else{b==null||b.addPoint("resign-cdn-url-gql-unexpected-error");b==null||b.addAnnotations({string:{resign_cdn_url_payload_fail_reason:a.message}});throw a}})}function n(a,b){h.set(!1);if(a){h.set(!0);i.set(window.performance.now());return d("EBBatchRequestResignCdnUrl").batchedResignCdnUrlFromMap(b)}else{a=Math.max(k-(window.performance.now()-i.get()),0);return d("WAPromiseDelays").delayMs(a).then(function(){h.set(!0);i.set(window.performance.now());return d("EBBatchRequestResignCdnUrl").batchedResignCdnUrlFromMap(b)})}}function b(){return j}function e(a,b){j.set(a,b)}g.enqueueResignCdnUrl=a;g.getGqlRestoredCdnUrlMap=b;g.setGqlRestoredCdnUrlMap=e}),98);
__d("EBCreateResignCDNUrlPayload",["CreateDerivedKeys","EBBase64Encode","EBWorkerEBDBApi","GetBlobFromInt64BE","Hmac_v2","I64","LSVec","OcmfClientMap","OpeEncrypt","TruncateSortKey","WAArrayBufferUtils","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i="thread_ope_key",j="__DEVICE_ID_PLACEHOLDER__";async function a(a){var b=a.accessTokenSecret,c=a.deliveryObjectId,e=a.mediaType,f=a.messageId,g=a.primaryKeySecret,h=a.productType,i=a.sort;i=i===void 0?!1:i;var l=a.sortOrderMs;a=a.threadId;b=await k({accessTokenSecret:b,deliveryObjectId:c,mediaType:e,messageId:f,primaryKeySecret:g,productType:h,sortOrderMs:l,threadId:a});if(!b.success)return b;c=b.value;e=c.device_id;f=babelHelpers.extends({},c,{device_id:j});g=i?JSON.stringify(f,Object.keys(f).sort()):JSON.stringify(f);return d("WAResultOrError").makeResult(g.replace('"'+j+'"',String(e)))}async function k(a){var b=a.accessTokenSecret,e=a.deliveryObjectId,f=a.mediaType,g=a.messageId,h=a.primaryKeySecret,i=a.productType,j=a.sortOrderMs;a=a.threadId;var k=await d("EBWorkerEBDBApi").getSecureEBClientState();if(k==null)return d("WAResultOrError").makeError("no-eb-client-state");var n=String(k.backupId),o=k.deviceId;if(o==null)return d("WAResultOrError").makeError("no-device-id");var p=c("EBBase64Encode")(k.mailboxRootKeyBlob),q=c("EBBase64Encode")(k.ocmfClientStateBlob);k=await Promise.all([l("attachment_key_scope",JSON.stringify([n,e]),k.ocmfClientStateBlob),l("mailbox_id_scope",n,k.ocmfClientStateBlob),l("message_id_scope",g,k.ocmfClientStateBlob),l("attachment_token_salt_scope",g,k.ocmfClientStateBlob),l("attachment_key_salt_scope",JSON.stringify([n,e]),k.ocmfClientStateBlob),l("attachment_token_salt_scope",JSON.stringify([g,e]),k.ocmfClientStateBlob),l("thread_id_scope",a,k.ocmfClientStateBlob),m(k.mailboxRootKeyBlob,j,a)]);var r=k[0],s=k[1],t=k[2],u=k[3],v=k[4],w=k[5],x=k[6];k=k[7];return k==null?d("WAResultOrError").makeError("no-encrypted-sort-key"):d("WAResultOrError").makeResult({access_token_secret:b,attachment_index_key:c("EBBase64Encode")(r),backup_ent_fbid:-8,backup_id:n,delivery_object_id:e,device_id:o,isOpenEB:0,mailbox_partial_id:c("EBBase64Encode")(s),media_type:f,message_partial_id:c("EBBase64Encode")(t),primary_key_secret:h,product_type:i,raw_identifiers:{otid:g,server_thread_key:null,timestamp:j.toString()},raw_tokens:{mailbox_root_key:p,ocmf_client_state_blob:q},salt_partial_access_token:c("EBBase64Encode")(w),salt_partial_attachment_index_key:c("EBBase64Encode")(v),salt_partial_id:c("EBBase64Encode")(u),sort_key:k,thread_id:a,thread_partial_id:c("EBBase64Encode")(x)})}function l(a,b,e){return c("Hmac_v2")(d("WAArrayBufferUtils").stringToArrayBuffer(a),d("WAArrayBufferUtils").stringToArrayBuffer(b)).then(function(a){return c("OcmfClientMap")(e,a[0])})}async function m(a,b,e){e=new TextEncoder().encode(i+"_"+e).buffer;e=(await d("CreateDerivedKeys").CreateDerivedKeys(e,void 0,a,[(h||(h=d("I64"))).of_int32(32)]))[0];if(e==null)return null;a=await d("GetBlobFromInt64BE").GetBlobFromInt64BE(h.of_float(b));b=await d("TruncateSortKey").TruncateSortKey(a[0]);a=await d("OpeEncrypt").OpeEncrypt(c("LSVec").toArray(e)[0],b[0],h.of_int32(16));e=Array.from(new Uint8Array(a[0]));b=e.map(function(a){return a.toString(16).padStart(2,"0")});return b.join("").toUpperCase()}g.createStringifiedMediaRestorePayloadFromEBDB=a}),98);
__d("EBDeleteBackupsOnClient",["EBDeps","EBSMAPI","ReQL"],(function(a,b,c,d,e,f,g){"use strict";async function a(){var a=await d("EBDeps").getDeps().getLSDB();await a.runInTransaction(async function(a){var b,c=await (b=d("ReQL")).toArrayAsync(b.fromTableAscending(a.secure_encrypted_backups_client_state));await Promise.all(c.map(function(b){return a.secure_encrypted_backups_client_state.delete(b.backupId)}));c=await b.toArrayAsync(b.fromTableAscending(a.secure_encrypted_backups_epochs));await Promise.all(c.map(function(b){return a.secure_encrypted_backups_epochs.delete(b.epochId)}));c=await b.toArrayAsync(b.fromTableAscending(a.secure_encrypted_backups_generated_recovery_code));await Promise.all(c.map(function(b){return a.secure_encrypted_backups_generated_recovery_code.delete(b.pk)}));c=await b.toArrayAsync(b.fromTableAscending(a.encrypted_backups));await Promise.all(c.map(function(b){return a.encrypted_backups.put(babelHelpers.extends({},b,{backupId:void 0}))}));c=await b.toArrayAsync(b.fromTableAscending(a.encrypted_backups_metadata));await Promise.all(c.map(function(b){return a.encrypted_backups_metadata.delete(b.backupId)}));c=await b.toArrayAsync(b.fromTableAscending(a.encrypted_backups_virtual_devices));await Promise.all(c.map(function(b){return a.encrypted_backups_virtual_devices.delete(b.pk)}));c=await b.toArrayAsync(b.fromTableAscending(a.secure_encrypted_backups_recovery_code_status));await Promise.all(c.map(function(b){return a.secure_encrypted_backups_recovery_code_status.delete(b.pk)}));c=await b.toArrayAsync(b.fromTableAscending(a.pending_backups_context_v2));await Promise.all(c.map(async function(b){b=b.pendingBackupTaskId;b!=null&&await a.pending_tasks.delete(b)}))},"readwrite");await c("EBSMAPI").fetchBackupIds("deleteBackupsOnClient")}g.deleteBackupsOnClient=a}),98);
__d("LSDeleteBackups",["LSBase64Encode.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","justknobx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(g){return d.sequence([function(f){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] Beginning execution."),c("justknobx")._("803")?d.sequence([function(c){return d.db.table(168).fetch([[[a[0]]]]).next().then(function(c,f){var g=c.done;c=c.value;return g?(function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] Row not found in client state table for the backupidDeleting the backup without deleting mailbox"),e[9]=new d.Map(),e[9].set("backup_id",a[0]),e[9].set("trace_id",a[1]),e[9].set("backup_deletion_source",a[2]),e[10]=d.toJSON(e[9]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50011]),e[10],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),a[1],d.i64.cast([0,0])).then(function(a){return a=a,e[11]=a[0],a})):(f=c.item,d.sequence([function(c){return e[13]=f.deviceId,d.nativeOperation(b("LSGetBlobFromString.nop"),d.i64.to_string(a[0])).then(function(a){return a=a,e[9]=a[0],a})},function(a){return d.nativeOperation(b("LSHmac_v2.nop"),d.blob("bWFpbGJveF9pZF9zY29wZQ=="),e[9]).then(function(a){return a=a,e[10]=a[0],a})},function(a){return d.nativeOperation(b("LSOcmfClientMap.nop"),f.ocmfClientStateBlob,e[10]).then(function(a){return a=a,e[11]=a[0],a})},function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[11]).then(function(a){return a=a,e[12]=a[0],a})},function(c){return d.i64.neq(e[13],void 0)?(e[14]=new d.Map(),e[14].set("device_id",e[13]),e[14].set("mailbox_partial_id",e[12]==null?"":e[12]),e[14].set("trace_id",a[1]),e[14].set("backup_deletion_source",a[2]),e[15]=d.toJSON(e[14]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_encrypted_backups",d.i64.cast([0,50014]),e[15],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),a[1],d.i64.cast([0,0])).then(function(a){return a=a,e[16]=a[0],a})):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] device_id is null"),e[15]="device_id is null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] ","",e[15]].join("")),e[14]=d.createArray(),void 0!==void 0?e[19]=(e[14].push(void 0),e[14]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDeleteBackupsStoredProcedure",e[15],e[14],d.i64.cast([0,3]))},function(c){return e[16]=new d.Map(),e[16].set("backup_id",a[0]),e[16].set("trace_id",a[1]),e[16].set("backup_deletion_source",a[2]),e[17]=d.toJSON(e[16]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50011]),e[17],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),a[1],d.i64.cast([0,0])).then(function(a){return a=a,e[18]=a[0],a})}])}]))})},function(a){return e[1]=d.i64.cast([0,0])}]):d.resolve((function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] backup deletion flow is not enabled"),e[1]=d.i64.cast([0,1])))},function(a){return e[2]=d.i64.of_float(Date.now()),e[3]=d.i64.random(),e[5]="Finishing execution. Execution time: ",e[6]=d.i64.to_string(d.i64.sub(e[2],e[0])),e[7]=" ms",e[4]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] ",e[4],e[5],e[4],e[6],e[4],e[7]].join("")),d.i64.eq(d.i64.mod_(e[3],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[8]=",",e[9]=d.createArray(),void 0!==void 0?e[10]=(e[9].push(void 0),e[9]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDeleteBackupsStoredProcedure",[e[5],e[8],e[6],e[8],e[7]].join(""),e[9],d.i64.cast([0,4]))):d.resolve()},function(a){return f[0]=e[1]}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsDeleteBackupsStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];d=a;g["default"]=d}),98);
__d("LSDeleteBackupsStoredProcedure",["LSDeleteBackups","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSDeleteBackups"),e.backupId,e.traceId,e.backupDeletionSource);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("encryptedBackupsDeleteBackupsStoredProcedure",["LSDeleteBackupsStoredProcedure","LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","LSResult","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,e){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.encrypted_backups)).then(async function(g){var i=c("LSResult")((h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE));if(g!=null){var j=g.backupId;j!=null&&(i=await a.runInTransaction(function(a){return c("LSDeleteBackupsStoredProcedure")(c("LSFactory")(a),{backupDeletionSource:(h||(h=d("LSIntEnum"))).ofNumber(b),backupId:j,traceId:e})},"readwrite",void 0,void 0,f.id+":37"))}return i})}g.default=a}),98);
__d("EBDeleteEncryptedBackup",["EBAPIQPLPoints","EBDeps","EBSMAPI","LSEncryptedBackupsOpStatus","LSIntEnum","WAGetSafeQPLError","WAResultOrError","WATagsLogger","encryptedBackupsDeleteBackupsStoredProcedure","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=d("WATagsLogger").TAGS(["EB","EBAPIDeleteEncryptedBackup"]);async function a(a){var b=a.qplFlow,e=a.reason;b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_GET_DB_START);var f=await d("EBDeps").getDeps().getLSDB();b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_GET_DB_END);b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_SPROC_START);return new Promise(function(a,g){c("encryptedBackupsDeleteBackupsStoredProcedure")(f,e,b.getQPLAttrs().instanceKey.toString()).then(function(e){e=e[0];if(e===(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE)){b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_SPROC_FAIL);b.endFail("delete_eb_sproc_fail");a(d("WAResultOrError").makeError("DELETE_EB_SPROC_FAIL"));return}b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_SPROC_SUCCESS);var g=f.tables.encrypted_backups.subscribe(function(e,f){if(f.operation==="put")if(f.value.backupId==null){b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_TASK_SUCCESS);b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.FETCH_BACKUP_IDS_START);c("promiseDone")(c("EBSMAPI").fetchBackupIds("EBDeleteEncryptedBackup"),function(){b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.FETCH_BACKUP_IDS_END),b.endSuccess()},function(){b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.FETCH_BACKUP_IDS_END),b.endFail("fetch_backup_ids_fail")});a(d("WAResultOrError").makeResult());return g()}else b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_NON_DELETE_OPERATION);else b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_NON_PUT_OPERATION)},void 0,["backupId"])}).catch(function(c){j.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Exception while calling deleteBackups stored procedure: ",""])),c),b.addPoint(d("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_SPROC_ERROR,{string:{error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(c)}}),b.endFail("delete_eb_sproc_error"),a(d("WAResultOrError").makeError("DELETE_EB_SPROC_ERROR"))})})}g.deleteEncryptedBackup=a}),98);
__d("EBFetchBackupIds",["EBDeps","I64","LSAuthorityLevel","LSEncryptedBackupsBackupTenancy","LSFactory","LSFetchBackupIdsStoredProcedure","LSIntEnum","MWEBODSEntityName.enum","ODS","err","justknobx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=c("justknobx")._("3868");async function a(a,b){(h||(h=d("ODS"))).bumpEntityKey(7319,c("MWEBODSEntityName.enum").MW_EBSM_FETCH_BACKUP_IDS,a);b.addPoint("eb_fetch_backup_ids_get_storage_start");var e=await d("EBDeps").getDeps().getLSDB();b.addPoint("eb_fetch_backup_ids_get_storage_ended");return new Promise(function(a,f){var g,h=e.tables.encrypted_backups.subscribe(function(e,f){if(f.operation==="delete"||!(i||(i=d("I64"))).equal(f.value.authorityLevel,(j||(j=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))){f.operation==="delete"?b.addPoint("eb_fetch_backup_ids_delete_detected"):b.addPoint("eb_fetch_backup_ids_authority_level_not_auth");return}h();window.clearTimeout(g);b.addPoint("eb_fetch_backup_ids_success");b.endSuccess();a()});b.addPoint("eb_fetch_backup_ids_sproc_start");c("promiseDone")(e.runInTransaction(function(a){return c("LSFetchBackupIdsStoredProcedure")(c("LSFactory")(a),{backupTenancy:(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION),isUiBlocking:!1}).then(function(){b.addPoint("eb_fetch_backup_ids_sproc_ended"),g=window.setTimeout(function(){b.endFail("eb_fetch_backup_ids_timeout"),f(c("err")("[wmi][ebapi] Timeout fetching backup ids"))},k)})},"readwrite"))})}g.fetchBackupIds=a}),98);
__d("EBGenerateRecoveryCode",["Base64Utils","EBDeps","LSEncryptedBackupsOpStatus","LSFactory","LSGenerateRecoveryCodeStoredProcedure","LSIntEnum","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h;async function a(a){var b=await d("EBDeps").getDeps().getLSDB(),e=a.virtualDeviceType;return b.runInTransaction(function(a){return c("LSGenerateRecoveryCodeStoredProcedure")(c("LSFactory")(a),{virtualDeviceType:e})},"readwrite",void 0,void 0,f.id+":35").then(function(a){var b=a[0],e=a[1];a=a[2];if((h||(h=d("LSIntEnum"))).toNumber(e)!==c("LSEncryptedBackupsOpStatus").SUCCESS)return d("WAResultOrError").makeError("sproc_failure");else return d("WAResultOrError").makeResult({recoveryCode:b,virtualDeviceId:a!=null?d("Base64Utils").fromArrayBuffer(a):void 0})})}g.generateRecoveryCode=a}),98);
__d("EBGetEBStateQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="23909871918604871"}),null);
__d("EBGetEBStateQuery.graphql",["EBGetEBStateQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null};a={alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:[{kind:"Literal",name:"family_device_id",value:""}],kind:"ScalarField",name:"has_otc_eligible_devices",storageKey:'has_otc_eligible_devices(family_device_id:"")'},{alias:null,args:null,kind:"ScalarField",name:"has_seen_eb_auto_restore_notice",storageKey:null},a,{alias:null,args:null,kind:"ScalarField",name:"is_user_opted_out",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_creation_time",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_tenancy",storageKey:null},{alias:null,args:null,concreteType:"XFBEBVirtualDevice",kind:"LinkedField",name:"virtual_devices",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"creation_time",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"device_created_on",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"device_type",storageKey:null},a,{alias:null,args:null,kind:"ScalarField",name:"migration_status",storageKey:null}],storageKey:null}],storageKey:null},{kind:"ClientExtension",selections:[{alias:null,args:null,kind:"ScalarField",name:"backup_state",storageKey:null}]}],storageKey:null};return{fragment:{argumentDefinitions:[],kind:"Fragment",metadata:null,name:"EBGetEBStateQuery",selections:[{kind:"RequiredField",field:a,action:"LOG",path:"viewer"}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[],kind:"Operation",name:"EBGetEBStateQuery",selections:[a]},params:{id:b("EBGetEBStateQuery_facebookRelayOperation"),metadata:{},name:"EBGetEBStateQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBGetEBState",["EBGetEBStateQuery.graphql","FBLogger","MAWOneTimeCodeGating","RelayHooks","WAResultOrError","XPlatRelayEnvironment","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i=h!==void 0?h:h=b("EBGetEBStateQuery.graphql");async function a(){try{var a,b,e,f,g,h,j,k,l,m,n=await d("RelayHooks").fetchQuery(d("XPlatRelayEnvironment").getRelayEnvironment(),i,{}).toPromise().then(function(a){return a}),o=n==null||(a=n.viewer)==null?void 0:a.backup_state;if(o===1||o===0)return d("WAResultOrError").makeResult({backupStatus:o});o=(o=n==null||(b=n.viewer)==null||(b=b.encrypted_backup)==null?void 0:b.virtual_devices)!=null?o:[];var p=o.filter(function(a){return a.device_type==="HSM"});o=o.filter(function(a){return a.device_type===1});return d("WAResultOrError").makeResult({backupStatus:(n==null||(e=n.viewer)==null?void 0:e.backup_state)!=null?n.viewer.backup_state:0,ebState:{backupMetadata:{backupId:(f=n==null||(g=n.viewer)==null||(g=g.encrypted_backup)==null?void 0:g.id)!=null?f:"",creationTime:(f=n==null||(h=n.viewer)==null||(h=h.encrypted_backup)==null?void 0:h.backup_creation_time)!=null?f:0,deviceCreatedOn:(f=p[0].device_created_on)!=null?f:"",removalStatus:"",requiresHsmMigration:p[0].migration_status!=="DOES_NOT_REQUIRE_MIGRATION",virtualDeviceCreationTime:(f=(f=p[0])==null?void 0:f.creation_time)!=null?f:0,virtualDeviceId:(f=(f=p[0])==null?void 0:f.id)!=null?f:"",virtualDeviceType:(f=(f=p[0])==null?void 0:f.device_type)!=null?f:""},backupTenancy:(f=n==null||(j=n.viewer)==null||(j=j.encrypted_backup)==null?void 0:j.backup_tenancy)!=null?f:"PRODUCTION",hasOtcEligibleDevices:!!(d("MAWOneTimeCodeGating").isOneTimeCodeEnabled&&(n==null||(k=n.viewer)==null||(k=k.encrypted_backup)==null?void 0:k.has_otc_eligible_devices)!==!1),hasSeenEbAutoRestoreNotice:(f=n==null||(l=n.viewer)==null||(l=l.encrypted_backup)==null?void 0:l.has_seen_eb_auto_restore_notice)!=null?f:!1,isPINCodeRegistered:((f=p[0])==null?void 0:f.id)!=null,isUserOptedOut:(p=n==null||(m=n.viewer)==null||(m=m.encrypted_backup)==null?void 0:m.is_user_opted_out)!=null?p:!1,offlineDevicesCount:o.length}})}catch(a){c("FBLogger")("wmi_eb").catching(c("getErrorSafe")(a)).mustfix("Failed to check EB enabled");return d("WAResultOrError").makeResult({backupStatus:0})}}g.GetEbState=a}),98);
__d("LSOcmfClientInit_v2.nop",["CryptoLogger","LSResult","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=c("requireDeferred")("ristretto255").__setRef("LSOcmfClientInit_v2.nop");a=function(a,b){return h.load().then(function(a){return c("LSResult")(a.scalar.getRandom().buffer)})["catch"](function(a){d("CryptoLogger").captureError(d("CryptoLogger").CryptoLogger("ocmf_client_init_v2"),a).mustfix("Failed to init OCMF client.");throw a})};a.__nop_name__="LSOcmfClientInit_v2";g["default"]=a}),98);
__d("LSRandom.nop",["CryptoLogger","I64","LSMaxInt32","LSResult","Promise","XPlatReactCrypto"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=function(a,e,f){a=d("CryptoLogger").CryptoLogger("ope_encrypt");if((i||(i=d("I64"))).gt(f,c("LSMaxInt32"))){a.mustfix("numBytes '"+String(f)+"' too large. Returning an empty array");return(h||(h=b("Promise"))).resolve(c("LSResult")(new Uint8Array(0).buffer))}e=(i||(i=d("I64"))).to_int32(f);a=new Uint8Array(e);f=65536;for(var g=0;g<e;g+=f){var j=a.subarray(g,g+Math.min(e-g,f));d("XPlatReactCrypto").getRandomValues(j)}return(h||(h=b("Promise"))).resolve(c("LSResult")(a.buffer))};a.__nop_name__="LSRandom";g["default"]=a}),98);
__d("LSGenerateInitialDeviceSetupPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateAuthKeyPair.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignature_v2.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientInit_v2.nop","LSOcmfClientMap.nop","LSRandom.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][generateInitialDeviceSetupPayload] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!0}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[33]=new c.Map(),d[33].set("error_msg","Expected a nonempty query result"),d[33].set("code",c.i64.cast([0,3])),d[33].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[34]=c.createArray(),d[35]=(d[34].push(d[33]),d[34]),e=[void 0,d[34]],d[2]=e[0],d[3]=e[1]):(b=a.item,d[33]=new c.Map(),d[33].set("backup_id",b.backupId),d[33].set("device_public_key_blob",b.devicePublicKeyBlob),d[33].set("device_private_key_blob",b.devicePrivateKeyBlob),d[33].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[33].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[33].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[33].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[33].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[33].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[33].set("orf_client_state_v2_blob",void 0),d[33].set("orf_v2_authority_level",void 0),d[33].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[33].set("device_id",b.deviceId),d[33].set("backup_tenancy",b.backupTenancy),d[33].set("encryption_version",b.encryptionVersion),d[33].set("revision_version",b.revisionVersion),d[33].set("initialize_restore_result",void 0),d[33].set("device_creation_timestamp_sec",void 0),d[33].set("authority_level",b.authorityLevel),e=[d[33],void 0],d[2]=e[0],d[3]=e[1])})},function(a){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(a){return d[33]=d[6].get("backup_id"),d[34]=d[6].get("device_public_key_blob"),d[35]=d[6].get("device_private_key_blob"),d[36]=d[6].get("epoch_storage_public_key_blob"),d[37]=d[6].get("epoch_storage_private_key_blob"),d[38]=d[6].get("epoch_auth_public_key_blob"),d[39]=d[6].get("epoch_auth_private_key_blob"),d[40]=d[6].get("mailbox_root_key_blob"),d[41]=d[6].get("ocmf_client_state_blob"),d[42]=d[6].get("orf_client_state_v2_blob"),d[43]=d[6].get("orf_v2_authority_level"),d[44]=d[6].get("oblivious_validation_token_blob"),d[45]=d[6].get("device_id"),d[46]=d[6].get("backup_tenancy"),d[47]=d[6].get("encryption_version"),d[48]=d[6].get("revision_version"),d[49]=d[6].get("initialize_restore_result"),d[50]=d[6].get("device_creation_timestamp_sec"),d[51]=d[6].get("authority_level"),c.i64.neq(d[45],void 0)?c.sequence([function(a){return d[70]=void 0,c.i64.neq(d[70],void 0)?c.resolve(d[71]=d[70]):c.sequence([function(a){return d[74]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[75]=a[0],a})},function(a){return d[75]?d[84]=(d[74].push(c.i64.cast([0,0])),d[74]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[76]=a[0],a})},function(a){return d[76]?d[84]=(d[74].push(c.i64.cast([0,2])),d[74]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[77]=a[0],a})},function(a){return d[77]?d[84]=(d[74].push(c.i64.cast([0,3])),d[74]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[78]=a[0],a})},function(a){return d[78]?d[84]=(d[74].push(c.i64.cast([0,4])),d[74]):0,d[79]=c.createArray(),d[80]=c.i64.of_int32(d[74].length),c.i64.gt(d[80],c.i64.cast([0,0]))?c.loopAsync(d[80],function(a){return d[84]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[74],d[84]).then(function(a){return a=a,d[85]=a[0],d[86]=a[1],a})},function(a){return d[87]=(d[79].push(d[85]),d[79])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[84]=c.createArray(),d[85]=c.i64.of_int32(d[79].length),c.i64.gt(d[85],c.i64.cast([0,0]))?c.loopAsync(d[85],function(a){return d[87]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[79],d[87]).then(function(a){return a=a,d[88]=a[0],d[89]=a[1],a})},function(a){return d[90]=(d[84].push(c.i64.to_string(d[88])),d[84])}])}):c.resolve()},function(a){return d[86]=d[84].join(","),d[81]=d[86]}])},function(a){return d[79].some(function(a){return c.i64.eq(d[47],a)})?d[82]=d[47]:d[82]=void 0,c.i64.neq(d[82],void 0)?d[83]=d[82]:d[83]=void 0,d[71]=d[83]}])},function(a){return c.i64.neq(d[71],void 0)?d[72]=d[71]:d[72]=c.i64.cast([0,0]),c.i64.neq(d[46],void 0)?d[73]=d[46]:d[73]=c.i64.cast([0,1]),a=[d[33],d[45],d[40],d[41],void 0,void 0,d[72],d[73],d[38],d[39],d[34],d[35],d[36],d[37],d[44],d[51],void 0,void 0],d[52]=a[0],d[53]=a[1],d[54]=a[2],d[55]=a[3],d[56]=a[4],d[57]=a[5],d[58]=a[6],d[59]=a[7],d[60]=a[8],d[61]=a[9],d[62]=a[10],d[63]=a[11],d[64]=a[12],d[65]=a[13],d[66]=a[14],d[67]=a[15],d[68]=a[16],d[69]=a[17]}]):c.sequence([function(a){return c.forEach(c.db.table(169).fetch(),function(a){return a["delete"]()})},function(a){return d[70]=c.i64.random(),d[71]=c.i64.random(),c.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,d[72]=a[0],d[73]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,d[74]=a[0],d[75]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateAuthKeyPair.nop")).then(function(a){return a=a,d[76]=a[0],d[77]=a[1],a})},function(a){return c.nativeOperation(b("LSRandom.nop"),c.i64.cast([0,32])).then(function(a){return a=a,d[78]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientInit_v2.nop")).then(function(a){return a=a,d[79]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientInit_v2.nop")).then(function(a){return a=a,d[80]=a[0],a})},function(a){return c.nativeOperation(b("LSRandom.nop"),c.i64.cast([0,32])).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[82]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[83]=a[0],a})},function(a){return d[83]?d[109]=(d[82].push(c.i64.cast([0,0])),d[82]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[84]=a[0],a})},function(a){return d[84]?d[109]=(d[82].push(c.i64.cast([0,2])),d[82]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[85]=a[0],a})},function(a){return d[85]?d[109]=(d[82].push(c.i64.cast([0,3])),d[82]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[86]=a[0],a})},function(a){return d[86]?d[109]=(d[82].push(c.i64.cast([0,4])),d[82]):0,d[87]=c.i64.of_int32(d[82].length),c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[82],c.i64.sub(d[87],c.i64.cast([0,1]))).then(function(a){return a=a,d[88]=a[0],d[89]=a[1],a})},function(a){return c.forEach(c.filter(c.db.table(168).fetch([[[d[70]]]]),function(a){return c.i64.eq(a.backupId,d[70])&&c.i64.lt(a.authorityLevel,c.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(a){return c.db.table(168).add({backupId:d[70],deviceId:d[71],devicePublicKeyBlob:d[73],devicePrivateKeyBlob:d[72],epochStoragePublicKeyBlob:d[75],epochStoragePrivateKeyBlob:d[74],epochAuthPublicKeyBlob:d[77],epochAuthPrivateKeyBlob:d[76],mailboxRootKeyBlob:d[78],ocmfClientStateBlob:d[79],obliviousValidationTokenBlob:d[81],authorityLevel:c.i64.cast([0,20]),encryptionVersion:d[88],revisionVersion:c.i64.cast([0,1]),backupTenancy:c.i64.cast([0,1])})},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,20]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0,void 0],d[90]=f[0],d[91]=f[1],d[92]=f[2],d[93]=f[3],d[94]=f[4],d[95]=f[5],d[96]=f[6],d[97]=f[7],d[98]=f[8],d[99]=f[9],d[100]=f[10],d[101]=f[11],d[102]=f[12],d[103]=f[13],d[104]=f[14],d[105]=f[15],d[106]=f[16],d[107]=f[17],f):(e=a.item,c.sequence([function(a){return d[114]=e.backupTenancy,d[113]=e.encryptionVersion,d[109]=void 0,c.i64.neq(d[109],void 0)?c.resolve(d[110]=d[109]):c.sequence([function(a){return d[115]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[116]=a[0],a})},function(a){return d[116]?d[125]=(d[115].push(c.i64.cast([0,0])),d[115]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[117]=a[0],a})},function(a){return d[117]?d[125]=(d[115].push(c.i64.cast([0,2])),d[115]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[118]=a[0],a})},function(a){return d[118]?d[125]=(d[115].push(c.i64.cast([0,3])),d[115]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[119]=a[0],a})},function(a){return d[119]?d[125]=(d[115].push(c.i64.cast([0,4])),d[115]):0,d[120]=c.createArray(),d[121]=c.i64.of_int32(d[115].length),c.i64.gt(d[121],c.i64.cast([0,0]))?c.loopAsync(d[121],function(a){return d[125]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[115],d[125]).then(function(a){return a=a,d[126]=a[0],d[127]=a[1],a})},function(a){return d[128]=(d[120].push(d[126]),d[120])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[125]=c.createArray(),d[126]=c.i64.of_int32(d[120].length),c.i64.gt(d[126],c.i64.cast([0,0]))?c.loopAsync(d[126],function(a){return d[128]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[120],d[128]).then(function(a){return a=a,d[129]=a[0],d[130]=a[1],a})},function(a){return d[131]=(d[125].push(c.i64.to_string(d[129])),d[125])}])}):c.resolve()},function(a){return d[127]=d[125].join(","),d[122]=d[127]}])},function(a){return d[120].some(function(a){return c.i64.eq(d[113],a)})?d[123]=d[113]:d[123]=void 0,c.i64.neq(d[123],void 0)?d[124]=d[123]:d[124]=void 0,d[110]=d[124]}])},function(a){return c.i64.neq(d[110],void 0)?d[111]=d[110]:d[111]=c.i64.cast([0,0]),c.i64.neq(d[114],void 0)?d[112]=d[114]:d[112]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[111],d[112],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0,void 0],d[90]=a[0],d[91]=a[1],d[92]=a[2],d[93]=a[3],d[94]=a[4],d[95]=a[5],d[96]=a[6],d[97]=a[7],d[98]=a[8],d[99]=a[9],d[100]=a[10],d[101]=a[11],d[102]=a[12],d[103]=a[13],d[104]=a[14],d[105]=a[15],d[106]=a[16],d[107]=a[17]}]))})},function(a){return a=[d[90],d[91],d[92],d[93],d[94],d[95],d[96],d[97],d[98],d[99],d[100],d[101],d[102],d[103],d[104],d[105],d[106],d[107]],d[52]=a[0],d[53]=a[1],d[54]=a[2],d[55]=a[3],d[56]=a[4],d[57]=a[5],d[58]=a[6],d[59]=a[7],d[60]=a[8],d[61]=a[9],d[62]=a[10],d[63]=a[11],d[64]=a[12],d[65]=a[13],d[66]=a[14],d[67]=a[15],d[68]=a[16],d[69]=a[17],a}])},function(a){return a=[d[52],d[53],d[54],d[55],d[56],d[57],d[58],d[59],d[60],d[61],d[62],d[63],d[64],d[65],d[66],d[67],d[68],d[69]],d[7]=a[0],d[8]=a[1],d[9]=a[2],d[10]=a[3],d[11]=a[4],d[12]=a[5],d[13]=a[6],d[14]=a[7],d[15]=a[8],d[16]=a[9],d[17]=a[10],d[18]=a[11],d[19]=a[12],d[20]=a[13],d[21]=a[14],d[22]=a[15],d[23]=a[16],d[24]=a[17],a}]):c.sequence([function(a){return d[33]=d[5].get("errors"),d[34]=d[5].get("errors"),c.forEach(c.db.table(169).fetch(),function(a){return a["delete"]()})},function(a){return d[35]=c.i64.random(),d[36]=c.i64.random(),c.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,d[37]=a[0],d[38]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,d[39]=a[0],d[40]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateAuthKeyPair.nop")).then(function(a){return a=a,d[41]=a[0],d[42]=a[1],a})},function(a){return c.nativeOperation(b("LSRandom.nop"),c.i64.cast([0,32])).then(function(a){return a=a,d[43]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientInit_v2.nop")).then(function(a){return a=a,d[44]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientInit_v2.nop")).then(function(a){return a=a,d[45]=a[0],a})},function(a){return c.nativeOperation(b("LSRandom.nop"),c.i64.cast([0,32])).then(function(a){return a=a,d[46]=a[0],a})},function(a){return d[47]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[74]=(d[47].push(c.i64.cast([0,0])),d[47]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[74]=(d[47].push(c.i64.cast([0,2])),d[47]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[74]=(d[47].push(c.i64.cast([0,3])),d[47]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[51]=a[0],a})},function(a){return d[51]?d[74]=(d[47].push(c.i64.cast([0,4])),d[47]):0,d[52]=c.i64.of_int32(d[47].length),c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[47],c.i64.sub(d[52],c.i64.cast([0,1]))).then(function(a){return a=a,d[53]=a[0],d[54]=a[1],a})},function(a){return c.forEach(c.filter(c.db.table(168).fetch([[[d[35]]]]),function(a){return c.i64.eq(a.backupId,d[35])&&c.i64.lt(a.authorityLevel,c.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(a){return c.db.table(168).add({backupId:d[35],deviceId:d[36],devicePublicKeyBlob:d[38],devicePrivateKeyBlob:d[37],epochStoragePublicKeyBlob:d[40],epochStoragePrivateKeyBlob:d[39],epochAuthPublicKeyBlob:d[42],epochAuthPrivateKeyBlob:d[41],mailboxRootKeyBlob:d[43],ocmfClientStateBlob:d[44],obliviousValidationTokenBlob:d[46],authorityLevel:c.i64.cast([0,20]),encryptionVersion:d[53],revisionVersion:c.i64.cast([0,1]),backupTenancy:c.i64.cast([0,1])})},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,20]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0,void 0],d[55]=f[0],d[56]=f[1],d[57]=f[2],d[58]=f[3],d[59]=f[4],d[60]=f[5],d[61]=f[6],d[62]=f[7],d[63]=f[8],d[64]=f[9],d[65]=f[10],d[66]=f[11],d[67]=f[12],d[68]=f[13],d[69]=f[14],d[70]=f[15],d[71]=f[16],d[72]=f[17],f):(e=a.item,c.sequence([function(a){return d[79]=e.backupTenancy,d[78]=e.encryptionVersion,d[74]=void 0,c.i64.neq(d[74],void 0)?c.resolve(d[75]=d[74]):c.sequence([function(a){return d[80]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[81]?d[90]=(d[80].push(c.i64.cast([0,0])),d[80]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[82]=a[0],a})},function(a){return d[82]?d[90]=(d[80].push(c.i64.cast([0,2])),d[80]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[83]=a[0],a})},function(a){return d[83]?d[90]=(d[80].push(c.i64.cast([0,3])),d[80]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[84]=a[0],a})},function(a){return d[84]?d[90]=(d[80].push(c.i64.cast([0,4])),d[80]):0,d[85]=c.createArray(),d[86]=c.i64.of_int32(d[80].length),c.i64.gt(d[86],c.i64.cast([0,0]))?c.loopAsync(d[86],function(a){return d[90]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[80],d[90]).then(function(a){return a=a,d[91]=a[0],d[92]=a[1],a})},function(a){return d[93]=(d[85].push(d[91]),d[85])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[90]=c.createArray(),d[91]=c.i64.of_int32(d[85].length),c.i64.gt(d[91],c.i64.cast([0,0]))?c.loopAsync(d[91],function(a){return d[93]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[85],d[93]).then(function(a){return a=a,d[94]=a[0],d[95]=a[1],a})},function(a){return d[96]=(d[90].push(c.i64.to_string(d[94])),d[90])}])}):c.resolve()},function(a){return d[92]=d[90].join(","),d[87]=d[92]}])},function(a){return d[85].some(function(a){return c.i64.eq(d[78],a)})?d[88]=d[78]:d[88]=void 0,c.i64.neq(d[88],void 0)?d[89]=d[88]:d[89]=void 0,d[75]=d[89]}])},function(a){return c.i64.neq(d[75],void 0)?d[76]=d[75]:d[76]=c.i64.cast([0,0]),c.i64.neq(d[79],void 0)?d[77]=d[79]:d[77]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[76],d[77],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0,void 0],d[55]=a[0],d[56]=a[1],d[57]=a[2],d[58]=a[3],d[59]=a[4],d[60]=a[5],d[61]=a[6],d[62]=a[7],d[63]=a[8],d[64]=a[9],d[65]=a[10],d[66]=a[11],d[67]=a[12],d[68]=a[13],d[69]=a[14],d[70]=a[15],d[71]=a[16],d[72]=a[17]}]))})},function(a){return a=[d[55],d[56],d[57],d[58],d[59],d[60],d[61],d[62],d[63],d[64],d[65],d[66],d[67],d[68],d[69],d[70],d[71],d[72]],d[7]=a[0],d[8]=a[1],d[9]=a[2],d[10]=a[3],d[11]=a[4],d[12]=a[5],d[13]=a[6],d[14]=a[7],d[15]=a[8],d[16]=a[9],d[17]=a[10],d[18]=a[11],d[19]=a[12],d[20]=a[13],d[21]=a[14],d[22]=a[15],d[23]=a[16],d[24]=a[17],a}])},function(e){return c.i64.neq(d[7],void 0)?c.sequence([function(e){return c.blobs.neq(d[18],void 0)?c.sequence([function(e){return c.blobs.neq(d[17],void 0)?c.sequence([function(e){return c.blobs.neq(d[19],void 0)?c.sequence([function(e){return c.blobs.neq(d[15],void 0)?c.sequence([function(e){return c.blobs.neq(d[10],void 0)?c.sequence([function(e){return c.blobs.neq(d[9],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[18],c.blob("MA=="),d[19]).then(function(a){return a=a,d[45]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[18],c.blob("MQ=="),d[15]).then(function(a){return a=a,d[46]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),c.i64.to_string(d[7])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[47]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[10],d[48]).then(function(a){return a=a,d[49]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[49]).then(function(a){return a=a,d[50]=a[0],a})},function(b){return d[51]=new c.Map(),d[51].set("optimistic_backup_id",d[7]),d[51].set("device_private_key",d[18]),d[51].set("device_public_key",d[17]),d[51].set("epoch_storage_public_key",d[19]),d[51].set("epoch_storage_public_key_sig",d[45]==null?c.blob("bnVsbA=="):d[45]),d[51].set("epoch_auth_public_key",d[15]),d[51].set("epoch_auth_public_key_sig",d[46]==null?c.blob("bnVsbA=="):d[46]),d[51].set("ocmf_client_state",d[10]),d[51].set("mailbox_partial_id",d[50]==null?"":d[50]),d[51].set("mailbox_root_key",d[9]),d[51].set("device_registration_id",a[0]),d[51].set("orf_client_state_v2",void 0),b=[d[51],void 0],d[43]=b[0],d[44]=b[1]}]):c.resolve((d[45]=new c.Map(),d[45].set("error_code",c.i64.cast([0,9])),d[45].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[45].set("error_message",""),e=[void 0,d[45]],d[43]=e[0],d[44]=e[1]))},function(a){return a=[d[43],d[44]],d[41]=a[0],d[42]=a[1],a}]):c.resolve((d[43]=new c.Map(),d[43].set("error_code",c.i64.cast([0,9])),d[43].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[43].set("error_message",""),e=[void 0,d[43]],d[41]=e[0],d[42]=e[1]))},function(a){return a=[d[41],d[42]],d[39]=a[0],d[40]=a[1],a}]):c.resolve((d[41]=new c.Map(),d[41].set("error_code",c.i64.cast([0,9])),d[41].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[41].set("error_message",""),e=[void 0,d[41]],d[39]=e[0],d[40]=e[1]))},function(a){return a=[d[39],d[40]],d[37]=a[0],d[38]=a[1],a}]):c.resolve((d[39]=new c.Map(),d[39].set("error_code",c.i64.cast([0,9])),d[39].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[39].set("error_message",""),e=[void 0,d[39]],d[37]=e[0],d[38]=e[1]))},function(a){return a=[d[37],d[38]],d[35]=a[0],d[36]=a[1],a}]):c.resolve((d[37]=new c.Map(),d[37].set("error_code",c.i64.cast([0,9])),d[37].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[37].set("error_message",""),e=[void 0,d[37]],d[35]=e[0],d[36]=e[1]))},function(a){return a=[d[35],d[36]],d[33]=a[0],d[34]=a[1],a}]):c.resolve((d[35]=new c.Map(),d[35].set("error_code",c.i64.cast([0,9])),d[35].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[35].set("error_message",""),e=[void 0,d[35]],d[33]=e[0],d[34]=e[1]))},function(a){return a=[d[33],d[34]],d[25]=a[0],d[26]=a[1],a}]):c.resolve((d[33]=new c.Map(),d[33].set("error_code",c.i64.cast([0,9])),d[33].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[33].set("error_message",""),e=[void 0,d[33]],d[25]=e[0],d[26]=e[1]))},function(a){return d[27]=c.i64.of_float(Date.now()),d[28]=c.i64.random(),d[30]="Finishing execution. Execution time: ",d[31]=c.i64.to_string(c.i64.sub(d[27],d[0])),d[32]=" ms",d[29]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][generateInitialDeviceSetupPayload] ",d[29],d[30],d[29],d[31],d[29],d[32]].join("")),c.i64.eq(c.i64.mod_(d[28],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[33]=",",d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"generateInitialDeviceSetupPayload",[d[30],d[33],d[31],d[33],d[32]].join(""),d[34],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[25],d[26]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSGenerateInitialEpochSetupPayload",["LSCreateMinosEpochParams.nop","LSCreateSymmetricEncryptionSecretKey.nop","LSGetNextEpochAnonId.nop","LSLogMebClientEvent.nop","LSStoreEpoch","gkx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(g){return d.sequence([function(f){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][generateInitialEpochSetupPayload] Beginning execution."),e[1]=d.i64.of_float(Date.now()),d.filter(d.db.table(169).fetch(),function(a){return d.i64.eq(a.epochStatus,d.i64.cast([0,1]))&&d.i64.eq(a.authorityLevel,d.i64.cast([0,20]))}).next().then(function(f,g){var h=f.done;f=f.value;return h?d.sequence([function(a){return function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialEpochSetupPayloadStoredProcedure] Generating new initial epoch."),d.nativeOperation(b("LSGetNextEpochAnonId.nop"),void 0).then(function(a){return a=a,e[16]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateSymmetricEncryptionSecretKey.nop")).then(function(a){return a=a,e[17]=a[0],a})},function(a){return c("gkx")("12947")&&c("gkx")("16269")||!1?d.sequence([function(a){return d.nativeOperation(b("LSCreateMinosEpochParams.nop"),e[17],e[16],void 0,void 0,void 0).then(function(a){return a=a,e[20]=a[0],e[21]=a[1],e[22]=a[2],e[23]=a[3],e[24]=a[4],e[25]=a[5],a})},function(a){return e[18]=e[23]}]):d.resolve(e[18]=void 0)},function(c){return e[19]=d.i64.random(),d.storedProcedure(b("LSStoreEpoch"),e[19],a[0],e[16],e[17],d.i64.cast([0,1]),d.i64.cast([0,20]),!1,e[18])},function(a){return a=[e[19],e[16],e[17],void 0,void 0,e[18]],e[2]=a[0],e[3]=a[1],e[4]=a[2],e[5]=a[3],e[6]=a[4],e[7]=a[5],a}]):(g=f.item,function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialEpochSetupPayloadStoredProcedure] Using local optimistic initial epoch."),h=[g.epochId,g.epochAnonIdBlob,g.epochRootKeyBlob,void 0,void 0,g.epochHead],e[2]=h[0],e[3]=h[1],e[4]=h[2],e[5]=h[3],e[6]=h[4],e[7]=h[5])})},function(a){return e[9]=new d.Map(),e[9].set("optimistic_epoch_id",e[2]),e[9].set("epoch_anon_id",e[3]),e[9].set("epoch_root_key",e[4]),e[10]=d.i64.of_float(Date.now()),e[11]=d.i64.random(),e[13]="Finishing execution. Execution time: ",e[14]=d.i64.to_string(d.i64.sub(e[10],e[0])),e[15]=" ms",e[12]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][generateInitialEpochSetupPayload] ",e[12],e[13],e[12],e[14],e[12],e[15]].join("")),d.i64.eq(d.i64.mod_(e[11],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[16]=",",e[17]=d.createArray(),void 0!==void 0?e[18]=(e[17].push(void 0),e[17]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"generateInitialEpochSetupPayload",[e[13],e[16],e[14],e[16],e[15]].join(""),e[17],d.i64.cast([0,4]))):d.resolve()},function(a){return a=[e[9],void 0],f[0]=a[0],f[1]=a[1],a}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsGenerateInitialEpochSetupPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_epochs"];d=a;g["default"]=d}),98);
__d("LSGetOpenEpochKeys",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSDeleteBackupOnClient","LSIsMobileClient","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(b){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] Beginning execution."),d[11]="Querying latest epoch keys with authority level: ",a[0]?d[1]="OPTIMISTIC":d[1]="AUTHORITATIVE",d[2]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ",d[2],d[11],d[2],d[1]].join("")),c.resolve()},function(e){return a[0]?d[3]="OPTIMISTIC":d[3]="AUTHORITATIVE",c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2842]),c.i64.cast([0,2]),void 0,d[3]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]?d[17]=!0:d[17]=!1,d[17]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[19]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[19],d[18],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2844]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]?d[17]=!0:d[17]=!1,d[17]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[19]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[19],d[18],c.i64.cast([0,3]))):c.resolve()}])},function(b){return d[4]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(b){return a[0]||c.i64.eq(b.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[16]=(d[4].push(c.blobs.to_string(a.epochAnonIdBlob)),d[4])})},function(a){return d[5]=c.i64.of_int32(d[4].length),c.i64.gt(d[5],c.i64.cast([0,0]))?c.sequence([function(a){return d[16]=c.i64.of_int32(d[4].length),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2845]),c.i64.cast([0,2]),void 0,c.i64.to_string(d[16])):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[22]=!0:d[22]=!1,d[22]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[24]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[24]].join("")),d[23]=c.createArray(),void 0!==void 0?d[25]=(d[23].push(void 0),d[23]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[24],d[23],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[4],c.i64.cast([0,0])).then(function(a){return a=a,d[17]=a[0],d[18]=a[1],a})},function(a){return d[19]=d[17],d[20]=c.i64.of_int32(d[4].length),c.i64.gt(d[20],c.i64.cast([0,0]))?c.loopAsync(d[20],function(a){return d[21]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[4],d[21]).then(function(a){return a=a,d[22]=a[0],d[23]=a[1],a})},function(a){return c.i64.eq([0,d[19].length],[0,d[22].length])?(d[19]===d[22]?d[25]=d[19]:(d[19]>d[22]?d[26]=d[19]:d[26]=d[22],d[25]=d[26]),d[24]=d[25]):(c.i64.gt([0,d[19].length],[0,d[22].length])?d[25]=d[19]:d[25]=d[22],d[24]=d[25]),d[19]=d[24]}])}):c.resolve()},function(a){return d[6]=d[19]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] Epoch anon ID list is empty."),d[17]="Epoch anon ID list is empty.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ","",d[17]].join("")),d[16]=c.createArray(),void 0!==void 0?d[18]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",d[17],d[16],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2846]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[19]=!0:d[19]=!1,d[19]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[21]].join("")),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[21],d[20],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[6]=void 0}])},function(a){return d[6]!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2863]),c.i64.cast([0,2]),void 0,d[6]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]?d[17]=!0:d[17]=!1,d[17]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[19]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[19],d[18],c.i64.cast([0,3]))):c.resolve()}]):c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2864]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]?d[17]=!0:d[17]=!1,d[17]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[19]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[19],d[18],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[12]=c.blobs.of_string(d[6]),c.blobs.neq(d[12],void 0)?c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2847]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[19]=!0:d[19]=!1,d[19]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[21]].join("")),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[21],d[20],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.filter(c.db.table(169).fetch(),function(a){return c.blobs.eq(a.epochAnonIdBlob,d[12])}).next().then(function(a,e){var f=a.done;a=a.value;return f?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] Found a most recent epoch anon ID, but unable to locate it again in the table. This can really only happen if the tablesomehow changed in the middle of our transaction."),d[19]="Found a most recent epoch anon ID, but unable to locate it again in the table. This can really only happen if the tablesomehow changed in the middle of our transaction.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",d[19],d[18],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2848]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[21]=!0:d[21]=!1,d[21]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[23]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[23]].join("")),d[22]=c.createArray(),void 0!==void 0?d[24]=(d[22].push(void 0),d[22]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[23],d[22],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[16]=void 0}]):(e=a.item,c.sequence([function(a){return d[22]=e.epochAnonIdBlob,d[20]="Using latest epoch: ",d[21]=c.blobs.to_string(d[22]),d[18]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ",d[18],d[20],d[18],d[21]].join("")),c.resolve()},function(a){return d[19]=new c.Map(),d[19].set("epoch_id",e.epochId),d[19].set("epoch_root_key",e.epochRootKeyBlob),d[19].set("epoch_anon_id",d[22]),d[16]=d[19]}]))})},function(a){return d[7]=d[16]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] No epochs whatsoever on client! This should absolutely never happen. Deleting backup from client."),d[17]="No epochs whatsoever on client! This should absolutely never happen. Deleting backup from client.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ","",d[17]].join("")),d[16]=c.createArray(),void 0!==void 0?d[18]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",d[17],d[16],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2843]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[19]=!0:d[19]=!1,d[19]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[21]].join("")),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[21],d[20],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,"get_open_epoch_keys",!0,void 0,"Attempted to fetch epoch keys when there are no epochs on the client.",!1)},function(a){return d[7]=void 0}])},function(a){return d[8]=c.i64.of_float(Date.now()),d[9]=c.i64.random(),d[13]="Finishing execution. Execution time: ",d[14]=c.i64.to_string(c.i64.sub(d[8],d[0])),d[15]=" ms",d[10]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ",d[10],d[13],d[10],d[14],d[10],d[15]].join("")),c.i64.eq(c.i64.mod_(d[9],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[16]=",",d[17]=c.createArray(),void 0!==void 0?d[18]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",[d[13],d[16],d[14],d[16],d[15]].join(""),d[17],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[7]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsGetOpenEpochKeysStoredProcedure";a.__tables__=["secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSHandleCreateVirtualDeviceFailure",["LSAppendDataTraceAddon","LSDeleteBackupOnClient","LSFlushDataTrace.nop","LSIsMobileClient","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] Beginning execution."),c.sequence([function(d){return a[2]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),a[2],c.i64.cast([0,1412]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[7]=a[0],a})},function(a){return d[7]?d[8]=!0:d[8]=!1,d[8]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[10]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[10]].join("")),d[9]=c.createArray(),void 0!==void 0?d[11]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[10],d[9],c.i64.cast([0,3]))):c.resolve()}])},function(e){return a[1]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] Failure when creating virtual device, deleting backup"),d[8]="Failure when creating virtual device, deleting backup",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] ","",d[8]].join("")),d[7]=c.createArray(),void 0!==void 0?d[9]=(d[7].push(void 0),d[7]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",d[8],d[7],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSDeleteBackupOnClient"),a[0],void 0,!1,a[2],void 0,!1)}]):c.sequence([function(e){return d[7]="Failure when creating virtual device",d[7]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] ","",d[7]].join("")),d[8]=c.createArray(),a[2]!==void 0?d[9]=(d[8].push(a[2]),d[8]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",d[7],d[8],c.i64.cast([0,3]))):c.resolve()},function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,3])})}])},function(e){return c.sequence([function(d){return a[2]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),a[2]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[7]=a[0],a})},function(a){return d[7]?d[8]=!0:d[8]=!1,d[8]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[10]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[10]].join("")),d[9]=c.createArray(),void 0!==void 0?d[11]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[10],d[9],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[1]=c.i64.of_float(Date.now()),d[2]=c.i64.random(),d[4]="Finishing execution. Execution time: ",d[5]=c.i64.to_string(c.i64.sub(d[1],d[0])),d[6]=" ms",d[3]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] ",d[3],d[4],d[3],d[5],d[3],d[6]].join("")),c.i64.eq(c.i64.mod_(d[2],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[7]=",",d[8]=c.createArray(),void 0!==void 0?d[9]=(d[8].push(void 0),d[8]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",[d[4],d[7],d[5],d[7],d[6]].join(""),d[8],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure";a.__tables__=["secure_encrypted_backups_recovery_code_status"];e.exports=a}),null);
__d("LSGenerateInitialVirtualDeviceSetupPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignature_v2.nop","LSGetBlobFromString.nop","LSGetOpenEpochKeys","LSGetViewerFBID","LSHandleCreateVirtualDeviceFailure","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop","LSParseRecoveryCode_v2.nop","LSSymmetricEncryptionCreateEncryptedString.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][generateInitialVirtualDeviceSetupPayload] Beginning execution."),d[1]=c.i64.of_float(Date.now()),a[1]!==void 0?c.sequence([function(e){return d[10]=a[1].get("recovery_code"),d[11]=a[1].get("virtual_device_type"),d[12]=a[1].get("cloud_service_account"),d[13]=a[1].get("hsm_pin_normalization_status"),d[14]=a[1].get("security_question_type"),d[15]=a[1].get("trusted_contact_id"),d[16]=c.createArray(),c.storedProcedure(b("LSGetViewerFBID")).then(function(a){return a=a,d[17]=a[0],a})},function(a){return c.nativeOperation(b("LSParseRecoveryCode_v2.nop"),d[10],void 0==null?c.i64.to_string(d[17]):void 0,d[16]).then(function(a){return a=a,d[18]=a[0],d[19]=a[1],a})},function(e){return c.blobs.neq(d[19],void 0)?c.sequence([function(e){return c.blobs.neq(d[18],void 0)?c.sequence([function(a){return c.storedProcedure(b("LSGetOpenEpochKeys"),!0).then(function(a){return a=a,d[24]=a[0],a})},function(e){return d[24]!==void 0?c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!0}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[34]=new c.Map(),d[34].set("error_msg","Expected a nonempty query result"),d[34].set("code",c.i64.cast([0,3])),d[34].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[35]=c.createArray(),d[36]=(d[35].push(d[34]),d[35]),e=[void 0,d[35]],d[27]=e[0],d[28]=e[1]):(b=a.item,d[34]=new c.Map(),d[34].set("backup_id",b.backupId),d[34].set("device_public_key_blob",b.devicePublicKeyBlob),d[34].set("device_private_key_blob",b.devicePrivateKeyBlob),d[34].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[34].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[34].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[34].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[34].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[34].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[34].set("orf_client_state_v2_blob",void 0),d[34].set("orf_v2_authority_level",void 0),d[34].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[34].set("device_id",b.deviceId),d[34].set("backup_tenancy",b.backupTenancy),d[34].set("encryption_version",b.encryptionVersion),d[34].set("revision_version",b.revisionVersion),d[34].set("initialize_restore_result",void 0),d[34].set("device_creation_timestamp_sec",void 0),d[34].set("authority_level",b.authorityLevel),e=[d[34],void 0],d[27]=e[0],d[28]=e[1])})},function(a){return d[30]=new c.Map(),d[30].set("value",d[27]),d[30].set("errors",d[28]),d[31]=d[30].get("value"),d[31]!==void 0?c.sequence([function(a){return d[34]=d[31].get("backup_id"),d[35]=d[31].get("device_public_key_blob"),d[36]=d[31].get("device_private_key_blob"),d[37]=d[31].get("epoch_storage_public_key_blob"),d[38]=d[31].get("epoch_storage_private_key_blob"),d[39]=d[31].get("epoch_auth_public_key_blob"),d[40]=d[31].get("epoch_auth_private_key_blob"),d[41]=d[31].get("mailbox_root_key_blob"),d[42]=d[31].get("ocmf_client_state_blob"),d[43]=d[31].get("orf_client_state_v2_blob"),d[44]=d[31].get("orf_v2_authority_level"),d[45]=d[31].get("oblivious_validation_token_blob"),d[46]=d[31].get("device_id"),d[47]=d[31].get("backup_tenancy"),d[48]=d[31].get("encryption_version"),d[49]=d[31].get("revision_version"),d[50]=d[31].get("initialize_restore_result"),d[51]=d[31].get("device_creation_timestamp_sec"),d[52]=d[31].get("authority_level"),c.i64.neq(d[46],void 0)?c.sequence([function(a){return d[55]=void 0,c.i64.neq(d[55],void 0)?c.resolve(d[56]=d[55]):c.sequence([function(a){return d[107]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[108]=a[0],a})},function(a){return d[108]?d[117]=(d[107].push(c.i64.cast([0,0])),d[107]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[109]=a[0],a})},function(a){return d[109]?d[117]=(d[107].push(c.i64.cast([0,2])),d[107]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[110]=a[0],a})},function(a){return d[110]?d[117]=(d[107].push(c.i64.cast([0,3])),d[107]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[111]=a[0],a})},function(a){return d[111]?d[117]=(d[107].push(c.i64.cast([0,4])),d[107]):0,d[112]=c.createArray(),d[113]=c.i64.of_int32(d[107].length),c.i64.gt(d[113],c.i64.cast([0,0]))?c.loopAsync(d[113],function(a){return d[117]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[107],d[117]).then(function(a){return a=a,d[118]=a[0],d[119]=a[1],a})},function(a){return d[120]=(d[112].push(d[118]),d[112])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[117]=c.createArray(),d[118]=c.i64.of_int32(d[112].length),c.i64.gt(d[118],c.i64.cast([0,0]))?c.loopAsync(d[118],function(a){return d[120]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[112],d[120]).then(function(a){return a=a,d[121]=a[0],d[122]=a[1],a})},function(a){return d[123]=(d[117].push(c.i64.to_string(d[121])),d[117])}])}):c.resolve()},function(a){return d[119]=d[117].join(","),d[114]=d[119]}])},function(a){return d[112].some(function(a){return c.i64.eq(d[48],a)})?d[115]=d[48]:d[115]=void 0,c.i64.neq(d[115],void 0)?d[116]=d[115]:d[116]=void 0,d[56]=d[116]}])},function(a){return c.i64.neq(d[56],void 0)?d[57]=d[56]:d[57]=c.i64.cast([0,0]),c.i64.neq(d[47],void 0)?d[58]=d[47]:d[58]=c.i64.cast([0,1]),c.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,d[59]=a[0],d[60]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,d[61]=a[0],d[62]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[59],c.blob("MA=="),d[62]).then(function(a){return a=a,d[63]=a[0],a})},function(a){return d[64]=d[24].get("epoch_anon_id"),d[65]=d[24].get("epoch_root_key"),d[66]=c.createArray(),d[107]=(d[66].push(c.i64.cast([0,32])),d[66]),c.nativeOperation(b("LSBase64Encode.nop"),d[64]).then(function(a){return a=a,d[67]=a[0],a})},function(a){return d[67]!==void 0?c.sequence([function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blobs.of_string(["epoch_devices","_",d[67]].join("")),void 0,d[65],d[66]).then(function(a){return a=a,d[107]=a[0],a})},function(a){return d[107]?d[108]=!1:d[108]=!0,d[108]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),d[111]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[111]].join("")),d[110]=c.createArray(),void 0!==void 0?d[113]=(d[110].push(void 0),d[110]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[111],d[110],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[112]=a[0],a})},function(a){return d[109]=d[112]}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[107],c.i64.cast([0,0])).then(function(a){return a=a,d[110]=a[0],d[111]=a[1],a})},function(a){return d[109]=d[110]}])},function(a){return d[68]=d[109]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),d[108]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[110]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[108],d[107],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[109]=a[0],a})},function(a){return d[68]=d[109]}])},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),d[68],d[60]).then(function(a){return a=a,d[69]=a[0],a})},function(a){return c.blobs.neq(d[69],void 0)?c.resolve(d[70]=d[69]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] device_epoch_hmac is null!"),d[108]="device_epoch_hmac is null!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[110]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[108],d[107],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[109]=a[0],a})},function(a){return d[70]=d[109]}])},function(a){return d[71]=d[24].get("epoch_root_key"),d[72]=c.createArray(),d[107]=(d[72].push(c.i64.cast([0,18])),d[72]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,d[71],d[72]).then(function(a){return a=a,d[73]=a[0],a})},function(a){return d[73]!==void 0?c.sequence([function(a){return d[107]=c.i64.of_int32(d[73].length),c.i64.ge(d[107],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[73],c.i64.cast([0,0])).then(function(a){return a=a,d[109]=a[0],d[110]=a[1],a})},function(a){return d[108]=d[109]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[110]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[110]].join("")),d[109]=c.createArray(),void 0!==void 0?d[111]=(d[109].push(void 0),d[109]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[110],d[109],c.i64.cast([0,3]))},function(a){return d[108]=void 0}])},function(a){return d[74]=d[108]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[108]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[109]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[108],d[107],c.i64.cast([0,3]))},function(a){return d[74]=void 0}])},function(a){return c.blobs.neq(d[74],void 0)?d[75]=!0:d[75]=!1,d[75]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),d[42]).then(function(a){return a=a,d[76]=a[0],d[77]=a[1],a})},function(a){return c.blobs.neq(void 0,void 0)?c.sequence([function(a){return c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),void 0).then(function(a){return a=a,d[107]=a[0],d[108]=a[1],a})},function(a){return a=[d[76],d[77],d[107],d[108]],d[78]=a[0],d[79]=a[1],d[80]=a[2],d[81]=a[3],a}]):c.resolve((a=[d[76],d[77],void 0,void 0],d[78]=a[0],d[79]=a[1],d[80]=a[2],d[81]=a[3],a))},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[59]).then(function(a){return a=a,d[82]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[19],c.blob("dmlydHVhbF9kZXZpY2U6dmlydHVhbF9kZXZpY2VfcHJpdmF0ZV9rZXk="),d[82]==null?"":d[82]).then(function(a){return a=a,d[83]=a[0],a})},function(a){return d[83]!==void 0?d[84]=d[83]:d[84]="",d[84]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_device_private_key is empty!"),d[108]="encrypted_device_private_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[109]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[108],d[107],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[61]).then(function(a){return a=a,d[85]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[19],c.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),d[85]==null?"":d[85]).then(function(a){return a=a,d[86]=a[0],a})},function(a){return d[86]!==void 0?d[87]=d[86]:d[87]="",d[87]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_storage_private_key is empty!"),d[108]="encrypted_epoch_storage_private_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[109]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[108],d[107],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[78]).then(function(a){return a=a,d[88]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[19],c.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),d[88]==null?"":d[88]).then(function(a){return a=a,d[89]=a[0],a})},function(a){return d[89]!==void 0?d[90]=d[89]:d[90]="",d[90]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_orf_client_state_v1_shape is empty!"),d[108]="encrypted_orf_client_state_v1_shape is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[109]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[108],d[107],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[45]).then(function(a){return a=a,d[91]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[19],c.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),d[91]==null?"":d[91]).then(function(a){return a=a,d[92]=a[0],a})},function(a){return d[92]!==void 0?d[93]=d[92]:d[93]="",d[93]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_oblivious_validation_token is empty!"),d[108]="encrypted_oblivious_validation_token is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[109]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[108],d[107],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[41]).then(function(a){return a=a,d[94]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[19],c.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),d[94]==null?"":d[94]).then(function(a){return a=a,d[95]=a[0],a})},function(a){return d[95]!==void 0?d[96]=d[95]:d[96]="",d[96]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_mailbox_root_key is empty!"),d[108]="encrypted_mailbox_root_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[109]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[108],d[107],c.i64.cast([0,3]))):c.resolve()},function(a){return d[97]=d[24].get("epoch_anon_id"),c.nativeOperation(b("LSBase64Encode.nop"),d[97]).then(function(a){return a=a,d[98]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[19],c.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),d[98]==null?"":d[98]).then(function(a){return a=a,d[99]=a[0],a})},function(a){return d[99]!==void 0?d[100]=d[99]:d[100]="",d[100]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_anon_id is empty!"),d[108]="encrypted_epoch_anon_id is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[109]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[108],d[107],c.i64.cast([0,3]))):c.resolve()},function(a){return d[101]=d[24].get("epoch_root_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[101]).then(function(a){return a=a,d[102]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[19],c.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),d[102]==null?"":d[102]).then(function(a){return a=a,d[103]=a[0],a})},function(a){return d[103]!==void 0?d[104]=d[103]:d[104]="",d[104]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_root_key is empty!"),d[108]="encrypted_epoch_root_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[109]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[108],d[107],c.i64.cast([0,3]))):c.resolve()},function(a){return d[105]=new c.Map(),d[105].set("encrypted_device_private_key",d[84]),d[105].set("encrypted_epoch_storage_private_key",d[87]),d[105].set("encrypted_ocmf_client_state",d[90]),d[105].set("encrypted_orf_client_state_v2",void 0),d[105].set("encrypted_oblivious_validation_token_blob",d[93]),d[105].set("encrypted_mailbox_root_key_blob",d[96]),d[105].set("encrypted_epoch_anon_id",d[100]),d[105].set("encrypted_epoch_root_key",d[104]),d[106]=new c.Map(),d[106].set("virtual_device_public_key",d[60]),d[106].set("virtual_device_id",d[18]),d[106].set("virtual_device_epoch_storage_public_key",d[62]),d[106].set("virtual_device_epoch_storage_public_key_sig",d[63]==null?c.blob("bnVsbA=="):d[63]),d[106].set("device_epoch_hmac",d[70]),d[106].set("epoch_root_key_fingerprint",d[74]),d[106].set("virtual_device_type",d[11]),d[106].set("action_type",c.i64.cast([0,1])),d[106].set("ocmf_rotation_token",d[79]),d[106].set("encrypted_secret_values_payload",d[105]),d[106].set("cloud_service_account",d[12]),d[106].set("hsm_pin_normalization_status",d[13]),d[106].set("security_question_type",d[14]),d[106].set("trusted_contact_id",d[15]),a=[d[106],void 0],d[53]=a[0],d[54]=a[1]}]):c.resolve((d[55]=new c.Map(),d[55].set("error_code",c.i64.cast([0,9])),d[55].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[55].set("error_message",""),a=[void 0,d[55]],d[53]=a[0],d[54]=a[1]))},function(a){return a=[d[53],d[54]],d[32]=a[0],d[33]=a[1],a}]):c.resolve((d[34]=d[30].get("errors"),d[35]=d[30].get("errors"),d[36]=new c.Map(),d[36].set("error_code",c.i64.cast([0,9])),d[36].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[36].set("error_message",""),a=[void 0,d[36]],d[32]=a[0],d[33]=a[1]))},function(a){return a=[d[32],d[33]],d[25]=a[0],d[26]=a[1],a}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Epoch keys are unavailable."),d[28]="Epoch keys are unavailable.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[28]].join("")),d[27]=c.createArray(),void 0!==void 0?d[30]=(d[27].push(void 0),d[27]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[28],d[27],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[29]=new c.Map(),d[29].set("error_code",c.i64.cast([0,11])),d[29].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[29].set("error_message",""),a=[void 0,d[29]],d[25]=a[0],d[26]=a[1]}])},function(a){return a=[d[25],d[26]],d[22]=a[0],d[23]=a[1],a}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),d[25]="Invalid Recovery Code Provided",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[25]].join("")),d[24]=c.createArray(),void 0!==void 0?d[27]=(d[24].push(void 0),d[24]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[25],d[24],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,10])),d[26].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[26].set("error_message",""),a=[void 0,d[26]],d[22]=a[0],d[23]=a[1]}])},function(a){return a=[d[22],d[23]],d[20]=a[0],d[21]=a[1],a}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),d[23]="Invalid Recovery Code Provided",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[23]].join("")),d[22]=c.createArray(),void 0!==void 0?d[25]=(d[22].push(void 0),d[22]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[23],d[22],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[24]=new c.Map(),d[24].set("error_code",c.i64.cast([0,10])),d[24].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[24].set("error_message",""),a=[void 0,d[24]],d[20]=a[0],d[21]=a[1]}])},function(a){return a=[d[20],d[21]],d[2]=a[0],d[3]=a[1],a}]):c.sequence([function(e){return c.db.table(174).fetch([[[c.i64.cast([0,1])]]]).next().then(function(e,f){var g=e.done;e=e.value;return g?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] No recovery code found in recovery code table"),d[14]="No recovery code found in recovery code table",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[14]].join("")),d[13]=c.createArray(),void 0!==void 0?d[16]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[14],d[13],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,501])),d[15].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[15].set("error_message",""),a=[void 0,d[15]],d[10]=a[0],d[11]=a[1]}]):(f=e.item,c.sequence([function(a){return d[13]=c.createArray(),c.storedProcedure(b("LSGetViewerFBID")).then(function(a){return a=a,d[14]=a[0],a})},function(a){return c.nativeOperation(b("LSParseRecoveryCode_v2.nop"),f.recoveryCode,void 0==null?c.i64.to_string(d[14]):void 0,d[13]).then(function(a){return a=a,d[15]=a[0],d[16]=a[1],a})},function(e){return c.blobs.neq(d[16],void 0)?c.sequence([function(e){return c.blobs.neq(d[15],void 0)?c.sequence([function(a){return c.storedProcedure(b("LSGetOpenEpochKeys"),!0).then(function(a){return a=a,d[21]=a[0],a})},function(e){return d[21]!==void 0?c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!0}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(b,e){var a=b.done;b=b.value;return a?(d[31]=new c.Map(),d[31].set("error_msg","Expected a nonempty query result"),d[31].set("code",c.i64.cast([0,3])),d[31].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[32]=c.createArray(),d[33]=(d[32].push(d[31]),d[32]),a=[void 0,d[32]],d[24]=a[0],d[25]=a[1]):(e=b.item,d[31]=new c.Map(),d[31].set("backup_id",e.backupId),d[31].set("device_public_key_blob",e.devicePublicKeyBlob),d[31].set("device_private_key_blob",e.devicePrivateKeyBlob),d[31].set("epoch_storage_public_key_blob",e.epochStoragePublicKeyBlob),d[31].set("epoch_storage_private_key_blob",e.epochStoragePrivateKeyBlob),d[31].set("epoch_auth_public_key_blob",e.epochAuthPublicKeyBlob),d[31].set("epoch_auth_private_key_blob",e.epochAuthPrivateKeyBlob),d[31].set("mailbox_root_key_blob",e.mailboxRootKeyBlob),d[31].set("ocmf_client_state_blob",e.ocmfClientStateBlob),d[31].set("orf_client_state_v2_blob",void 0),d[31].set("orf_v2_authority_level",void 0),d[31].set("oblivious_validation_token_blob",e.obliviousValidationTokenBlob),d[31].set("device_id",e.deviceId),d[31].set("backup_tenancy",e.backupTenancy),d[31].set("encryption_version",e.encryptionVersion),d[31].set("revision_version",e.revisionVersion),d[31].set("initialize_restore_result",void 0),d[31].set("device_creation_timestamp_sec",void 0),d[31].set("authority_level",e.authorityLevel),a=[d[31],void 0],d[24]=a[0],d[25]=a[1])})},function(a){return d[27]=new c.Map(),d[27].set("value",d[24]),d[27].set("errors",d[25]),d[28]=d[27].get("value"),d[28]!==void 0?c.sequence([function(a){return d[31]=d[28].get("backup_id"),d[32]=d[28].get("device_public_key_blob"),d[33]=d[28].get("device_private_key_blob"),d[34]=d[28].get("epoch_storage_public_key_blob"),d[35]=d[28].get("epoch_storage_private_key_blob"),d[36]=d[28].get("epoch_auth_public_key_blob"),d[37]=d[28].get("epoch_auth_private_key_blob"),d[38]=d[28].get("mailbox_root_key_blob"),d[39]=d[28].get("ocmf_client_state_blob"),d[40]=d[28].get("orf_client_state_v2_blob"),d[41]=d[28].get("orf_v2_authority_level"),d[42]=d[28].get("oblivious_validation_token_blob"),d[43]=d[28].get("device_id"),d[44]=d[28].get("backup_tenancy"),d[45]=d[28].get("encryption_version"),d[46]=d[28].get("revision_version"),d[47]=d[28].get("initialize_restore_result"),d[48]=d[28].get("device_creation_timestamp_sec"),d[49]=d[28].get("authority_level"),c.i64.neq(d[43],void 0)?c.sequence([function(a){return d[52]=void 0,c.i64.neq(d[52],void 0)?c.resolve(d[53]=d[52]):c.sequence([function(a){return d[104]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[105]=a[0],a})},function(a){return d[105]?d[114]=(d[104].push(c.i64.cast([0,0])),d[104]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[106]=a[0],a})},function(a){return d[106]?d[114]=(d[104].push(c.i64.cast([0,2])),d[104]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[107]=a[0],a})},function(a){return d[107]?d[114]=(d[104].push(c.i64.cast([0,3])),d[104]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[108]=a[0],a})},function(a){return d[108]?d[114]=(d[104].push(c.i64.cast([0,4])),d[104]):0,d[109]=c.createArray(),d[110]=c.i64.of_int32(d[104].length),c.i64.gt(d[110],c.i64.cast([0,0]))?c.loopAsync(d[110],function(a){return d[114]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[104],d[114]).then(function(a){return a=a,d[115]=a[0],d[116]=a[1],a})},function(a){return d[117]=(d[109].push(d[115]),d[109])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[114]=c.createArray(),d[115]=c.i64.of_int32(d[109].length),c.i64.gt(d[115],c.i64.cast([0,0]))?c.loopAsync(d[115],function(a){return d[117]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[109],d[117]).then(function(a){return a=a,d[118]=a[0],d[119]=a[1],a})},function(a){return d[120]=(d[114].push(c.i64.to_string(d[118])),d[114])}])}):c.resolve()},function(a){return d[116]=d[114].join(","),d[111]=d[116]}])},function(a){return d[109].some(function(a){return c.i64.eq(d[45],a)})?d[112]=d[45]:d[112]=void 0,c.i64.neq(d[112],void 0)?d[113]=d[112]:d[113]=void 0,d[53]=d[113]}])},function(a){return c.i64.neq(d[53],void 0)?d[54]=d[53]:d[54]=c.i64.cast([0,0]),c.i64.neq(d[44],void 0)?d[55]=d[44]:d[55]=c.i64.cast([0,1]),c.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,d[56]=a[0],d[57]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,d[58]=a[0],d[59]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[56],c.blob("MA=="),d[59]).then(function(a){return a=a,d[60]=a[0],a})},function(a){return d[61]=d[21].get("epoch_anon_id"),d[62]=d[21].get("epoch_root_key"),d[63]=c.createArray(),d[104]=(d[63].push(c.i64.cast([0,32])),d[63]),c.nativeOperation(b("LSBase64Encode.nop"),d[61]).then(function(a){return a=a,d[64]=a[0],a})},function(a){return d[64]!==void 0?c.sequence([function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blobs.of_string(["epoch_devices","_",d[64]].join("")),void 0,d[62],d[63]).then(function(a){return a=a,d[104]=a[0],a})},function(a){return d[104]?d[105]=!1:d[105]=!0,d[105]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),d[108]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[108]].join("")),d[107]=c.createArray(),void 0!==void 0?d[110]=(d[107].push(void 0),d[107]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[108],d[107],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[109]=a[0],a})},function(a){return d[106]=d[109]}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[104],c.i64.cast([0,0])).then(function(a){return a=a,d[107]=a[0],d[108]=a[1],a})},function(a){return d[106]=d[107]}])},function(a){return d[65]=d[106]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),d[105]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[107]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[105],d[104],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[106]=a[0],a})},function(a){return d[65]=d[106]}])},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),d[65],d[57]).then(function(a){return a=a,d[66]=a[0],a})},function(a){return c.blobs.neq(d[66],void 0)?c.resolve(d[67]=d[66]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] device_epoch_hmac is null!"),d[105]="device_epoch_hmac is null!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[107]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[105],d[104],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[106]=a[0],a})},function(a){return d[67]=d[106]}])},function(a){return d[68]=d[21].get("epoch_root_key"),d[69]=c.createArray(),d[104]=(d[69].push(c.i64.cast([0,18])),d[69]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,d[68],d[69]).then(function(a){return a=a,d[70]=a[0],a})},function(a){return d[70]!==void 0?c.sequence([function(a){return d[104]=c.i64.of_int32(d[70].length),c.i64.ge(d[104],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[70],c.i64.cast([0,0])).then(function(a){return a=a,d[106]=a[0],d[107]=a[1],a})},function(a){return d[105]=d[106]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[107]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[107]].join("")),d[106]=c.createArray(),void 0!==void 0?d[108]=(d[106].push(void 0),d[106]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[107],d[106],c.i64.cast([0,3]))},function(a){return d[105]=void 0}])},function(a){return d[71]=d[105]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[105]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[106]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[105],d[104],c.i64.cast([0,3]))},function(a){return d[71]=void 0}])},function(a){return c.blobs.neq(d[71],void 0)?d[72]=!0:d[72]=!1,d[72]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),d[39]).then(function(a){return a=a,d[73]=a[0],d[74]=a[1],a})},function(a){return c.blobs.neq(void 0,void 0)?c.sequence([function(a){return c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),void 0).then(function(a){return a=a,d[104]=a[0],d[105]=a[1],a})},function(a){return a=[d[73],d[74],d[104],d[105]],d[75]=a[0],d[76]=a[1],d[77]=a[2],d[78]=a[3],a}]):c.resolve((a=[d[73],d[74],void 0,void 0],d[75]=a[0],d[76]=a[1],d[77]=a[2],d[78]=a[3],a))},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[56]).then(function(a){return a=a,d[79]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[16],c.blob("dmlydHVhbF9kZXZpY2U6dmlydHVhbF9kZXZpY2VfcHJpdmF0ZV9rZXk="),d[79]==null?"":d[79]).then(function(a){return a=a,d[80]=a[0],a})},function(a){return d[80]!==void 0?d[81]=d[80]:d[81]="",d[81]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_device_private_key is empty!"),d[105]="encrypted_device_private_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[106]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[105],d[104],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[58]).then(function(a){return a=a,d[82]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[16],c.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),d[82]==null?"":d[82]).then(function(a){return a=a,d[83]=a[0],a})},function(a){return d[83]!==void 0?d[84]=d[83]:d[84]="",d[84]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_storage_private_key is empty!"),d[105]="encrypted_epoch_storage_private_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[106]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[105],d[104],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[75]).then(function(a){return a=a,d[85]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[16],c.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),d[85]==null?"":d[85]).then(function(a){return a=a,d[86]=a[0],a})},function(a){return d[86]!==void 0?d[87]=d[86]:d[87]="",d[87]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_orf_client_state_v1_shape is empty!"),d[105]="encrypted_orf_client_state_v1_shape is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[106]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[105],d[104],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[42]).then(function(a){return a=a,d[88]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[16],c.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),d[88]==null?"":d[88]).then(function(a){return a=a,d[89]=a[0],a})},function(a){return d[89]!==void 0?d[90]=d[89]:d[90]="",d[90]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_oblivious_validation_token is empty!"),d[105]="encrypted_oblivious_validation_token is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[106]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[105],d[104],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[38]).then(function(a){return a=a,d[91]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[16],c.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),d[91]==null?"":d[91]).then(function(a){return a=a,d[92]=a[0],a})},function(a){return d[92]!==void 0?d[93]=d[92]:d[93]="",d[93]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_mailbox_root_key is empty!"),d[105]="encrypted_mailbox_root_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[106]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[105],d[104],c.i64.cast([0,3]))):c.resolve()},function(a){return d[94]=d[21].get("epoch_anon_id"),c.nativeOperation(b("LSBase64Encode.nop"),d[94]).then(function(a){return a=a,d[95]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[16],c.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),d[95]==null?"":d[95]).then(function(a){return a=a,d[96]=a[0],a})},function(a){return d[96]!==void 0?d[97]=d[96]:d[97]="",d[97]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_anon_id is empty!"),d[105]="encrypted_epoch_anon_id is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[106]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[105],d[104],c.i64.cast([0,3]))):c.resolve()},function(a){return d[98]=d[21].get("epoch_root_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[98]).then(function(a){return a=a,d[99]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[16],c.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),d[99]==null?"":d[99]).then(function(a){return a=a,d[100]=a[0],a})},function(a){return d[100]!==void 0?d[101]=d[100]:d[101]="",d[101]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_root_key is empty!"),d[105]="encrypted_epoch_root_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[106]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[105],d[104],c.i64.cast([0,3]))):c.resolve()},function(a){return d[102]=new c.Map(),d[102].set("encrypted_device_private_key",d[81]),d[102].set("encrypted_epoch_storage_private_key",d[84]),d[102].set("encrypted_ocmf_client_state",d[87]),d[102].set("encrypted_orf_client_state_v2",void 0),d[102].set("encrypted_oblivious_validation_token_blob",d[90]),d[102].set("encrypted_mailbox_root_key_blob",d[93]),d[102].set("encrypted_epoch_anon_id",d[97]),d[102].set("encrypted_epoch_root_key",d[101]),d[103]=new c.Map(),d[103].set("virtual_device_public_key",d[57]),d[103].set("virtual_device_id",d[15]),d[103].set("virtual_device_epoch_storage_public_key",d[59]),d[103].set("virtual_device_epoch_storage_public_key_sig",d[60]==null?c.blob("bnVsbA=="):d[60]),d[103].set("device_epoch_hmac",d[67]),d[103].set("epoch_root_key_fingerprint",d[71]),d[103].set("virtual_device_type",f.virtualDeviceType),d[103].set("action_type",c.i64.cast([0,1])),d[103].set("ocmf_rotation_token",d[76]),d[103].set("encrypted_secret_values_payload",d[102]),d[103].set("cloud_service_account",f.cloudServiceAccount),d[103].set("hsm_pin_normalization_status",f.hsmPinNormalizationStatus),d[103].set("security_question_type",void 0),d[103].set("trusted_contact_id",void 0),a=[d[103],void 0],d[50]=a[0],d[51]=a[1]}]):c.resolve((d[52]=new c.Map(),d[52].set("error_code",c.i64.cast([0,9])),d[52].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[52].set("error_message",""),a=[void 0,d[52]],d[50]=a[0],d[51]=a[1]))},function(a){return a=[d[50],d[51]],d[29]=a[0],d[30]=a[1],a}]):c.resolve((d[31]=d[27].get("errors"),d[32]=d[27].get("errors"),d[33]=new c.Map(),d[33].set("error_code",c.i64.cast([0,9])),d[33].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[33].set("error_message",""),a=[void 0,d[33]],d[29]=a[0],d[30]=a[1]))},function(a){return a=[d[29],d[30]],d[22]=a[0],d[23]=a[1],a}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Epoch keys are unavailable."),d[25]="Epoch keys are unavailable.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[25]].join("")),d[24]=c.createArray(),void 0!==void 0?d[27]=(d[24].push(void 0),d[24]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[25],d[24],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,11])),d[26].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[26].set("error_message",""),a=[void 0,d[26]],d[22]=a[0],d[23]=a[1]}])},function(a){return a=[d[22],d[23]],d[19]=a[0],d[20]=a[1],a}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),d[22]="Invalid Recovery Code Provided",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[22]].join("")),d[21]=c.createArray(),void 0!==void 0?d[24]=(d[21].push(void 0),d[21]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[22],d[21],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[23]=new c.Map(),d[23].set("error_code",c.i64.cast([0,10])),d[23].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[23].set("error_message",""),a=[void 0,d[23]],d[19]=a[0],d[20]=a[1]}])},function(a){return a=[d[19],d[20]],d[17]=a[0],d[18]=a[1],a}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),d[20]="Invalid Recovery Code Provided",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[20]].join("")),d[19]=c.createArray(),void 0!==void 0?d[22]=(d[19].push(void 0),d[19]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[20],d[19],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[21]=new c.Map(),d[21].set("error_code",c.i64.cast([0,10])),d[21].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[21].set("error_message",""),a=[void 0,d[21]],d[17]=a[0],d[18]=a[1]}])},function(a){return a=[d[17],d[18]],d[10]=a[0],d[11]=a[1],a}]))})},function(a){return a=[d[10],d[11]],d[2]=a[0],d[3]=a[1],a}])},function(a){return d[4]=c.i64.of_float(Date.now()),d[5]=c.i64.random(),d[7]="Finishing execution. Execution time: ",d[8]=c.i64.to_string(c.i64.sub(d[4],d[0])),d[9]=" ms",d[6]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][generateInitialVirtualDeviceSetupPayload] ",d[6],d[7],d[6],d[8],d[6],d[9]].join("")),c.i64.eq(c.i64.mod_(d[5],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[10]=",",d[11]=c.createArray(),void 0!==void 0?d[12]=(d[11].push(void 0),d[11]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"generateInitialVirtualDeviceSetupPayload",[d[7],d[10],d[8],d[10],d[9]].join(""),d[11],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[2],d[3]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_generated_recovery_code"];e.exports=a}),null);
__d("LSInitializeBackupV2",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSCreateMinosEpochParams.nop","LSCreateSignature_v2.nop","LSGenerateInitialDeviceSetupPayload","LSGenerateInitialEpochSetupPayload","LSGenerateInitialVirtualDeviceSetupPayload","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","gkx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(g){return d.sequence([function(c){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][initializeBackupV2] Beginning execution."),e[1]=d.i64.of_float(Date.now()),d.storedProcedure(b("LSGenerateInitialDeviceSetupPayload"),a[0]).then(function(a){return a=a,e[2]=a[0],e[3]=a[1],a})},function(c){return e[2]!==void 0?d.sequence([function(a){return e[15]=e[2].get("device_public_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[15]).then(function(a){return a=a,e[16]=a[0],a})},function(a){return e[17]=e[2].get("epoch_storage_public_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[17]).then(function(a){return a=a,e[18]=a[0],a})},function(a){return e[19]=e[2].get("epoch_storage_public_key_sig"),d.nativeOperation(b("LSBase64Encode.nop"),e[19]).then(function(a){return a=a,e[20]=a[0],a})},function(a){return e[21]=e[2].get("epoch_auth_public_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[21]).then(function(a){return a=a,e[22]=a[0],a})},function(a){return e[23]=e[2].get("epoch_auth_public_key_sig"),d.nativeOperation(b("LSBase64Encode.nop"),e[23]).then(function(a){return a=a,e[24]=a[0],a})},function(a){return e[25]=e[2].get("ocmf_client_state"),d.nativeOperation(b("LSBase64Encode.nop"),e[25]).then(function(a){return a=a,e[26]=a[0],a})},function(a){return e[27]=e[2].get("mailbox_root_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[27]).then(function(a){return a=a,e[28]=a[0],a})},function(a){return e[29]=e[2].get("device_private_key"),e[30]=d.createArray(),d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,0])).then(function(a){return a=a,e[31]=a[0],a})},function(a){return e[31]?e[44]=(e[30].push(d.i64.cast([0,0])),e[30]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,2])).then(function(a){return a=a,e[32]=a[0],a})},function(a){return e[32]?e[44]=(e[30].push(d.i64.cast([0,2])),e[30]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,3])).then(function(a){return a=a,e[33]=a[0],a})},function(a){return e[33]?e[44]=(e[30].push(d.i64.cast([0,3])),e[30]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,4])).then(function(a){return a=a,e[34]=a[0],a})},function(a){return e[34]?e[44]=(e[30].push(d.i64.cast([0,4])),e[30]):0,e[35]="",e[36]=d.i64.of_int32(e[30].length),d.i64.gt(e[36],d.i64.cast([0,0]))?d.loopAsync(e[36],function(a){return e[44]=a,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[30],e[44]).then(function(a){return a=a,e[45]=a[0],e[46]=a[1],a})},function(a){return e[35]=[e[35],"_",d.i64.to_string(e[45])].join("")}])}):d.resolve()},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),["supported_versions_",e[35],"revision_version_",d.i64.to_string(d.i64.cast([0,1]))].join("")).then(function(a){return a=a,e[37]=a[0],a})},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[29],d.blob("Mg=="),e[37]).then(function(a){return a=a,e[38]=a[0],a})},function(a){return d.blobs.neq(e[38],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[38]).then(function(a){return a=a,e[44]=a[0],a})},function(a){return e[39]=e[44]}]):d.resolve(e[39]=void 0)},function(b){return e[40]=e[2].get("optimistic_backup_id"),e[41]=e[2].get("mailbox_partial_id"),e[42]=new d.Map(),e[42].set("supported_encryption_versions",e[30]),e[42].set("client_version",d.i64.cast([0,1])),e[42].set("version_sig",e[39]==null?"":e[39]),e[43]=new d.Map(),e[43].set("device_public_key",e[16]==null?"":e[16]),e[43].set("epoch_storage_public_key",e[18]==null?"":e[18]),e[43].set("epoch_storage_public_key_sig",e[20]==null?"":e[20]),e[43].set("epoch_auth_public_key",e[22]==null?"":e[22]),e[43].set("epoch_auth_public_key_sig",e[24]==null?"":e[24]),e[43].set("device_registration_id",a[0]),e[43].set("ocmf_client_state",e[26]==null?"":e[26]),e[43].set("mailbox_partial_id",e[41]),e[43].set("mailbox_root_key",e[28]==null?"":e[28]),e[43].set("encryption_version_data",e[42]),b=[e[43],e[40],!0,d.i64.cast([0,0])],e[4]=b[0],e[5]=b[1],e[6]=b[2],e[7]=b[3]}]):d.resolve((e[3]!==void 0?(e[19]=e[3].get("error_code"),c=[void 0,d.i64.cast([-1,4294967295]),!1,e[19]],e[15]=c[0],e[16]=c[1],e[17]=c[2],e[18]=c[3]):(c=[void 0,d.i64.cast([-1,4294967295]),!1,d.i64.cast([0,12])],e[15]=c[0],e[16]=c[1],e[17]=c[2],e[18]=c[3],c),c=[e[15],e[16],e[17],e[18]],e[4]=c[0],e[5]=c[1],e[6]=c[2],e[7]=c[3]))},function(f){return e[6]?d.sequence([function(f){return e[4]!==void 0?d.sequence([function(a){return d.islc(d.filter(d.db.table(168).fetch(),function(a){return d.i64.eq(a.authorityLevel,d.i64.cast([0,80]))||!0}),0,d.i64.to_float(d.i64.cast([0,1]))).next().then(function(a,b){var c=a.done;a=a.value;return c?(e[25]=new d.Map(),e[25].set("error_msg","Expected a nonempty query result"),e[25].set("code",d.i64.cast([0,3])),e[25].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),e[26]=d.createArray(),e[27]=(e[26].push(e[25]),e[26]),c=[void 0,e[26]],e[16]=c[0],e[17]=c[1]):(b=a.item,e[25]=new d.Map(),e[25].set("backup_id",b.backupId),e[25].set("device_public_key_blob",b.devicePublicKeyBlob),e[25].set("device_private_key_blob",b.devicePrivateKeyBlob),e[25].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),e[25].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),e[25].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),e[25].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),e[25].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),e[25].set("ocmf_client_state_blob",b.ocmfClientStateBlob),e[25].set("orf_client_state_v2_blob",void 0),e[25].set("orf_v2_authority_level",void 0),e[25].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),e[25].set("device_id",b.deviceId),e[25].set("backup_tenancy",b.backupTenancy),e[25].set("encryption_version",b.encryptionVersion),e[25].set("revision_version",b.revisionVersion),e[25].set("initialize_restore_result",void 0),e[25].set("device_creation_timestamp_sec",void 0),e[25].set("authority_level",b.authorityLevel),c=[e[25],void 0],e[16]=c[0],e[17]=c[1])})},function(a){return e[19]=new d.Map(),e[19].set("value",e[16]),e[19].set("errors",e[17]),e[20]=e[19].get("value"),e[20]!==void 0?d.sequence([function(a){return e[25]=e[20].get("backup_id"),e[26]=e[20].get("device_public_key_blob"),e[27]=e[20].get("device_private_key_blob"),e[28]=e[20].get("epoch_storage_public_key_blob"),e[29]=e[20].get("epoch_storage_private_key_blob"),e[30]=e[20].get("epoch_auth_public_key_blob"),e[31]=e[20].get("epoch_auth_private_key_blob"),e[32]=e[20].get("mailbox_root_key_blob"),e[33]=e[20].get("ocmf_client_state_blob"),e[34]=e[20].get("orf_client_state_v2_blob"),e[35]=e[20].get("orf_v2_authority_level"),e[36]=e[20].get("oblivious_validation_token_blob"),e[37]=e[20].get("device_id"),e[38]=e[20].get("backup_tenancy"),e[39]=e[20].get("encryption_version"),e[40]=e[20].get("revision_version"),e[41]=e[20].get("initialize_restore_result"),e[42]=e[20].get("device_creation_timestamp_sec"),e[43]=e[20].get("authority_level"),d.i64.neq(e[37],void 0)?d.sequence([function(a){return e[47]=void 0,d.i64.neq(e[47],void 0)?d.resolve(e[48]=e[47]):d.sequence([function(a){return e[58]=d.createArray(),d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,0])).then(function(a){return a=a,e[59]=a[0],a})},function(a){return e[59]?e[68]=(e[58].push(d.i64.cast([0,0])),e[58]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,2])).then(function(a){return a=a,e[60]=a[0],a})},function(a){return e[60]?e[68]=(e[58].push(d.i64.cast([0,2])),e[58]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,3])).then(function(a){return a=a,e[61]=a[0],a})},function(a){return e[61]?e[68]=(e[58].push(d.i64.cast([0,3])),e[58]):0,d.storedProcedure(b("LSIsEncryptionVersionSecure"),d.i64.cast([0,4])).then(function(a){return a=a,e[62]=a[0],a})},function(a){return e[62]?e[68]=(e[58].push(d.i64.cast([0,4])),e[58]):0,e[63]=d.createArray(),e[64]=d.i64.of_int32(e[58].length),d.i64.gt(e[64],d.i64.cast([0,0]))?d.loopAsync(e[64],function(a){return e[68]=a,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[58],e[68]).then(function(a){return a=a,e[69]=a[0],e[70]=a[1],a})},function(a){return e[71]=(e[63].push(e[69]),e[63])}])}):d.resolve()},function(a){return d.sequence([function(a){return e[68]=d.createArray(),e[69]=d.i64.of_int32(e[63].length),d.i64.gt(e[69],d.i64.cast([0,0]))?d.loopAsync(e[69],function(a){return e[71]=a,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[63],e[71]).then(function(a){return a=a,e[72]=a[0],e[73]=a[1],a})},function(a){return e[74]=(e[68].push(d.i64.to_string(e[72])),e[68])}])}):d.resolve()},function(a){return e[70]=e[68].join(","),e[65]=e[70]}])},function(a){return e[63].some(function(a){return d.i64.eq(e[39],a)})?e[66]=e[39]:e[66]=void 0,d.i64.neq(e[66],void 0)?e[67]=e[66]:e[67]=void 0,e[48]=e[67]}])},function(a){return d.i64.neq(e[48],void 0)?e[49]=e[48]:e[49]=d.i64.cast([0,0]),d.i64.neq(e[38],void 0)?e[50]=e[38]:e[50]=d.i64.cast([0,1]),e[51]=new d.Map(),e[51].set("device_id",e[37]),e[51].set("public_key",e[26]),e[52]=d.createArray(),e[58]=(e[52].push(e[51]),e[52]),d.storedProcedure(b("LSGenerateInitialEpochSetupPayload"),e[25],e[52]).then(function(a){return a=a,e[53]=a[0],e[54]=a[1],a})},function(a){return e[53]!==void 0?d.sequence([function(a){return e[58]=e[53].get("epoch_anon_id"),e[59]=e[53].get("epoch_root_key"),d.blobs.neq(e[59],void 0)?d.sequence([function(a){return e[76]=d.createArray(),e[82]=(e[76].push(d.i64.cast([0,18])),e[76]),d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,e[59],e[76]).then(function(a){return a=a,e[77]=a[0],a})},function(a){return e[77]!==void 0?d.sequence([function(a){return e[82]=d.i64.of_int32(e[77].length),d.i64.ge(e[82],d.i64.cast([0,1]))?d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[77],d.i64.cast([0,0])).then(function(a){return a=a,e[84]=a[0],e[85]=a[1],a})},function(a){return e[83]=e[84]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),e[85]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",e[85]].join("")),e[84]=d.createArray(),void 0!==void 0?e[86]=(e[84].push(void 0),e[84]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",e[85],e[84],d.i64.cast([0,3]))},function(a){return e[83]=void 0}])},function(a){return e[78]=e[83]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),e[83]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",e[83]].join("")),e[82]=d.createArray(),void 0!==void 0?e[84]=(e[82].push(void 0),e[82]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",e[83],e[82],d.i64.cast([0,3]))},function(a){return e[78]=void 0}])},function(a){return d.blobs.neq(e[78],void 0)?e[79]=!0:e[79]=!1,e[79]?0:(function(a){d.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),d["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d.nativeOperation(b("LSBase64Encode.nop"),e[78]).then(function(a){return a=a,e[80]=a[0],a})},function(a){return e[80]!==void 0?e[81]=e[80]:e[81]="encodingfailed",e[60]=e[81]}]):d.resolve(e[60]="null")},function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[52],d.i64.cast([0,0])).then(function(a){return a=a,e[61]=a[0],e[62]=a[1],a})},function(a){return e[63]=e[61].get("public_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[63]).then(function(a){return a=a,e[64]=a[0],a})},function(a){return e[65]=e[61].get("public_key"),e[66]=d.createArray(),e[76]=(e[66].push(d.i64.cast([0,32])),e[66]),d.nativeOperation(b("LSBase64Encode.nop"),e[58]).then(function(a){return a=a,e[67]=a[0],a})},function(a){return e[67]!==void 0?d.sequence([function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blobs.of_string(["epoch_devices","_",e[67]].join("")),void 0,e[59],e[66]).then(function(a){return a=a,e[76]=a[0],a})},function(a){return e[76]?e[77]=!1:e[77]=!0,e[77]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),e[80]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[80]].join("")),e[79]=d.createArray(),void 0!==void 0?e[82]=(e[79].push(void 0),e[79]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[80],e[79],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[81]=a[0],a})},function(a){return e[78]=e[81]}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[76],d.i64.cast([0,0])).then(function(a){return a=a,e[79]=a[0],e[80]=a[1],a})},function(a){return e[78]=e[79]}])},function(a){return e[68]=e[78]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),e[77]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[77]].join("")),e[76]=d.createArray(),void 0!==void 0?e[79]=(e[76].push(void 0),e[76]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[77],e[76],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[78]=a[0],a})},function(a){return e[68]=e[78]}])},function(a){return d.nativeOperation(b("LSHmac_v2.nop"),e[68],e[65]).then(function(a){return a=a,e[69]=a[0],a})},function(a){return c("gkx")("12947")&&c("gkx")("16269")||!1?d.sequence([function(a){return d.nativeOperation(b("LSCreateMinosEpochParams.nop"),e[59],e[58],void 0,void 0,void 0).then(function(a){return a=a,e[76]=a[0],e[77]=a[1],e[78]=a[2],e[79]=a[3],e[80]=a[4],e[81]=a[5],a})},function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[76]).then(function(a){return a=a,e[82]=a[0],a})},function(a){return e[82]!==void 0?e[83]=e[82]:e[83]="",d.nativeOperation(b("LSBase64Encode.nop"),e[78]).then(function(a){return a=a,e[84]=a[0],a})},function(a){return e[84]!==void 0?e[85]=e[84]:e[85]="",d.nativeOperation(b("LSBase64Encode.nop"),e[77]).then(function(a){return a=a,e[86]=a[0],a})},function(a){return e[86]!==void 0?e[87]=e[86]:e[87]="",d.nativeOperation(b("LSBase64Encode.nop"),e[79]).then(function(a){return a=a,e[88]=a[0],a})},function(a){return e[88]!==void 0?e[89]=e[88]:e[89]="",d.blobs.neq(void 0,void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),void 0).then(function(a){return a=a,e[96]=a[0],a})},function(a){return e[96]!==void 0?e[97]=e[96]:e[97]="",e[90]=e[97]}]):d.resolve(e[90]=void 0)},function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[80]).then(function(a){return a=a,e[91]=a[0],a})},function(a){return e[91]!==void 0?e[92]=e[91]:e[92]="",d.blobs.neq(e[81],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[81]).then(function(a){return a=a,e[96]=a[0],a})},function(a){return e[96]!==void 0?e[97]=e[96]:e[97]="",e[93]=e[97]}]):d.resolve(e[93]=void 0)},function(a){return e[94]=new d.Map(),e[94].set("mailbox_encryption_public_key",e[83]),e[94].set("mailbox_auth_public_key",e[85]),e[94].set("mailbox_signing_public_key",e[87]),e[94].set("epoch_head",e[89]),e[94].set("previous_epoch_head",e[90]),e[94].set("self_signature",e[92]),e[94].set("prev_signature",e[93]),e[94]!==void 0?d.resolve(e[95]=e[94]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochUtils] Missing Native Op for MEBMinosCreateMailboxEncryptionKeyPair"),e[97]="Missing Native Op for MEBMinosCreateMailboxEncryptionKeyPair",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochUtils] ","",e[97]].join("")),e[96]=d.createArray(),void 0!==void 0?e[98]=(e[96].push(void 0),e[96]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochUtils",e[97],e[96],d.i64.cast([0,3]))},function(a){return e[95]=void 0}])},function(a){return e[70]=e[95]}]):d.resolve(e[70]=void 0)},function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[58]).then(function(a){return a=a,e[71]=a[0],a})},function(a){return e[72]=e[53].get("optimistic_epoch_id"),d.blobs.neq(e[69],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[69]).then(function(a){return a=a,e[76]=a[0],a})},function(a){return e[73]=e[76]}]):d.resolve(e[73]=void 0)},function(a){return e[74]=new d.Map(),e[74].set("device_pub",e[64]==null?"":e[64]),e[74].set("hmac",e[73]==null?"":e[73]),e[74].set("encrypted_epoch_key",void 0),e[74].set("epoch_root_key_fingerprint",e[60]),e[75]=new d.Map(),e[75].set("epoch_data",""),e[75].set("epoch_anon_id",e[71]==null?"":e[71]),e[75].set("minos_epoch_creation_params",e[70]),e[75].set("optimistic_epoch_id",e[72]),e[75].set("membership",e[74]),a=[e[75],!0,d.i64.cast([0,0])],e[55]=a[0],e[56]=a[1],e[57]=a[2]}]):d.resolve((e[54]!==void 0?(e[61]=e[54].get("error_code"),a=[void 0,!1,e[61]],e[58]=a[0],e[59]=a[1],e[60]=a[2]):(a=[void 0,!1,d.i64.cast([0,14])],e[58]=a[0],e[59]=a[1],e[60]=a[2],a),a=[e[58],e[59],e[60]],e[55]=a[0],e[56]=a[1],e[57]=a[2]))},function(a){return a=[e[55],e[56],e[57]],e[44]=a[0],e[45]=a[1],e[46]=a[2],a}]):d.resolve((a=[void 0,!1,d.i64.cast([0,9])],e[44]=a[0],e[45]=a[1],e[46]=a[2],a))},function(a){return a=[e[44],e[45],e[46]],e[21]=a[0],e[22]=a[1],e[23]=a[2],a}]):d.resolve((e[25]=e[19].get("errors"),e[26]=e[19].get("errors"),a=[void 0,!1,d.i64.cast([0,9])],e[21]=a[0],e[22]=a[1],e[23]=a[2]))},function(c){return e[22]?d.sequence([function(c){return e[21]!==void 0?d.sequence([function(c){return d.storedProcedure(b("LSGenerateInitialVirtualDeviceSetupPayload"),e[5],a[2]).then(function(a){return a=a,e[26]=a[0],e[27]=a[1],a})},function(a){return e[26]!==void 0?d.sequence([function(a){return e[32]=e[26].get("virtual_device_public_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[32]).then(function(a){return a=a,e[33]=a[0],a})},function(a){return e[34]=e[26].get("virtual_device_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[34]).then(function(a){return a=a,e[35]=a[0],a})},function(a){return e[36]=e[26].get("virtual_device_epoch_storage_public_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[36]).then(function(a){return a=a,e[37]=a[0],a})},function(a){return e[38]=e[26].get("virtual_device_epoch_storage_public_key_sig"),d.nativeOperation(b("LSBase64Encode.nop"),e[38]).then(function(a){return a=a,e[39]=a[0],a})},function(a){return e[40]=e[26].get("device_epoch_hmac"),d.nativeOperation(b("LSBase64Encode.nop"),e[40]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return e[42]=e[26].get("epoch_root_key_fingerprint"),d.blobs.neq(e[42],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[42]).then(function(a){return a=a,e[54]=a[0],a})},function(a){return e[43]=e[54]}]):d.resolve(e[43]=void 0)},function(a){return e[44]=e[26].get("ocmf_rotation_token"),d.nativeOperation(b("LSBase64Encode.nop"),e[44]).then(function(a){return a=a,e[45]=a[0],a})},function(a){return e[46]=e[26].get("encrypted_secret_values_payload"),e[47]=e[26].get("virtual_device_type"),e[48]=e[26].get("action_type"),e[49]=e[26].get("cloud_service_account"),e[50]=e[26].get("hsm_pin_normalization_status"),e[51]=e[26].get("security_question_type"),e[52]=e[26].get("trusted_contact_id"),e[53]=new d.Map(),e[53].set("virtual_device_public_key",e[33]==null?"":e[33]),e[53].set("virtual_device_id",e[35]==null?"":e[35]),e[53].set("virtual_device_epoch_storage_public_key",e[37]==null?"":e[37]),e[53].set("virtual_device_epoch_storage_public_key_sig",e[39]==null?"":e[39]),e[53].set("encrypted_secret_values",e[46]),e[53].set("device_epoch_hmac",e[41]==null?"":e[41]),e[53].set("epoch_root_key_fingerprint",e[43]),e[53].set("ocmf_rotation_token",e[45]==null?"":e[45]),e[53].set("virtual_device_type",e[47]),e[53].set("action_type",e[48]),e[53].set("cloud_service_account",e[49]),e[53].set("hsm_pin_normalization_status",e[50]),e[53].set("security_question_type",e[51]),e[53].set("trusted_contact_id",e[52]),a=[e[53],!0,d.i64.cast([0,0])],e[28]=a[0],e[29]=a[1],e[30]=a[2]}]):d.resolve((e[27]!==void 0?(e[35]=e[27].get("error_code"),a=[void 0,!1,e[35]],e[32]=a[0],e[33]=a[1],e[34]=a[2]):(a=[void 0,!1,d.i64.cast([0,16])],e[32]=a[0],e[33]=a[1],e[34]=a[2],a),a=[e[32],e[33],e[34]],e[28]=a[0],e[29]=a[1],e[30]=a[2]))},function(c){return e[29]?d.sequence([function(c){return e[28]!==void 0?d.sequence([function(c){return e[33]=new d.Map(),e[33].set("optimistic_backup_id",e[5]),e[33].set("device_payload",e[4]),e[33].set("epoch_payload",e[21]),e[33].set("virtual_device_payload",e[28]),e[38]=d.i64.cast([0,1e3]),e[34]=e[38],e[35]=new d.Map(),e[35].set("success",e[33]),e[35].set("request_id",a[1]),e[36]=d.toJSON(e[35]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50033]),e[36],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,e[34]).then(function(a){return a=a,e[37]=a[0],a})},function(a){return e[32]=d.i64.cast([0,0])}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Null virtual device payload"),e[34]="Null virtual device payload",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",e[34]].join("")),e[33]=d.createArray(),void 0!==void 0?e[39]=(e[33].push(void 0),e[33]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",e[34],e[33],d.i64.cast([0,3]))},function(c){return e[35]=new d.Map(),e[35].set("error_code",e[30]),e[35].set("error_message","Null virtual device payload"),e[35].set("stored_procedure","initializeBackupV2"),e[36]=new d.Map(),e[36].set("failure",e[35]),e[36].set("request_id",a[1]),e[37]=d.toJSON(e[36]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50033]),e[37],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,d.i64.cast([0,0])).then(function(a){return a=a,e[38]=a[0],a})},function(a){return e[32]=d.i64.cast([0,1])}])},function(a){return e[31]=e[32]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Could not create virtual device payload"),e[33]="Could not create virtual device payload",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",e[33]].join("")),e[32]=d.createArray(),void 0!==void 0?e[38]=(e[32].push(void 0),e[32]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",e[33],e[32],d.i64.cast([0,3]))},function(c){return e[34]=new d.Map(),e[34].set("error_code",e[30]),e[34].set("error_message","Could not create virtual device payload"),e[34].set("stored_procedure","initializeBackupV2"),e[35]=new d.Map(),e[35].set("failure",e[34]),e[35].set("request_id",a[1]),e[36]=d.toJSON(e[35]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50033]),e[36],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,d.i64.cast([0,0])).then(function(a){return a=a,e[37]=a[0],a})},function(a){return e[31]=d.i64.cast([0,1])}])},function(a){return e[25]=e[31]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Null epoch payload"),e[27]="Null epoch payload",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",e[27]].join("")),e[26]=d.createArray(),void 0!==void 0?e[32]=(e[26].push(void 0),e[26]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",e[27],e[26],d.i64.cast([0,3]))},function(c){return e[28]=new d.Map(),e[28].set("error_code",e[23]),e[28].set("error_message","Null epoch payload"),e[28].set("stored_procedure","initializeBackupV2"),e[29]=new d.Map(),e[29].set("failure",e[28]),e[29].set("request_id",a[1]),e[30]=d.toJSON(e[29]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50033]),e[30],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,d.i64.cast([0,0])).then(function(a){return a=a,e[31]=a[0],a})},function(a){return e[25]=d.i64.cast([0,1])}])},function(a){return e[24]=e[25]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Could not create epoch payload"),e[26]="Could not create epoch payload",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",e[26]].join("")),e[25]=d.createArray(),void 0!==void 0?e[31]=(e[25].push(void 0),e[25]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",e[26],e[25],d.i64.cast([0,3]))},function(c){return e[27]=new d.Map(),e[27].set("error_code",e[23]),e[27].set("error_message","Could not create epoch payload"),e[27].set("stored_procedure","initializeBackupV2"),e[28]=new d.Map(),e[28].set("failure",e[27]),e[28].set("request_id",a[1]),e[29]=d.toJSON(e[28]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50033]),e[29],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,d.i64.cast([0,0])).then(function(a){return a=a,e[30]=a[0],a})},function(a){return e[24]=d.i64.cast([0,1])}])},function(a){return e[15]=e[24]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Null device payload"),e[17]="Null device payload",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",e[17]].join("")),e[16]=d.createArray(),void 0!==void 0?e[22]=(e[16].push(void 0),e[16]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",e[17],e[16],d.i64.cast([0,3]))},function(c){return e[18]=new d.Map(),e[18].set("error_code",e[7]),e[18].set("error_message","Null device payload"),e[18].set("stored_procedure","initializeBackupV2"),e[19]=new d.Map(),e[19].set("failure",e[18]),e[19].set("request_id",a[1]),e[20]=d.toJSON(e[19]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50033]),e[20],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,d.i64.cast([0,0])).then(function(a){return a=a,e[21]=a[0],a})},function(a){return e[15]=d.i64.cast([0,1])}])},function(a){return e[8]=e[15]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Could not create device payload"),e[16]="Could not create device payload",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",e[16]].join("")),e[15]=d.createArray(),void 0!==void 0?e[21]=(e[15].push(void 0),e[15]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",e[16],e[15],d.i64.cast([0,3]))},function(c){return e[17]=new d.Map(),e[17].set("error_code",e[7]),e[17].set("error_message","Could not create device payload"),e[17].set("stored_procedure","initializeBackupV2"),e[18]=new d.Map(),e[18].set("failure",e[17]),e[18].set("request_id",a[1]),e[19]=d.toJSON(e[18]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50033]),e[19],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,d.i64.cast([0,0])).then(function(a){return a=a,e[20]=a[0],a})},function(a){return e[8]=d.i64.cast([0,1])}])},function(a){return e[9]=d.i64.of_float(Date.now()),e[10]=d.i64.random(),e[12]="Finishing execution. Execution time: ",e[13]=d.i64.to_string(d.i64.sub(e[9],e[0])),e[14]=" ms",e[11]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][initializeBackupV2] ",e[11],e[12],e[11],e[13],e[11],e[14]].join("")),d.i64.eq(d.i64.mod_(e[10],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[15]=",",e[16]=d.createArray(),void 0!==void 0?e[17]=(e[16].push(void 0),e[16]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"initializeBackupV2",[e[12],e[15],e[13],e[15],e[14]].join(""),e[16],d.i64.cast([0,4]))):d.resolve()},function(a){return f[0]=e[8]}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsInitializeBackupV2StoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];d=a;g["default"]=d}),98);
__d("LSInitializeBackupV2StoredProcedure",["LSInitializeBackupV2","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSInitializeBackupV2"),e.deviceRegistrationId,e.requestId,e.recoveryCodeData);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MWEncryptedBackupsInitializeBackup",["LSFactory","LSInitializeBackupV2StoredProcedure","LSShape"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,g){return a.runInTransaction(function(a){return c("LSInitializeBackupV2StoredProcedure")(c("LSFactory")(a),{deviceRegistrationId:b,recoveryCodeData:g?d("LSShape").ofRecord(g):void 0,requestId:e!=null?e:""})},"readwrite",void 0,void 0,f.id+":28")}g.initializeBackupStoredProcedure=a}),98);
__d("RecoveryCodeDB",["MAWCurrentUser","MAWIndexedDbMetadata","MAWODSProxy","MessengerWebInitData","QPLFlow","WAHex","WALogger","WAOdsEnums","WAResolvable","Worm","WormEAR","WormIDbDriver","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j={persisted_recovery_code:{indexes:{},primaryKey:"pk"}},k=1e4,l=new(d("WAResolvable").Resolvable)();async function m(){var a=d("MAWIndexedDbMetadata").ebRecoveryCodeDBName(d("MAWCurrentUser").getID()),b=d("WAHex").parseHex(c("MessengerWebInitData").accountKeyV2),e={log:function(a){return d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.EB_RECOVERY_CODE_DB,key:a})}},f=c("qpl")._(1056840657,"2716"),g=d("QPLFlow").startQPLFlow(f,{annotations:{string:{dbType:"recovery_code_db",operationType:"initRecoveryCodeDB"}},timeoutInMs:k});try{var m="recovery_code_db";b=new(d("WormEAR").WormEAR)(j,m,b);a=new(d("Worm").WormDatabase)(new(d("WormIDbDriver").WormIDbDriver)(a,m,j,b,e,{onTransactionError:function(a){a instanceof d("WormEAR").DecryptionError&&d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Error decrypting RecoveryCodeDB"])))},safeToDeleteStores:new Set(["migration"])}),f);await a.init({eventFlow:g});g.endSuccess();l.resolve(a)}catch(a){g.endFail("error");d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Error initializing RecoveryCodeDB: ",""])),a);l.reject(a);throw a}}async function a(){l.resolveWasCalled()||await m();return l.promise}g.schema=j;g.getOrCreateRecoveryCodeDB=a}),98);
__d("EBInitializeBackup",["EBAPIQPLPoints","EBDeps","EBLogger","EBMainThreadEBDBApiDeferred","EBSMAPI","I64","LSAuthorityLevel","LSEncryptedBackupsOpStatus","LSIntEnum","MAWTraceUtils","MWEncryptedBackupsDeviceRegistrationId","MWEncryptedBackupsInitializeBackup","Random","RecoveryCodeDB","WAResultOrError","getErrorSafe","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i;async function j(a,b){var e=await d("RecoveryCodeDB").getOrCreateRecoveryCodeDB(),f=d("Random").uint32();await e.runInTransaction(["persisted_recovery_code"],"readwrite",async function(d){var e=await d.stores.persisted_recovery_code.readAll();e=e.filter(function(a){return a.virtualDeviceType===b&&a.authorityLevel===c("LSAuthorityLevel").OPTIMISTIC}).map(function(a){return a.pk});e.length>0&&await d.stores.persisted_recovery_code.bulkDelete(e);await d.stores.persisted_recovery_code.bulkPut([{authorityLevel:c("LSAuthorityLevel").OPTIMISTIC,pk:f,recoveryCode:a,virtualDeviceType:b}])},"EBDB - persist recovery code optimistic")}async function k(a,b){var e=await d("RecoveryCodeDB").getOrCreateRecoveryCodeDB();await e.runInTransaction(["persisted_recovery_code"],"readwrite",async function(d){var e=await d.stores.persisted_recovery_code.readAll();e=e.find(function(d){return d.recoveryCode===a&&d.virtualDeviceType===b&&d.authorityLevel===c("LSAuthorityLevel").OPTIMISTIC});e!=null&&await d.stores.persisted_recovery_code.bulkPut([babelHelpers.extends({},e,{authorityLevel:c("LSAuthorityLevel").AUTHORITATIVE})])},"RecoveryCodeDB - update recovery code to authoritative")}var l=!1,m=new Map();async function a(a,b,e){if(c("justknobx")._("5261")&&l===!0){d("EBLogger").EBLogger().warn("initializeBackup: init in progress");a.endFail(d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_RUNNING);return Promise.resolve(d("WAResultOrError").makeError("init_in_progress"))}l=!0;var f=null;try{if((h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(16))){var g=await c("EBSMAPI").generateRecoveryCode({virtualDeviceType:b});if(g.success===!1){a.endFail("generate_recovery_code_failure");l=!1;return g}g.success===!0&&(f=g.value.recoveryCode,await j(f,16))}}catch(b){g=c("getErrorSafe")(b);a.endFail("auto_eb_init_failed");d("EBLogger").EBLogger().catching(g).mustfix("Auto EB init failed.");l=!1;return Promise.resolve(d("WAResultOrError").makeError("auto_eb_init_failed"))}var n=function(){};g=new Promise(function(b,e){window.setTimeout(function(){n(),d("EBLogger").EBLogger().warn("Init backup failed by timeout"),a.endFail(d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_TIMEOUT),b(d("WAResultOrError").makeError("timed_out"))},c("justknobx")._("4211"))});var o=new Promise(async function(g,j){j=d("MWEncryptedBackupsDeviceRegistrationId").getDeviceRegistrationId();a.addAnnotations({string:{deviceRegistrationId:j}});if(j===""){a.endFail("device_registration_id_null");g(d("WAResultOrError").makeError("device_registration_id_null"));return}a.addPoint(d("EBAPIQPLPoints").EBBackupInitQPLPoints.GET_DB_START);var l=await d("EBDeps").getDeps().getLSDB();a.addPoint(d("EBAPIQPLPoints").EBBackupInitQPLPoints.GET_DB_END);n=l.tables.secure_encrypted_backups_client_state.subscribe(async function(e,j){if(j.operation==="delete"){a.addPoint(d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SUBSCRIPTION_DELETE,{int:{deleteAuthorityLevel:(h||(h=d("I64"))).to_int32(j.prevValue.authorityLevel),deleteBackupId:h.to_int32(j.prevValue.backupId),deleteInputVirtualDeviceType:h.to_int32(b)}});return}e=j.value;var l=e.authorityLevel;e=e.backupId;(h||(h=d("I64"))).equal(l,(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))?(a.addPoint(d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_END),f!=null&&(h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(16))&&await k(f,16),n(),a.addPoint(d("EBAPIQPLPoints").EBBackupInitQPLPoints.FETCH_BACKUP_IDS_START),c("EBSMAPI").fetchBackupIds("EBInitializeBackup").finally(function(){a.addPoint(d("EBAPIQPLPoints").EBBackupInitQPLPoints.FETCH_BACKUP_IDS_END),a.endSuccess(),void d("EBMainThreadEBDBApiDeferred").addNewDevice()}),g(d("WAResultOrError").makeResult(e))):a.addPoint(d("EBAPIQPLPoints").EBBackupInitQPLPoints.OPTIMISTIC_CLIENT_STATE,{int:{ocsAuthorityLevel:(h||(h=d("I64"))).to_int32(l),ocsBackupId:h.to_int32(e),ocsInputVirtualDeviceType:h.to_int32(b)},string:{ocsOperation:j.operation}});return});m.set(a.getQPLAttrs().instanceKey.toString(),{clientStateUnsubscribe:n,qplFlow:a,resolve:g});a.addPoint(d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SPROC_START);l=await d("MWEncryptedBackupsInitializeBackup").initializeBackupStoredProcedure(l,j,d("MAWTraceUtils").stringToTraceId(a.getQPLAttrs().instanceKey.toString()),e);j=l[0];if((h||(h=d("I64"))).equal(j,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE))){a.endFail(d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SPROC_FAIL);g(d("WAResultOrError").makeError("sproc_failure"));return}a.addPoint(d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SPROC_END,{int:{sproc_status:(h||(h=d("I64"))).to_int32(j)}})});return Promise.race([o,g]).then(function(a){return a}).finally(function(){m.delete(a.getQPLAttrs().instanceKey.toString()),l=!1})}function b(a,b){var c=m.get(a);c!=null&&(c.resolve(d("WAResultOrError").makeError("initialize_backup_fail")),c.qplFlow.endFail(d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_FAIL,{string:{errorMsg:b}}),c.clientStateUnsubscribe());m.delete(a)}g.initializeBackup=a;g.resolveInitializeBackupPromiseWithError=b}),98);
__d("EBMinosWasmDeriveAttachmentTokenPrimaryKey",["EBMinosWasmDeriveAttachmentAccessTokenSecret","EBMinosWasmDeriveAttachmentPrimaryKeySecret","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){var b=await d("EBMinosWasmDeriveAttachmentPrimaryKeySecret").deriveAttachmentPrimaryKeySecret({mediaKey:a});if(!b.success)return d("WAResultOrError").makeError("derive-primary-key-secret-error");a=await d("EBMinosWasmDeriveAttachmentAccessTokenSecret").deriveAttachmentAccessTokenSecret({mediaKey:a});return!a.success?d("WAResultOrError").makeError("derive-access-token-secret-error"):d("WAResultOrError").makeResult({accessToken:a.value,primaryKey:b.value})}g.deriveAttachmentTokenPrimaryKeySecret=a}),98);
__d("LSCreateResignCDNUrlPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSBinaryToHex.nop","LSCreateDerivedKeys.nop","LSFindBackup","LSGetBlobFromInt64BE.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","LSOpeEncrypt.nop","LSTruncateSortKey.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return a[10]?c.sequence([function(e){return c.blobs.neq(a[11],void 0)?c.sequence([function(e){return c.i64.neq(a[8],void 0)?c.sequence([function(e){return a[9]!==void 0?c.sequence([function(e){return c.blobs.neq(a[12],void 0)?c.sequence([function(e){return d[10]=c.createArray(),d[19]=(d[10].push(a[9]),d[10]),d[19]=(d[10].push(a[1]),d[10]),d[11]=c.toJSON(d[10]),d[12]=c.createArray(),d[19]=(d[12].push(c.i64.cast([0,32])),d[12]),c.nativeOperation(b("LSGetBlobFromString.nop"),["thread_ope_key","_",a[5]].join("")).then(function(a){return a=a,d[13]=a[0],a})},function(e){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[13],void 0,a[12],d[12]).then(function(a){return a=a,d[14]=a[0],a})},function(a){return d[14]?d[15]=!1:d[15]=!0,d[15]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),d[20]="Got null keys while deriving message list OPE key. Returning null blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoUtils] ","",d[20]].join("")),d[19]=c.createArray(),void 0!==void 0?d[21]=(d[19].push(void 0),d[19]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils",d[20],d[19],c.i64.cast([0,3]))},function(a){return d[16]=void 0}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[14],c.i64.cast([0,0])).then(function(a){return a=a,d[19]=a[0],d[20]=a[1],a})},function(a){return d[16]=d[19]}])},function(e){return c.blobs.neq(d[16],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromInt64BE.nop"),a[6]).then(function(a){return a=a,d[19]=a[0],a})},function(a){return c.nativeOperation(b("LSTruncateSortKey.nop"),d[19]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return c.nativeOperation(b("LSOpeEncrypt.nop"),d[16],d[20],c.i64.cast([0,16])).then(function(a){return a=a,d[21]=a[0],a})},function(a){return c.nativeOperation(b("LSBinaryToHex.nop"),d[21]).then(function(a){return a=a,d[22]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[11]).then(function(a){return a=a,d[23]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[23]).then(function(a){return a=a,d[24]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[24]).then(function(a){return a=a,d[25]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[25]).then(function(a){return a=a,d[26]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[9]).then(function(a){return a=a,d[27]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[27]).then(function(a){return a=a,d[28]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[28]).then(function(a){return a=a,d[29]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[29]).then(function(a){return a=a,d[30]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[31]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[31]).then(function(a){return a=a,d[32]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[32]).then(function(a){return a=a,d[33]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[33]).then(function(a){return a=a,d[34]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[35]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[35]).then(function(a){return a=a,d[36]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[36]).then(function(a){return a=a,d[37]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[37]).then(function(a){return a=a,d[38]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[5]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[39]).then(function(a){return a=a,d[40]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[40]).then(function(a){return a=a,d[41]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[41]).then(function(a){return a=a,d[42]=a[0],a})},function(e){return d[43]=new c.Map(),d[43].set("attachment_index_key",d[26]==null?"":d[26]),d[43].set("backup_ent_fbid",a[0]),d[43].set("delivery_object_id",a[1]),d[43].set("device_id",a[8]),d[43].set("mailbox_partial_id",d[30]==null?"":d[30]),d[43].set("media_type",a[3]),d[43].set("message_partial_id",d[34]==null?"":d[34]),d[43].set("product_type",a[2]),d[43].set("salt_partial_id",d[38]==null?"":d[38]),d[43].set("sort_key",d[22]==null?"":d[22]),d[43].set("thread_partial_id",d[42]==null?"":d[42]),d[43].set("isOpenEB",a[10]===!0),d[44]=new c.Map(),d[44].set("otid",a[4]),d[44].set("server_thread_key",a[7]),d[44].set("timestamp",c.i64.to_string(a[6])),c.nativeOperation(b("LSBase64Encode.nop"),a[11]).then(function(a){return a=a,d[45]=a[0],a})},function(e){return c.nativeOperation(b("LSBase64Encode.nop"),a[12]).then(function(a){return a=a,d[46]=a[0],a})},function(e){return d[47]=new c.Map(),d[47].set("ocmf_client_state_blob",d[45]==null?"":d[45]),d[47].set("mailbox_root_key",d[46]==null?"":d[46]),d[48]=c.createArray(),d[60]=(d[48].push(a[4]),d[48]),d[60]=(d[48].push(a[1]),d[48]),d[49]=c.toJSON(d[48]),d[43].set("raw_identifiers",d[44]),d[43].set("backup_id",a[9]),d[43].set("thread_id",a[5]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[49]).then(function(a){return a=a,d[50]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[50]).then(function(a){return a=a,d[51]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[43].set("salt_partial_access_token",d[53]==null?"":d[53]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[11]).then(function(a){return a=a,d[54]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[54]).then(function(a){return a=a,d[55]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(b){return d[43].set("salt_partial_attachment_index_key",d[57]==null?"":d[57]),d[43].set("raw_tokens",d[47]),a[13]!==void 0?d[43].set("access_token_secret",a[13]):0,a[14]!==void 0?d[43].set("primary_key_secret",a[14]):0,d[58]=c.toJSON(d[43]),d[59]=new c.Map(),d[59].set("payload",d[58]),b=[d[59],void 0],d[17]=b[0],d[18]=b[1]}]):c.resolve((d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,25])),d[19].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[19].set("error_message","OPE key is null for IssueAttachmentRestoreTask"),e=[void 0,d[19]],d[17]=e[0],d[18]=e[1]))},function(a){return a=[d[17],d[18]],d[8]=a[0],d[9]=a[1],a}]):c.resolve((d[10]=new c.Map(),d[10].set("error_code",c.i64.cast([0,20])),d[10].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[10].set("error_message","Missing mailbox_root_key for IssueAttachmentRestoreTask"),e=[void 0,d[10]],d[8]=e[0],d[9]=e[1]))},function(a){return a=[d[8],d[9]],d[6]=a[0],d[7]=a[1],a}]):c.resolve((d[8]=new c.Map(),d[8].set("error_code",c.i64.cast([0,1])),d[8].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[8].set("error_message","Missing backup_id for IssueAttachmentRestoreTask"),e=[void 0,d[8]],d[6]=e[0],d[7]=e[1]))},function(a){return a=[d[6],d[7]],d[4]=a[0],d[5]=a[1],a}]):c.resolve((d[6]=new c.Map(),d[6].set("error_code",c.i64.cast([0,24])),d[6].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[6].set("error_message","Missing device_id for IssueAttachmentRestoreTask"),e=[void 0,d[6]],d[4]=e[0],d[5]=e[1]))},function(a){return a=[d[4],d[5]],d[2]=a[0],d[3]=a[1],a}]):c.resolve((d[4]=new c.Map(),d[4].set("error_code",c.i64.cast([0,22])),d[4].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[4].set("error_message","Missing ocmf_client_state_blob for IssueAttachmentRestoreTask"),e=[void 0,d[4]],d[2]=e[0],d[3]=e[1]))},function(a){return a=[d[2],d[3]],d[0]=a[0],d[1]=a[1],a}]):c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0,void 0],d[2]=f[0],d[3]=f[1],d[4]=f[2],d[5]=f[3],d[6]=f[4],d[7]=f[5],d[8]=f[6],d[9]=f[7],d[10]=f[8],d[11]=f[9],d[12]=f[10],d[13]=f[11],d[14]=f[12],d[15]=f[13],d[16]=f[14],d[17]=f[15],d[18]=f[16],d[19]=f[17],f):(e=a.item,c.sequence([function(a){return d[29]=e.backupTenancy,d[28]=e.encryptionVersion,d[24]=void 0,c.i64.neq(d[24],void 0)?c.resolve(d[25]=d[24]):c.sequence([function(a){return d[30]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[40]=(d[30].push(c.i64.cast([0,0])),d[30]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[32]?d[40]=(d[30].push(c.i64.cast([0,2])),d[30]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[33]=a[0],a})},function(a){return d[33]?d[40]=(d[30].push(c.i64.cast([0,3])),d[30]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[40]=(d[30].push(c.i64.cast([0,4])),d[30]):0,d[35]=c.createArray(),d[36]=c.i64.of_int32(d[30].length),c.i64.gt(d[36],c.i64.cast([0,0]))?c.loopAsync(d[36],function(a){return d[40]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[30],d[40]).then(function(a){return a=a,d[41]=a[0],d[42]=a[1],a})},function(a){return d[43]=(d[35].push(d[41]),d[35])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[40]=c.createArray(),d[41]=c.i64.of_int32(d[35].length),c.i64.gt(d[41],c.i64.cast([0,0]))?c.loopAsync(d[41],function(a){return d[43]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[35],d[43]).then(function(a){return a=a,d[44]=a[0],d[45]=a[1],a})},function(a){return d[46]=(d[40].push(c.i64.to_string(d[44])),d[40])}])}):c.resolve()},function(a){return d[42]=d[40].join(","),d[37]=d[42]}])},function(a){return d[35].some(function(a){return c.i64.eq(d[28],a)})?d[38]=d[28]:d[38]=void 0,c.i64.neq(d[38],void 0)?d[39]=d[38]:d[39]=void 0,d[25]=d[39]}])},function(a){return c.i64.neq(d[25],void 0)?d[26]=d[25]:d[26]=c.i64.cast([0,0]),c.i64.neq(d[29],void 0)?d[27]=d[29]:d[27]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[26],d[27],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0,void 0],d[2]=a[0],d[3]=a[1],d[4]=a[2],d[5]=a[3],d[6]=a[4],d[7]=a[5],d[8]=a[6],d[9]=a[7],d[10]=a[8],d[11]=a[9],d[12]=a[10],d[13]=a[11],d[14]=a[12],d[15]=a[13],d[16]=a[14],d[17]=a[15],d[18]=a[16],d[19]=a[17]}]))})},function(a){return c.storedProcedure(b("LSFindBackup")).then(function(a){return a=a,d[21]=a[0],a})},function(e){return c.blobs.neq(d[5],void 0)?c.sequence([function(e){return c.i64.neq(d[3],void 0)?c.sequence([function(e){return d[21]!==void 0?c.sequence([function(e){return c.blobs.neq(d[4],void 0)?c.sequence([function(e){return d[30]=c.createArray(),d[39]=(d[30].push(d[21]),d[30]),d[39]=(d[30].push(a[1]),d[30]),d[31]=c.toJSON(d[30]),d[32]=c.createArray(),d[39]=(d[32].push(c.i64.cast([0,32])),d[32]),c.nativeOperation(b("LSGetBlobFromString.nop"),["thread_ope_key","_",a[5]].join("")).then(function(a){return a=a,d[33]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[33],void 0,d[4],d[32]).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[35]=!1:d[35]=!0,d[35]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),d[40]="Got null keys while deriving message list OPE key. Returning null blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoUtils] ","",d[40]].join("")),d[39]=c.createArray(),void 0!==void 0?d[41]=(d[39].push(void 0),d[39]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils",d[40],d[39],c.i64.cast([0,3]))},function(a){return d[36]=void 0}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[34],c.i64.cast([0,0])).then(function(a){return a=a,d[39]=a[0],d[40]=a[1],a})},function(a){return d[36]=d[39]}])},function(e){return c.blobs.neq(d[36],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromInt64BE.nop"),a[6]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return c.nativeOperation(b("LSTruncateSortKey.nop"),d[39]).then(function(a){return a=a,d[40]=a[0],a})},function(a){return c.nativeOperation(b("LSOpeEncrypt.nop"),d[36],d[40],c.i64.cast([0,16])).then(function(a){return a=a,d[41]=a[0],a})},function(a){return c.nativeOperation(b("LSBinaryToHex.nop"),d[41]).then(function(a){return a=a,d[42]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[31]).then(function(a){return a=a,d[43]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[43]).then(function(a){return a=a,d[44]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[44]).then(function(a){return a=a,d[45]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[45]).then(function(a){return a=a,d[46]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[21]).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[47]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[48]).then(function(a){return a=a,d[49]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[49]).then(function(a){return a=a,d[50]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[51]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[53]).then(function(a){return a=a,d[54]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[55]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[57]).then(function(a){return a=a,d[58]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[5]).then(function(a){return a=a,d[59]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[59]).then(function(a){return a=a,d[60]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[60]).then(function(a){return a=a,d[61]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[61]).then(function(a){return a=a,d[62]=a[0],a})},function(e){return d[63]=new c.Map(),d[63].set("attachment_index_key",d[46]==null?"":d[46]),d[63].set("backup_ent_fbid",a[0]),d[63].set("delivery_object_id",a[1]),d[63].set("device_id",d[3]),d[63].set("mailbox_partial_id",d[50]==null?"":d[50]),d[63].set("media_type",a[3]),d[63].set("message_partial_id",d[54]==null?"":d[54]),d[63].set("product_type",a[2]),d[63].set("salt_partial_id",d[58]==null?"":d[58]),d[63].set("sort_key",d[42]==null?"":d[42]),d[63].set("thread_partial_id",d[62]==null?"":d[62]),d[63].set("isOpenEB",a[10]===!0),d[64]=new c.Map(),d[64].set("otid",a[4]),d[64].set("server_thread_key",a[7]),d[64].set("timestamp",c.i64.to_string(a[6])),c.nativeOperation(b("LSBase64Encode.nop"),d[5]).then(function(a){return a=a,d[65]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[4]).then(function(a){return a=a,d[66]=a[0],a})},function(e){return d[67]=new c.Map(),d[67].set("ocmf_client_state_blob",d[65]==null?"":d[65]),d[67].set("mailbox_root_key",d[66]==null?"":d[66]),d[68]=c.createArray(),d[80]=(d[68].push(a[4]),d[68]),d[80]=(d[68].push(a[1]),d[68]),d[69]=c.toJSON(d[68]),d[63].set("raw_identifiers",d[64]),d[63].set("backup_id",d[21]),d[63].set("thread_id",a[5]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[69]).then(function(a){return a=a,d[70]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[70]).then(function(a){return a=a,d[71]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[71]).then(function(a){return a=a,d[72]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[72]).then(function(a){return a=a,d[73]=a[0],a})},function(a){return d[63].set("salt_partial_access_token",d[73]==null?"":d[73]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[31]).then(function(a){return a=a,d[74]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[74]).then(function(a){return a=a,d[75]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[75]).then(function(a){return a=a,d[76]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[76]).then(function(a){return a=a,d[77]=a[0],a})},function(b){return d[63].set("salt_partial_attachment_index_key",d[77]==null?"":d[77]),d[63].set("raw_tokens",d[67]),a[13]!==void 0?d[63].set("access_token_secret",a[13]):0,a[14]!==void 0?d[63].set("primary_key_secret",a[14]):0,d[78]=c.toJSON(d[63]),d[79]=new c.Map(),d[79].set("payload",d[78]),b=[d[79],void 0],d[37]=b[0],d[38]=b[1]}]):c.resolve((d[39]=new c.Map(),d[39].set("error_code",c.i64.cast([0,25])),d[39].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[39].set("error_message","OPE key is null for IssueAttachmentRestoreTask"),e=[void 0,d[39]],d[37]=e[0],d[38]=e[1]))},function(a){return a=[d[37],d[38]],d[28]=a[0],d[29]=a[1],a}]):c.resolve((d[30]=new c.Map(),d[30].set("error_code",c.i64.cast([0,20])),d[30].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[30].set("error_message","Missing mailbox_root_key for IssueAttachmentRestoreTask"),e=[void 0,d[30]],d[28]=e[0],d[29]=e[1]))},function(a){return a=[d[28],d[29]],d[26]=a[0],d[27]=a[1],a}]):c.resolve((d[28]=new c.Map(),d[28].set("error_code",c.i64.cast([0,1])),d[28].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[28].set("error_message","Missing backup_id for IssueAttachmentRestoreTask"),e=[void 0,d[28]],d[26]=e[0],d[27]=e[1]))},function(a){return a=[d[26],d[27]],d[24]=a[0],d[25]=a[1],a}]):c.resolve((d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,24])),d[26].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[26].set("error_message","Missing device_id for IssueAttachmentRestoreTask"),e=[void 0,d[26]],d[24]=e[0],d[25]=e[1]))},function(a){return a=[d[24],d[25]],d[22]=a[0],d[23]=a[1],a}]):c.resolve((d[24]=new c.Map(),d[24].set("error_code",c.i64.cast([0,22])),d[24].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[24].set("error_message","Missing ocmf_client_state_blob for IssueAttachmentRestoreTask"),e=[void 0,d[24]],d[22]=e[0],d[23]=e[1]))},function(a){return a=[d[22],d[23]],d[0]=a[0],d[1]=a[1],a}])},function(a){return a=[d[0],d[1]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSCreateResignCDNUrlPayloadStoredProcedure",["LSCreateResignCDNUrlPayload","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSCreateResignCDNUrlPayload"),e.backupEntFbid,e.deliveryObjectId,e.productType,e.mediaType,e.messageId,e.threadId,e.sortOrder,e.serverThreadKey,e.deviceId,e.backupId,e.isOpenEb,e.ocmfClientState,e.mailboxRootKey,e.accessTokenSecret,e.primaryKeySecret);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("EBLSResignCdnUrl",["Base64Utils","EBCreateResignCDNUrlPayload","EBEnqueueResignCdnUrlRequests","EBLS","EBMinosCheckWasmFeatureSupport","EBMinosWasmDeriveAttachmentTokenPrimaryKey","FBLogger","I64","LSCreateResignCDNUrlPayloadStoredProcedure","LSFactory","LSShape","MAWConfig","WAJids","WAResultOrError","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=function(){return c("FBLogger")("wmi").tags(["labyrinth_web","resign_cdn_url"])};e="-8";var x=(v||(v=d("I64"))).of_string(e);async function a(a){var b=a.chatJid,e=a.deliveryObjectId,g=a.externalId,o=a.mediaDownloadFlow,p=a.mediaKey,q=a.mediaType;a=a.sortOrderMs;w().INFO(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL"])));var r=await d("EBMinosCheckWasmFeatureSupport").checkWasFeatureSupportAndGK();o==null||o.addPoint("resign_cdn_url_gql_ebls_start");var s=(await d("EBLS").init()).db;o==null||o.addPoint("resign_cdn_url_gql_ebls_end");var t=null,u=null;if(r){r=await d("EBMinosWasmDeriveAttachmentTokenPrimaryKey").deriveAttachmentTokenPrimaryKeySecret(p);!r.success?w().WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["",""])),r.error):(t=d("Base64Utils").fromArrayBuffer(r.value.accessToken),u=d("Base64Utils").fromArrayBuffer(r.value.primaryKey))}var y={accessTokenSecret:t,backupEntFbid:x,deliveryObjectId:e,mediaType:q,messageId:g,primaryKeySecret:u,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:(v||(v=d("I64"))).of_float(a),threadId:d("WAJids").threadIdForChatJid(b)};o==null||o.addPoint("resign_cdn_url_gql_payload_start");p=[s.runInTransaction(function(a){return c("LSCreateResignCDNUrlPayloadStoredProcedure")(c("LSFactory")(a),y)},"readwrite",void 0,void 0,f.id+":108").then(function(a){var b=a[0];a=a[1];if(b!=null)return d("LSShape").toRecord(b);b=a==null?{}:d("LSShape").toRecord(a);w().MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Failed to create payload. stored procedure: ",", error code: ",", error message: ",""])),b.stored_procedure,b.error_code,b.error_message);return null}).catch(function(a){a=c("getErrorSafe")(a);o==null||o.addPoint("resign_cdn_url_gql_lsdb_payload_fail");w().catching(a).MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Failed to create lsdb payload"])));return null}),d("EBCreateResignCDNUrlPayload").createStringifiedMediaRestorePayloadFromEBDB({accessTokenSecret:t,deliveryObjectId:e,mediaType:q,messageId:g,primaryKeySecret:u,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrderMs:a,threadId:d("WAJids").threadIdForChatJid(b)}).then(function(a){if(a.success)return{payload:a.value};o==null||o.addPoint("resign_cdn_url_gql_ebdb_payload_fail");o==null||o.addAnnotations({string:{payload_fail_error:a.error}});return null}).catch(function(a){a=c("getErrorSafe")(a);w().catching(a).MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Failed to create ebdb payload"])));o==null||o.addAnnotations({string:{payload_fail_error:a.message}});return null})];r=await Promise.all(p);s=r[0];t=r[1];q=s!=null?s:t;s==null&&t!=null&&(o==null||o.addPoint("resign_cdn_url_fallback_to_ebdb"));if(q==null){o==null||o.addPoint("resign_cdn_url_gql_payload_fail");return d("WAResultOrError").makeError("create-payload-failed")}o==null||o.addPoint("resign_cdn_url_gql_payload_end");o==null||o.addPoint("resign_cdn_url_gql_restore_start");g=await d("EBEnqueueResignCdnUrlRequests").enqueueResignCdnUrl(e,q,o);if(!g.success){w().MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",""])),g.error);o==null||o.addPoint("resign_cdn_url_gql_restore_fail");return g}o==null||o.addPoint("resign_cdn_url_gql_restore_end");w().INFO(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL succeeded"])));return d("WAResultOrError").makeResult(g.value)}function y(a,b){var c=[];for(var d in a)a[d]instanceof Object?!(b[d]instanceof Object)?c.push(d):c.push.apply(c,y(a[d],b[d])):a[d]!==b[d]&&c.push(d);return c}async function b(a){var b=a.chatJid,c=a.deliveryObjectId,e=a.externalId,f=a.mediaDownloadFlow,g=a.mediaKey,h=a.mediaType;a=a.sortOrderMs;var i=await d("EBMinosCheckWasmFeatureSupport").checkWasFeatureSupportAndGK(),j=null,k=null;if(i){i=await d("EBMinosWasmDeriveAttachmentTokenPrimaryKey").deriveAttachmentTokenPrimaryKeySecret(g);!i.success?w().WARN(o||(o=babelHelpers.taggedTemplateLiteralLoose(["",""])),i.error):(j=d("Base64Utils").fromArrayBuffer(i.value.accessToken),k=d("Base64Utils").fromArrayBuffer(i.value.primaryKey))}g={accessTokenSecret:j,chatJid:b,deliveryObjectId:c,externalId:e,mediaDownloadFlow:f,mediaType:h,primaryKeySecret:k,sortOrderMs:a};i=await A(g);if(i==null)return z(g);j=await C({deliveryObjectId:c,mediaDownloadFlow:f,payload:i});return!j.success?z(g):j}async function z(a){var b;(b=a.mediaDownloadFlow)==null||b.addPoint("resign_cdn_url_fallback_to_ls");b=await B(a);return b==null?d("WAResultOrError").makeError("create-payload-failed"):C({deliveryObjectId:a.deliveryObjectId,mediaDownloadFlow:a.mediaDownloadFlow,payload:b})}function A(a){var b=a.accessTokenSecret,e=a.chatJid,f=a.deliveryObjectId,g=a.externalId,h=a.mediaDownloadFlow,i=a.mediaType,j=a.primaryKeySecret;a=a.sortOrderMs;h==null||h.addPoint("resign_cdn_url_gql_payload_start");return d("EBCreateResignCDNUrlPayload").createStringifiedMediaRestorePayloadFromEBDB({accessTokenSecret:b,deliveryObjectId:f,mediaType:i,messageId:g,primaryKeySecret:j,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrderMs:a,threadId:d("WAJids").threadIdForChatJid(e)}).then(function(a){if(a.success){h==null||h.addPoint("resign_cdn_url_gql_payload_end");return{payload:a.value}}h==null||h.addAnnotations({string:{payload_fail_error:a.error}});h==null||h.addPoint("resign_cdn_url_gql_payload_fail");return null}).catch(function(a){a=c("getErrorSafe")(a);w().catching(a).MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Failed to create payload"])));h==null||h.addAnnotations({string:{payload_fail_error:a.message}});h==null||h.addPoint("resign_cdn_url_gql_payload_fail");return null})}function B(a){var b=a.accessTokenSecret,e=a.chatJid,g=a.deliveryObjectId,h=a.externalId,i=a.mediaDownloadFlow,j=a.mediaType,k=a.primaryKeySecret,l=a.sortOrderMs;i==null||i.addPoint("resign_cdn_url_gql_payload_start");return d("EBLS").init().then(function(a){return a.db.runInTransaction(function(a){return c("LSCreateResignCDNUrlPayloadStoredProcedure")(c("LSFactory")(a),{accessTokenSecret:b,backupEntFbid:x,deliveryObjectId:g,mediaType:j,messageId:h,primaryKeySecret:k,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:(v||(v=d("I64"))).of_float(l),threadId:d("WAJids").threadIdForChatJid(e)})},"readwrite",void 0,void 0,f.id+":362").then(function(a){var b=a[0];a=a[1];if(b!=null){i==null||i.addPoint("resign_cdn_url_gql_payload_end");return d("LSShape").toRecord(b)}b=a==null?{}:d("LSShape").toRecord(a);w().MUSTFIX(q||(q=babelHelpers.taggedTemplateLiteralLoose(["Failed to create payload. stored procedure: ",", error code: ",", error message: ",""])),b.stored_procedure,b.error_code,b.error_message);i==null||i.addPoint("resign_cdn_url_gql_payload_fail");return null})}).catch(function(a){a=c("getErrorSafe")(a);w().catching(a).MUSTFIX(r||(r=babelHelpers.taggedTemplateLiteralLoose(["Failed to create payload"])));i==null||i.addAnnotations({string:{payload_fail_error:a.message}});i==null||i.addPoint("resign_cdn_url_gql_payload_fail");return null})}function C(a){var b=a.deliveryObjectId,e=a.mediaDownloadFlow;a=a.payload;e==null||e.addPoint("resign_cdn_url_gql_restore_start");return d("EBEnqueueResignCdnUrlRequests").enqueueResignCdnUrl(b,a,e).then(function(a){if(!a.success){w().MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with GraphQL failed: ",""])),a.error);e==null||e.addPoint("resign_cdn_url_gql_restore_fail");return a}e==null||e.addPoint("resign_cdn_url_gql_restore_end");w().INFO(t||(t=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with GraphQL succeeded"])));return a}).catch(function(a){a=c("getErrorSafe")(a);w().catching(a).MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to resign cdn url"])));e==null||e.addAnnotations({string:{resign_cdn_url_gql_restore_error:a.message}});e==null||e.addPoint("resign_cdn_url_gql_restore_fail");return d("WAResultOrError").makeError("resign-cdn-url-runtime-error")})}g.DEPRECATED_eblsResignCdnUrlWithGraphQL=a;g.getPayloadMismatches=y;g.resignCdnUrlUsingEbdb=b}),98);
__d("EBOptOut",["EBAPIQPLPoints","EBDeps","EBSMAPI","ReQL","WAResultOrError","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=c("requireDeferred")("encryptedBackupsOptOutOfBackup").__setRef("EBOptOut");function a(a){var b=a.qplFlow;return new Promise(function(a,e){return void h.load().then(async function(e){b.addPoint("eb_opt_out_get_db_start");var f=await d("EBDeps").getDeps().getLSDB();b.addPoint("eb_opt_out_get_db_end");c("promiseDone")(e.optOutOfBackupStoredProcedure(f),function(e){b.addPoint(d("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_SPROC_END);var g=f.tables.secure_encrypted_backups_client_state.subscribe(function(){c("promiseDone")(d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(f.tables.secure_encrypted_backups_client_state)),function(e){if(e!=null)if(e.length===0)c("promiseDone")(c("EBSMAPI").fetchBackupIds("useEncryptedBackupsOptOutOfBackupDeferred.react").finally(function(){b.addPoint(d("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_TASK_END),b.endSuccess(),g(),a(d("WAResultOrError").makeResult())}));else{b.addPoint(d("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_ROW_EXISTS);return}else b.addPoint(d("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_ROW_NULL),b.endFail("opt_out_backup_row_null"),g(),a(d("WAResultOrError").makeError("EB_OPT_OUT_CLIENT_STATE_NULL"))})})},function(){b.addPoint(d("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_SPROC_FAIL),b.endFail("opt_out_backup_sproc_fail"),a(d("WAResultOrError").makeError("EB_OPT_OUT_SPROC_FAILURE"))})})})}g.ebOptOut=a}),98);
__d("LSFinishAddPeerDevice",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDebugToken.nop","LSCreateDerivedKeys.nop","LSCreateSignature_v2.nop","LSDeleteBackupOnClient","LSGenerateLocalKeys","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] Beginning execution."),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1434]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[8]=a[0],a})},function(a){return d[8]?d[9]=!0:d[9]=!1,d[9]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[11]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[11]].join("")),d[10]=c.createArray(),void 0!==void 0?d[12]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[11],d[10],c.i64.cast([0,3]))):c.resolve()}])},function(e){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(e,f){f=e.done;e=e.value;return f?c.sequence([function(a){return c.db.table(168).fetch().next().then(function(a,d){var e=a.done;a=a.value;return e?0:(d=a.item,c.storedProcedure(b("LSDeleteBackupOnClient"),d.backupId,void 0,!1,void 0,"null",!0))})},function(e){return d[8]=a[0].get("backup_id"),c.storedProcedure(b("LSGenerateLocalKeys"),!1).then(function(a){return a=a,d[9]=a[0],d[10]=a[1],a})},function(e){return d[9]!==void 0?c.sequence([function(a){return d[11]=d[9].get("device_key"),d[12]=d[9].get("epoch_storage_key"),d[13]=d[9].get("epoch_auth_key"),d[14]=d[11].get("device_private_key"),d[15]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]?d[44]=(d[15].push(c.i64.cast([0,0])),d[15]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[17]=a[0],a})},function(a){return d[17]?d[44]=(d[15].push(c.i64.cast([0,2])),d[15]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[44]=(d[15].push(c.i64.cast([0,3])),d[15]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[19]=a[0],a})},function(a){return d[19]?d[44]=(d[15].push(c.i64.cast([0,4])),d[15]):0,d[20]="",d[21]=c.i64.of_int32(d[15].length),c.i64.gt(d[21],c.i64.cast([0,0]))?c.loopAsync(d[21],function(a){return d[44]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[15],d[44]).then(function(a){return a=a,d[45]=a[0],d[46]=a[1],a})},function(a){return d[20]=[d[20],"_",c.i64.to_string(d[45])].join("")}])}):c.resolve()},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),["supported_versions_",d[20],"revision_version_",c.i64.to_string(c.i64.cast([0,1]))].join("")).then(function(a){return a=a,d[22]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[14],c.blob("Mg=="),d[22]).then(function(a){return a=a,d[23]=a[0],a})},function(a){return c.blobs.neq(d[23],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[23]).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[24]=d[44]}]):c.resolve(d[24]=void 0)},function(e){return d[25]=a[0].get("temp_ocmf_client_state"),c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),d[25]).then(function(a){return a=a,d[26]=a[0],d[27]=a[1],a})},function(a){return c.blobs.neq(void 0,void 0)?c.sequence([function(a){return c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),void 0).then(function(a){return a=a,d[44]=a[0],d[45]=a[1],a})},function(a){return a=[d[26],d[27],d[44],d[45]],d[28]=a[0],d[29]=a[1],d[30]=a[2],d[31]=a[3],a}]):c.resolve((a=[d[26],d[27],void 0,void 0],d[28]=a[0],d[29]=a[1],d[30]=a[2],d[31]=a[3],a))},function(b){return d[32]=d[11].get("device_public_key"),d[33]=d[11].get("device_private_key"),d[34]=d[12].get("epoch_storage_public_key"),d[35]=d[12].get("epoch_storage_private_key"),d[36]=d[13].get("epoch_auth_public_key"),d[37]=d[13].get("epoch_auth_private_key"),d[38]=a[0].get("mailbox_root_key"),d[39]=a[0].get("oblivious_validation_token"),c.forEach(c.filter(c.db.table(168).fetch([[[d[8]]]]),function(a){return c.i64.eq(a.backupId,d[8])&&c.i64.lt(a.authorityLevel,c.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(a){return c.db.table(168).add({backupId:d[8],devicePublicKeyBlob:d[32],devicePrivateKeyBlob:d[33],epochStoragePublicKeyBlob:d[34],epochStoragePrivateKeyBlob:d[35],epochAuthPublicKeyBlob:d[36],epochAuthPrivateKeyBlob:d[37],mailboxRootKeyBlob:d[38],ocmfClientStateBlob:d[28],obliviousValidationTokenBlob:d[39],authorityLevel:c.i64.cast([0,20]),backupTenancy:c.i64.cast([0,1]),revisionVersion:c.i64.cast([0,1]),encryptionVersion:c.i64.cast([0,0])})},function(e){return d[40]=a[0].get("add_peer_epoch_data"),d[41]=c.i64.of_int32(d[40].length),c.i64.gt(d[41],c.i64.cast([0,0]))?c.loopAsync(d[41],function(a){return d[44]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[40],d[44]).then(function(a){return a=a,d[45]=a[0],d[46]=a[1],a})},function(a){return d[47]=d[45].get("epoch_id"),d[48]=d[45].get("epoch_anon_id"),d[49]=d[45].get("epoch_root_key"),d[50]=d[45].get("epoch_status"),d[51]=d[45].get("epoch_head"),c.forEach(c.filter(c.db.table(169).fetch([[[d[47]]]]),function(a){return c.i64.eq(a.epochId,d[47])&&c.i64.lt(a.authorityLevel,c.i64.cast([0,80]))}),function(a){return a["delete"]()})},function(a){return c.db.table(169).add({epochId:d[47],authorityLevel:c.i64.cast([0,80]),backupId:d[8],epochAnonIdBlob:d[48],epochRootKeyBlob:d[49],epochStatus:d[50],epochHead:d[51]})}])}):c.resolve()},function(a){return c.count(c.db.table(169).fetch()).then(function(a){return d[42]=a})},function(a){return c.i64.le(d[42],c.i64.cast([0,1]))?c.sequence([function(a){return c.db.table(169).fetch().next().then(function(a,e){var f=a.done;a=a.value;return f?c.sequence([function(a){return d[46]="No epoch available in epochs table",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] ","",d[46]].join("")),d[47]=c.createArray(),void 0!==void 0?d[48]=(d[47].push(void 0),d[47]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure",[d[46]].join(""),d[47],c.i64.cast([0,3]))},function(a){return d[44]=void 0}]):(e=a.item,d[46]=new c.Map(),d[46].set("epoch_id",e.epochId),d[46].set("backup_id",e.backupId),d[46].set("epoch_anon_id_blob",e.epochAnonIdBlob),d[46].set("epoch_root_key_blob",e.epochRootKeyBlob),d[46].set("epoch_status",e.epochStatus),d[46].set("epoch_head",e.epochHead),d[46].set("authority_level",e.authorityLevel),d[44]=d[46])})},function(a){return d[43]=d[44]}]):c.sequence([function(a){return d[44]="Multiple epochs available in epochs table",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] ","",d[44]].join("")),d[45]=c.createArray(),void 0!==void 0?d[46]=(d[45].push(void 0),d[45]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure",[d[44]].join(""),d[45],c.i64.cast([0,3]))},function(a){return d[43]=void 0}])},function(e){return d[43]!==void 0?c.sequence([function(a){return d[44]=d[43].get("epoch_anon_id_blob"),d[45]=d[43].get("epoch_root_key_blob"),d[46]=d[11].get("device_public_key"),d[47]=c.createArray(),d[51]=(d[47].push(c.i64.cast([0,32])),d[47]),c.nativeOperation(b("LSBase64Encode.nop"),d[44]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]!==void 0?c.sequence([function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blobs.of_string(["epoch_devices","_",d[48]].join("")),void 0,d[45],d[47]).then(function(a){return a=a,d[51]=a[0],a})},function(a){return d[51]?d[52]=!1:d[52]=!0,d[52]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),d[55]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[55]].join("")),d[54]=c.createArray(),void 0!==void 0?d[57]=(d[54].push(void 0),d[54]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[55],d[54],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[56]=a[0],a})},function(a){return d[53]=d[56]}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[51],c.i64.cast([0,0])).then(function(a){return a=a,d[54]=a[0],d[55]=a[1],a})},function(a){return d[53]=d[54]}])},function(a){return d[49]=d[53]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),d[52]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[52]].join("")),d[51]=c.createArray(),void 0!==void 0?d[54]=(d[51].push(void 0),d[51]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[52],d[51],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[49]=d[53]}])},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),d[49],d[46]).then(function(a){return a=a,d[50]=a[0],a})},function(e){return c.blobs.neq(d[50],void 0)?c.sequence([function(a){return d[51]=d[11].get("device_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[50]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[54]=d[43].get("epoch_root_key_blob"),c.blobs.neq(d[54],void 0)?c.sequence([function(a){return d[81]=c.createArray(),d[87]=(d[81].push(c.i64.cast([0,18])),d[81]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,d[54],d[81]).then(function(a){return a=a,d[82]=a[0],a})},function(a){return d[82]!==void 0?c.sequence([function(a){return d[87]=c.i64.of_int32(d[82].length),c.i64.ge(d[87],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[82],c.i64.cast([0,0])).then(function(a){return a=a,d[89]=a[0],d[90]=a[1],a})},function(a){return d[88]=d[89]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[90]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[90]].join("")),d[89]=c.createArray(),void 0!==void 0?d[91]=(d[89].push(void 0),d[89]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[90],d[89],c.i64.cast([0,3]))},function(a){return d[88]=void 0}])},function(a){return d[83]=d[88]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[88]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[88]].join("")),d[87]=c.createArray(),void 0!==void 0?d[89]=(d[87].push(void 0),d[87]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[88],d[87],c.i64.cast([0,3]))},function(a){return d[83]=void 0}])},function(a){return c.blobs.neq(d[83],void 0)?d[84]=!0:d[84]=!1,d[84]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.nativeOperation(b("LSBase64Encode.nop"),d[83]).then(function(a){return a=a,d[85]=a[0],a})},function(a){return d[85]!==void 0?d[86]=d[85]:d[86]="encodingfailed",d[55]=d[86]}]):c.resolve(d[55]="null")},function(a){return d[56]=d[12].get("epoch_storage_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(a){return d[58]=d[9].get("epoch_storage_public_key_sig"),c.nativeOperation(b("LSBase64Encode.nop"),d[58]).then(function(a){return a=a,d[59]=a[0],a})},function(a){return d[60]=d[13].get("epoch_auth_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[60]).then(function(a){return a=a,d[61]=a[0],a})},function(a){return d[62]=d[9].get("epoch_auth_public_key_sig"),c.nativeOperation(b("LSBase64Encode.nop"),d[62]).then(function(a){return a=a,d[63]=a[0],a})},function(e){return d[64]=d[11].get("device_private_key"),d[65]=a[0].get("mailbox_root_key"),d[66]=d[12].get("epoch_storage_private_key"),c.blobs.neq(d[65],void 0)?c.sequence([function(a){return d[81]=new c.Map(),c.nativeOperation(b("LSCreateDebugToken.nop"),d[65],"private_key",d[64],c.i64.cast([0,1]),d[81]).then(function(a){return a=a,d[82]=a[0],a})},function(a){return c.blobs.neq(d[82],void 0)?d[83]=d[82]:d[83]=void 0,d[67]=d[83]}]):c.resolve(d[67]=void 0)},function(a){return c.blobs.neq(d[67],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[67]).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[68]=d[81]}]):c.resolve(d[68]=void 0)},function(a){return c.blobs.neq(d[65],void 0)?c.sequence([function(a){return d[81]=new c.Map(),c.nativeOperation(b("LSCreateDebugToken.nop"),d[65],"ocmf_client_state",d[28],c.i64.cast([0,1]),d[81]).then(function(a){return a=a,d[82]=a[0],a})},function(a){return c.blobs.neq(d[82],void 0)?d[83]=d[82]:d[83]=void 0,d[69]=d[83]}]):c.resolve(d[69]=void 0)},function(a){return c.blobs.neq(d[69],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[69]).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[70]=d[81]}]):c.resolve(d[70]=void 0)},function(a){return c.blobs.neq(d[65],void 0)?c.sequence([function(a){return d[81]=new c.Map(),c.nativeOperation(b("LSCreateDebugToken.nop"),d[65],"epoch_storage_private_key",d[66],c.i64.cast([0,1]),d[81]).then(function(a){return a=a,d[82]=a[0],a})},function(a){return c.blobs.neq(d[82],void 0)?d[83]=d[82]:d[83]=void 0,d[71]=d[83]}]):c.resolve(d[71]=void 0)},function(a){return c.blobs.neq(d[71],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[71]).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[72]=d[81]}]):c.resolve(d[72]=void 0)},function(e){return d[73]=a[0].get("backup_id"),c.nativeOperation(b("LSBase64Encode.nop"),d[29]).then(function(a){return a=a,d[74]=a[0],a})},function(e){return d[75]=a[0].get("server_data_id"),d[76]=d[43].get("epoch_id"),d[77]=new c.Map(),d[77].set("supported_encryption_versions",d[15]),d[77].set("client_version",c.i64.cast([0,1])),d[77].set("version_sig",d[24]==null?"":d[24]),d[78]=new c.Map(),d[78].set("backup_id",d[73]),d[78].set("device_epoch_hmac",d[53]==null?"":d[53]),d[78].set("epoch_root_key_fingerprint",d[55]),d[78].set("device_public_key",d[52]==null?"":d[52]),d[78].set("epoch_auth_pubkey",d[61]==null?"":d[61]),d[78].set("epoch_auth_pubkey_sig",d[63]==null?"":d[63]),d[78].set("epoch_storage_pubkey",d[57]==null?"":d[57]),d[78].set("epoch_storage_pubkey_sig",d[59]==null?"":d[59]),d[78].set("ocmf_rotation_token",d[74]==null?"":d[74]),d[78].set("server_data_id",d[75]),d[78].set("device_registration_id",a[1]),d[78].set("base_epoch_id",d[76]),d[78].set("encryption_version_data",d[77]),d[78].set("private_key_debug_token",d[68]),d[78].set("ocmf_client_state_debug_token",d[70]),d[78].set("epoch_storage_pvtkey_debug_token",d[72]),d[78].set("trace_id",void 0),d[78].set("occam_only_eligible",!0),d[79]=c.toJSON(d[78]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",c.i64.cast([0,50017]),d[79],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[80]=a[0],a})}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] $device_epoch_hmac found to be null"),d[51]=c.createArray(),void 0!==void 0?d[52]=(d[51].push(void 0),d[51]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure","$device_epoch_hmac found to be null",d[51],c.i64.cast([0,3]))},function(a){return c.storedProcedure(b("LSDeleteBackupOnClient"),d[8],"backup_init_flow",!0,void 0,void 0,!1)},function(a){return c.forEach(c.db.table(169).fetch(),function(a){return a["delete"]()})}])}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] Error! There should be exactly one open epoch. Deleting local state and terminating device addition"),d[44]=c.createArray(),void 0!==void 0?d[45]=(d[44].push(void 0),d[44]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure","Error! There should be exactly one open epoch. Deleting local state and terminating device addition",d[44],c.i64.cast([0,3]))},function(a){return c.storedProcedure(b("LSDeleteBackupOnClient"),d[8],"backup_init_flow",!0,void 0,void 0,!1)},function(a){return c.forEach(c.db.table(169).fetch(),function(a){return a["delete"]()})}])}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] Error! Error in generating the keys. Deleting local state and terminating device addition"),d[11]=c.createArray(),void 0!==void 0?d[12]=(d[11].push(void 0),d[11]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure","Error! Error in generating the keys. Deleting local state and terminating device addition",d[11],c.i64.cast([0,3]))},function(a){return c.storedProcedure(b("LSDeleteBackupOnClient"),d[8],"backup_init_flow",!0,void 0,void 0,!1)},function(a){return c.forEach(c.db.table(169).fetch(),function(a){return a["delete"]()})}])}]):(e.item,d[8]="An authoritative row already exists, aborting execution of add peer device",d[8]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] ","",d[8]].join("")),d[9]=c.createArray(),void 0!==void 0?d[10]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure",d[8],d[9],c.i64.cast([0,3]))):c.resolve())})},function(a){return d[2]=c.i64.of_float(Date.now()),d[3]=c.i64.random(),d[5]="Finishing execution. Execution time: ",d[6]=c.i64.to_string(c.i64.sub(d[2],d[0])),d[7]=" ms",d[4]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] ",d[4],d[5],d[4],d[6],d[4],d[7]].join("")),c.i64.eq(c.i64.mod_(d[3],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[8]=",",d[9]=c.createArray(),void 0!==void 0?d[10]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure",[d[5],d[8],d[6],d[8],d[7]].join(""),d[9],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSDeserializeSecretsAndAddDevice",["LSArrayGetObjectAt","LSBase64Decode.nop","LSDeserializeFromJsonIntoDictionaryV2.nop","LSFinishAddPeerDevice","LSQplInteractionHelper.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return c.nativeOperation(b("LSQplInteractionHelper.nop"),"MEB_DS_DESERIALIZE_SECRETS_NATIVE_OP_START",c.i64.cast([0,0]),void 0)},function(e){return c.nativeOperation(b("LSDeserializeFromJsonIntoDictionaryV2.nop"),a[0]).then(function(a){return a=a,d[0]=a[0],a})},function(a){return c.nativeOperation(b("LSQplInteractionHelper.nop"),"MEB_DS_DESERIALIZE_SECRETS_NATIVE_OP_END",c.i64.cast([0,0]),void 0)},function(a){return d[1]=d[0].get("temp_ocmf_client_state"),c.nativeOperation(b("LSBase64Decode.nop"),d[1]).then(function(a){return a=a,d[2]=a[0],a})},function(a){return d[3]=d[0].get("mailbox_root_key"),c.nativeOperation(b("LSBase64Decode.nop"),d[3]).then(function(a){return a=a,d[4]=a[0],a})},function(a){return d[5]=d[0].get("oblivious_validation_token"),c.nativeOperation(b("LSBase64Decode.nop"),d[5]).then(function(a){return a=a,d[6]=a[0],a})},function(a){return d[7]=c.createArray(),d[8]=d[0].get("add_peer_epoch_data_serializable"),d[9]=c.i64.of_int32(d[8].length),c.i64.gt(d[9],c.i64.cast([0,0]))?c.loopAsync(d[9],function(a){return d[14]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[8],d[14]).then(function(a){return a=a,d[15]=a[0],d[16]=a[1],a})},function(a){return d[17]=d[15].get("epoch_anon_id"),c.nativeOperation(b("LSBase64Decode.nop"),d[17]).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[19]=d[15].get("epoch_root_key"),c.nativeOperation(b("LSBase64Decode.nop"),d[19]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[21]=d[15].get("epoch_id"),d[22]=d[15].get("epoch_status"),d[23]=new c.Map(),d[23].set("epoch_id",d[21]),d[23].set("epoch_anon_id",d[18]==null?c.blob(""):d[18]),d[23].set("epoch_root_key",d[20]==null?c.blob(""):d[20]),d[23].set("epoch_status",d[22]),d[24]=d[15].get("epoch_head"),d[24]!==void 0?c.sequence([function(a){return c.nativeOperation(b("LSBase64Decode.nop"),d[24]).then(function(a){return a=a,d[25]=a[0],a})},function(a){return d[23].set("epoch_head",d[25])}]):c.resolve()},function(a){return d[25]=(d[7].push(d[23]),d[7])}])}):c.resolve()},function(e){return d[10]=d[0].get("backup_id"),d[11]=d[0].get("server_data_id"),d[12]=new c.Map(),d[12].set("backup_id",d[10]),d[12].set("server_data_id",d[11]),d[12].set("temp_ocmf_client_state",d[2]==null?c.blob(""):d[2]),d[12].set("mailbox_root_key",d[4]==null?c.blob(""):d[4]),d[12].set("oblivious_validation_token",d[6]==null?c.blob(""):d[6]),d[12].set("add_peer_epoch_data",d[7]),d[12]!==void 0?c.sequence([function(e){return c.storedProcedure(b("LSFinishAddPeerDevice"),d[12],a[1])},function(a){return d[13]=!0}]):c.resolve(d[13]=!1)},function(a){return e[0]=d[13]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDeserializeSecretsAndAddDeviceStoredProcedure";a.__tables__=[];e.exports=a}),null);
__d("LSDeserializeSecretsAndAddDeviceStoredProcedure",["LSDeserializeSecretsAndAddDevice","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSDeserializeSecretsAndAddDevice"),e.serializedPayload,e.deviceRegistrationId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("EBOtcAddDevice",["EBAPIQPLPoints","EBDeps","EBLogger","EBMainThreadEBDBApiDeferred","I64","LSDeserializeSecretsAndAddDeviceStoredProcedure","LSEncryptedBackupsRecoveryCodeStatus","LSFactory","LSIntEnum","ReQL","WAGetSafeQPLError","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i;async function a(a){var b=a.initiatorId,e=a.qplFlow,f=a.secrets,g=function(){};e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_WAIT_FOR_EBLS_START);var k=await d("EBDeps").getDeps().getLSDB();e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_WAIT_FOR_EBLS_END);e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SPROC_START);return new Promise(function(a,l){return k.runInTransaction(function(a){return c("LSDeserializeSecretsAndAddDeviceStoredProcedure")(c("LSFactory")(a),{deviceRegistrationId:b,serializedPayload:f})},"readwrite").then(function(b){b=b[0];e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SPROC_END);if(!b){e.endFail(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SPROC_FAILURE);return a(j("OTC_ADD_DEVICE_SPROC_FAILURE"))}g=d("ReQL").fromTableAscending(k.tables.secure_encrypted_backups_recovery_code_status).subscribe(function(b,f){if(f.operation==="add"||f.operation==="put"){g();b=f.value.recoveryCodeStatus;if((h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsRecoveryCodeStatus").VALID)))e.addPoint(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SUCCESS),e.endSuccess(),void d("EBMainThreadEBDBApiDeferred").addNewDevice(),a(j("SUCCESS"));else if((h||(h=d("I64"))).equal(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsRecoveryCodeStatus").SYSTEM_ERROR)))e.endFail(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SYSTEM_ERROR),d("EBLogger").EBLogger().mustfix("PAKE: LSEncryptedBackupsFinishAddPeerDeviceTask task failed"),a(j("OTC_ADD_DEVICE_SYSTEM_ERROR"));else{f="PAKE: Unexpected recovery code status: "+(h||(h=d("I64"))).to_int32(b);e.endFail(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_UNEXPECTED_RECOVERY_CODE_STATUS,{string:{errorMessage:f}});d("EBLogger").EBLogger("wmi_eb").mustfix(f);a(j("OTC_ADD_DEVICE_UNEXPECTED_RECOVERY_CODE_STATUS",f))}}})}).catch(function(b){g(),a(j("OTC_ADD_DEVICE_SPROC_ERROR",d("WAGetSafeQPLError").getSafeQPLErrorMessage(b)))})})}function j(a,b){if(a==="SUCCESS")return d("WAResultOrError").makeResult();else return d("WAResultOrError").makeError({errorMessage:b,status:a})}g.otcAddDevice=a}),98);
__d("LSSyncEpochs",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] Beginning execution."),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1436]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[13]=a[0],a})},function(a){return d[13]?d[14]=!0:d[14]=!1,d[14]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[16]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[16]].join("")),d[15]=c.createArray(),void 0!==void 0?d[17]=(d[15].push(void 0),d[15]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[16],d[15],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[13]=new c.Map(),d[13].set("error_msg","Expected a nonempty query result"),d[13].set("code",c.i64.cast([0,3])),d[13].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[14]=c.createArray(),d[15]=(d[14].push(d[13]),d[14]),e=[void 0,d[14]],d[1]=e[0],d[2]=e[1]):(b=a.item,d[13]=new c.Map(),d[13].set("backup_id",b.backupId),d[13].set("device_public_key_blob",b.devicePublicKeyBlob),d[13].set("device_private_key_blob",b.devicePrivateKeyBlob),d[13].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[13].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[13].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[13].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[13].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[13].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[13].set("orf_client_state_v2_blob",void 0),d[13].set("orf_v2_authority_level",void 0),d[13].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[13].set("device_id",b.deviceId),d[13].set("backup_tenancy",b.backupTenancy),d[13].set("encryption_version",b.encryptionVersion),d[13].set("revision_version",b.revisionVersion),d[13].set("initialize_restore_result",void 0),d[13].set("device_creation_timestamp_sec",void 0),d[13].set("authority_level",b.authorityLevel),e=[d[13],void 0],d[1]=e[0],d[2]=e[1])})},function(a){return d[4]=new c.Map(),d[4].set("value",d[1]),d[4].set("errors",d[2]),d[5]=d[4].get("value"),d[5]!==void 0?c.sequence([function(a){return d[13]=d[5].get("backup_id"),d[14]=d[5].get("device_public_key_blob"),d[15]=d[5].get("device_private_key_blob"),d[16]=d[5].get("epoch_storage_public_key_blob"),d[17]=d[5].get("epoch_storage_private_key_blob"),d[18]=d[5].get("epoch_auth_public_key_blob"),d[19]=d[5].get("epoch_auth_private_key_blob"),d[20]=d[5].get("mailbox_root_key_blob"),d[21]=d[5].get("ocmf_client_state_blob"),d[22]=d[5].get("orf_client_state_v2_blob"),d[23]=d[5].get("orf_v2_authority_level"),d[24]=d[5].get("oblivious_validation_token_blob"),d[25]=d[5].get("device_id"),d[26]=d[5].get("backup_tenancy"),d[27]=d[5].get("encryption_version"),d[28]=d[5].get("revision_version"),d[29]=d[5].get("initialize_restore_result"),d[30]=d[5].get("device_creation_timestamp_sec"),d[31]=d[5].get("authority_level"),c.i64.neq(d[25],void 0)?c.sequence([function(a){return d[33]=void 0,c.i64.neq(d[33],void 0)?c.resolve(d[34]=d[33]):c.sequence([function(a){return d[41]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[42]=a[0],a})},function(a){return d[42]?d[51]=(d[41].push(c.i64.cast([0,0])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[43]=a[0],a})},function(a){return d[43]?d[51]=(d[41].push(c.i64.cast([0,2])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[44]?d[51]=(d[41].push(c.i64.cast([0,3])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[45]?d[51]=(d[41].push(c.i64.cast([0,4])),d[41]):0,d[46]=c.createArray(),d[47]=c.i64.of_int32(d[41].length),c.i64.gt(d[47],c.i64.cast([0,0]))?c.loopAsync(d[47],function(a){return d[51]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[41],d[51]).then(function(a){return a=a,d[52]=a[0],d[53]=a[1],a})},function(a){return d[54]=(d[46].push(d[52]),d[46])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[51]=c.createArray(),d[52]=c.i64.of_int32(d[46].length),c.i64.gt(d[52],c.i64.cast([0,0]))?c.loopAsync(d[52],function(a){return d[54]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[54]).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return d[57]=(d[51].push(c.i64.to_string(d[55])),d[51])}])}):c.resolve()},function(a){return d[53]=d[51].join(","),d[48]=d[53]}])},function(a){return d[46].some(function(a){return c.i64.eq(d[27],a)})?d[49]=d[27]:d[49]=void 0,c.i64.neq(d[49],void 0)?d[50]=d[49]:d[50]=void 0,d[34]=d[50]}])},function(a){return c.i64.neq(d[34],void 0)?d[35]=d[34]:d[35]=c.i64.cast([0,0]),c.i64.neq(d[26],void 0)?d[36]=d[26]:d[36]=c.i64.cast([0,1]),c.filter(c.db.table(2).fetch(),function(a){return a.context==="50013"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[37]=!1:(a.item,d[37]=!0)})},function(a){return c.filter(c.db.table(2).fetch(),function(a){return a.context==="50025"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[39]=!1:(a.item,d[39]=!0)})},function(a){return d[37]||d[39]?(d[41]="Another sync job is already in progress. Terminating this.",d[41]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[41]].join("")),d[42]=c.createArray(),void 0!==void 0?d[43]=(d[42].push(void 0),d[42]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[41],d[42],c.i64.cast([0,3]))):c.resolve()):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2849]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[50]=!0:d[50]=!1,d[50]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[52]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[52]].join("")),d[51]=c.createArray(),void 0!==void 0?d[53]=(d[51].push(void 0),d[51]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[52],d[51],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[41]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[49]=(d[41].push(a.epochId),d[41])})},function(a){return d[47]="Queried locally available epochs. Count: ",d[42]=c.i64.of_int32(d[41].length),d[48]=c.i64.to_string(d[42]),d[43]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[43],d[47],d[43],d[48]].join("")),c.resolve()},function(a){return d[44]=new c.Map(),d[44].set("backup_id",d[13]),d[44].set("device_id",d[25]),d[44].set("locally_available_epochs",d[41]),d[44].set("trace_id",void 0),d[45]=c.toJSON(d[44]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_encrypted_backups",c.i64.cast([0,50025]),d[45],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[46]=a[0],a})}])},function(a){return d[32]=!0}]):c.sequence([function(a){return d[33]=["Failed to load client state: ","","NULL_DEVICE_ID"].join(""),d[33]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[33]].join("")),d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[33],d[34],c.i64.cast([0,3]))):c.resolve()},function(a){return d[32]=!1}])},function(a){return d[6]=d[32]}]):c.sequence([function(a){return d[13]=d[4].get("errors"),d[14]=d[4].get("errors"),d[15]=["Failed to load client state: ","","BACKUP_NOT_FOUND"].join(""),d[15]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[15]].join("")),d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[15],d[16],c.i64.cast([0,3]))):c.resolve()},function(a){return d[6]=!1}])},function(a){return d[7]=c.i64.of_float(Date.now()),d[8]=c.i64.random(),d[10]="Finishing execution. Execution time: ",d[11]=c.i64.to_string(c.i64.sub(d[7],d[0])),d[12]=" ms",d[9]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ",d[9],d[10],d[9],d[11],d[9],d[12]].join("")),c.i64.eq(c.i64.mod_(d[8],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[13]=",",d[14]=c.createArray(),void 0!==void 0?d[15]=(d[14].push(void 0),d[14]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",[d[10],d[13],d[11],d[13],d[12]].join(""),d[14],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsSyncEpochsStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","pending_tasks","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSSyncEpochsStoredProcedure",["LSSyncEpochs","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a){a=a.storedProcedure(c("LSSyncEpochs"));return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("EBSyncEpochs",["EBAPIQPLPoints","EBDeps","LSFactory","LSSyncEpochsStoredProcedure","QPLFlow","Random","WAResultOrError","getErrorSafe","qpl"],(function(a,b,c,d,e,f,g){"use strict";async function a(){var a=await d("EBDeps").getDeps().getLSDB(),b,e=d("Random").uint32(),g=String(e),h=d("QPLFlow").startQPLFlow(c("qpl")._(521475098,"1328"),{annotations:{string:{traceId:g}},instanceKey:e});return new Promise(async function(e,g){var i=a.tables.secure_encrypted_backups_epochs.subscribe(function(a,c){if(c.operation!=="delete"){i();window.clearTimeout(b);h.endSuccess();return e(d("WAResultOrError").makeResult())}});h.addPoint(d("EBAPIQPLPoints").EBSyncEpochsQPLPoints.SYNC_EPOCH_SPROC_START);await a.runInTransaction(function(a){return c("LSSyncEpochsStoredProcedure")(c("LSFactory")(a))},"readwrite",void 0,void 0,f.id+":58").then(function(){h.addPoint(d("EBAPIQPLPoints").EBSyncEpochsQPLPoints.SYNC_EPOCH_SPROC_END),b=window.setTimeout(function(){h.endFail(d("EBAPIQPLPoints").EBSyncEpochsQPLPoints.SYNC_EPOCH_TIMEOUT);return g(d("WAResultOrError").makeError("timeout"))},12e4)}).catch(function(a){a=c("getErrorSafe")(a);i();return g(d("WAResultOrError").makeError(a.message))})})}g.EBSyncEpochs=a}),98);
__d("LSCreateExtraVirtualDeviceWithRecoveryCodeData",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDebugToken.nop","LSCreateDerivedKeys.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignatureWithArmadilloKey.nop","LSCreateSignature_v2.nop","LSGetArmadilloPublicKey.nop","LSGetBlobFromString.nop","LSGetOpenEpochKeys","LSGetViewerFBID","LSHandleCreateVirtualDeviceFailure","LSHmac_v2.nop","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop","LSParseRecoveryCode_v2.nop","LSSymmetricEncryptionCreateEncryptedString.nop","justknobx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(f){return d.sequence([function(b){return e[0]=a[2].get("recovery_code"),e[1]=a[2].get("virtual_device_type"),e[2]=a[2].get("cloud_service_account"),e[3]=a[2].get("hsm_pin_normalization_status"),e[4]=a[2].get("security_question_type"),e[5]=a[2].get("trusted_contact_id"),d.db.table(168).fetch().next().then(function(a,b){var c=a.done;a=a.value;return c?e[6]=d.i64.cast([0,1]):(b=a.item,e[9]=b.backupTenancy,d.i64.neq(e[9],void 0)?e[8]=e[9]:e[8]=d.i64.cast([0,1]),e[6]=e[8])})},function(f){return d.i64.eq(e[6],d.i64.cast([0,1]))&&e[0]==="1SHADOWTESTINGRECOVERYCODE00000000000000"?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Invalid Recovery Code Used."),e[9]="Invalid Recovery Code Used.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[9]].join("")),e[8]=d.createArray(),void 0!==void 0?e[10]=(e[8].push(void 0),e[8]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[9],e[8],d.i64.cast([0,3]))):d.sequence([function(a){return e[8]=d.createArray(),d.storedProcedure(b("LSGetViewerFBID")).then(function(a){return a=a,e[9]=a[0],a})},function(a){return d.nativeOperation(b("LSParseRecoveryCode_v2.nop"),e[0],void 0==null?d.i64.to_string(e[9]):void 0,e[8]).then(function(a){return a=a,e[10]=a[0],e[11]=a[1],a})},function(f){return d.blobs.neq(e[11],void 0)?d.blobs.neq(e[10],void 0)?d.sequence([function(a){return d.storedProcedure(b("LSGetOpenEpochKeys"),!1).then(function(a){return a=a,e[12]=a[0],a})},function(f){return e[12]!==void 0?d.sequence([function(f){return e[79]=c("justknobx")._("1310"),a[3]!==void 0?e[79]?d.sequence([function(c){return a[3]!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),a[3],d.i64.cast([0,2866]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[89]=a[0],a})},function(a){return e[89]?e[90]=!0:e[90]=!1,e[90]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[92]="LSDataTraceMciTraceLog native op not supported",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",e[92]].join("")),e[91]=d.createArray(),void 0!==void 0?e[93]=(e[91].push(void 0),e[91]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",e[92],e[91],d.i64.cast([0,3]))):d.resolve()}]):d.sequence([function(c){return a[3]!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),a[3],d.i64.cast([0,2867]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[89]=a[0],a})},function(a){return e[89]?e[90]=!0:e[90]=!1,e[90]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[92]="LSDataTraceMciTraceLog native op not supported",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",e[92]].join("")),e[91]=d.createArray(),void 0!==void 0?e[93]=(e[91].push(void 0),e[91]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",e[92],e[91],d.i64.cast([0,3]))):d.resolve()}]):d.resolve()},function(a){return e[79]?d.resolve():d.sequence([function(a){return d.count(d.db.table(169).fetch()).then(function(a){return e[89]=a})},function(a){return d.i64.gt(e[89],d.i64.cast([0,1]))?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Multiple rows in $epoch_tables."),e[91]="Multiple rows in $epoch_tables.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[91]].join("")),e[90]=d.createArray(),void 0!==void 0?e[92]=(e[90].push(void 0),e[90]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[91],e[90],d.i64.cast([0,3]))):d.resolve()}])},function(a){return d.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,e[13]=a[0],e[14]=a[1],a})},function(a){return d.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,e[15]=a[0],e[16]=a[1],a})},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[13],d.blob("MA=="),e[16]).then(function(a){return a=a,e[17]=a[0],a})},function(c){return e[80]=d.blob(""),e[81]=d.blob(""),e[82]=d.blob(""),d.db.table(168).fetch([[[a[1]]]]).next().then(function(a,c){var f=a.done;a=a.value;return f?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Row with backupid not found in client state table"),e[90]="Row with backupid not found in client state table",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))},function(a){return a=[e[80],e[81],void 0,e[82]],e[18]=a[0],e[19]=a[1],e[20]=a[2],e[21]=a[3],a}]):(c=a.item,f=[c.obliviousValidationTokenBlob,c.mailboxRootKeyBlob,c.deviceId,c.ocmfClientStateBlob],e[18]=f[0],e[19]=f[1],e[20]=f[2],e[21]=f[3])})},function(a){return d.blobs.eq(e[18],e[80])?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] oblivious_token is empty!"),e[90]="oblivious_token is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return d.blobs.eq(e[19],e[81])?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] mailbox_root_key is empty!"),e[90]="mailbox_root_key is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return d.blobs.eq(e[21],e[82])?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ocmf_client_state is empty!"),e[90]="ocmf_client_state is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return e[23]=e[12].get("epoch_anon_id"),e[24]=e[12].get("epoch_root_key"),e[25]=d.createArray(),e[89]=(e[25].push(d.i64.cast([0,32])),e[25]),d.nativeOperation(b("LSBase64Encode.nop"),e[23]).then(function(a){return a=a,e[26]=a[0],a})},function(a){return e[26]!==void 0?d.sequence([function(a){return d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blobs.of_string(["epoch_devices","_",e[26]].join("")),void 0,e[24],e[25]).then(function(a){return a=a,e[89]=a[0],a})},function(a){return e[89]?e[90]=!1:e[90]=!0,e[90]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),e[93]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[93]].join("")),e[92]=d.createArray(),void 0!==void 0?e[95]=(e[92].push(void 0),e[92]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[93],e[92],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[94]=a[0],a})},function(a){return e[91]=e[94]}]):d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[89],d.i64.cast([0,0])).then(function(a){return a=a,e[92]=a[0],e[93]=a[1],a})},function(a){return e[91]=e[92]}])},function(a){return e[27]=e[91]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),e[90]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[92]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",e[90],e[89],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[91]=a[0],a})},function(a){return e[27]=e[91]}])},function(a){return d.nativeOperation(b("LSHmac_v2.nop"),e[27],e[14]).then(function(a){return a=a,e[28]=a[0],a})},function(a){return d.blobs.neq(e[28],void 0)?d.resolve(e[29]=e[28]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] device_epoch_hmac is null!"),e[90]="device_epoch_hmac is null!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[92]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,e[91]=a[0],a})},function(a){return e[29]=e[91]}])},function(a){return e[30]=e[12].get("epoch_root_key"),d.blobs.neq(e[30],void 0)?d.sequence([function(a){return e[89]=d.createArray(),e[95]=(e[89].push(d.i64.cast([0,18])),e[89]),d.nativeOperation(b("LSCreateDerivedKeys.nop"),d.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,e[30],e[89]).then(function(a){return a=a,e[90]=a[0],a})},function(a){return e[90]!==void 0?d.sequence([function(a){return e[95]=d.i64.of_int32(e[90].length),d.i64.ge(e[95],d.i64.cast([0,1]))?d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[90],d.i64.cast([0,0])).then(function(a){return a=a,e[97]=a[0],e[98]=a[1],a})},function(a){return e[96]=e[97]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),e[98]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",e[98]].join("")),e[97]=d.createArray(),void 0!==void 0?e[99]=(e[97].push(void 0),e[97]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",e[98],e[97],d.i64.cast([0,3]))},function(a){return e[96]=void 0}])},function(a){return e[91]=e[96]}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),e[96]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",e[96]].join("")),e[95]=d.createArray(),void 0!==void 0?e[97]=(e[95].push(void 0),e[95]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",e[96],e[95],d.i64.cast([0,3]))},function(a){return e[91]=void 0}])},function(a){return d.blobs.neq(e[91],void 0)?e[92]=!0:e[92]=!1,e[92]?0:(function(a){d.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),d["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d.nativeOperation(b("LSBase64Encode.nop"),e[91]).then(function(a){return a=a,e[93]=a[0],a})},function(a){return e[93]!==void 0?e[94]=e[93]:e[94]="encodingfailed",e[31]=e[94]}]):d.resolve(e[31]="null")},function(a){return d.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),e[21]).then(function(a){return a=a,e[32]=a[0],e[33]=a[1],a})},function(a){return d.blobs.neq(void 0,void 0)?d.sequence([function(a){return d.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),void 0).then(function(a){return a=a,e[89]=a[0],e[90]=a[1],a})},function(a){return a=[e[32],e[33],e[89],e[90]],e[34]=a[0],e[35]=a[1],e[36]=a[2],e[37]=a[3],a}]):d.resolve((a=[e[32],e[33],void 0,void 0],e[34]=a[0],e[35]=a[1],e[36]=a[2],e[37]=a[3],a))},function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[13]).then(function(a){return a=a,e[38]=a[0],a})},function(a){return d.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),e[11],d.blob("dmlydHVhbF9kZXZpY2U6dmlydHVhbF9kZXZpY2VfcHJpdmF0ZV9rZXk="),e[38]==null?"":e[38]).then(function(a){return a=a,e[39]=a[0],a})},function(a){return e[39]!==void 0?e[40]=e[39]:e[40]="",e[40]===""?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_device_private_key is empty!"),e[90]="encrypted_device_private_key is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[15]).then(function(a){return a=a,e[41]=a[0],a})},function(a){return d.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),e[11],d.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),e[41]==null?"":e[41]).then(function(a){return a=a,e[42]=a[0],a})},function(a){return e[42]!==void 0?e[43]=e[42]:e[43]="",e[43]===""?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_epoch_storage_private_key is empty!"),e[90]="encrypted_epoch_storage_private_key is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[34]).then(function(a){return a=a,e[44]=a[0],a})},function(a){return d.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),e[11],d.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),e[44]==null?"":e[44]).then(function(a){return a=a,e[45]=a[0],a})},function(a){return e[45]!==void 0?e[46]=e[45]:e[46]="",e[46]===""?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_orf_client_state_v1_shape is empty!"),e[90]="encrypted_orf_client_state_v1_shape is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[18]).then(function(a){return a=a,e[47]=a[0],a})},function(a){return d.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),e[11],d.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),e[47]==null?"":e[47]).then(function(a){return a=a,e[48]=a[0],a})},function(a){return e[48]!==void 0?e[49]=e[48]:e[49]="",e[49]===""?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_oblivious_validation_token is empty!"),e[90]="encrypted_oblivious_validation_token is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[19]).then(function(a){return a=a,e[50]=a[0],a})},function(a){return d.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),e[11],d.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),e[50]==null?"":e[50]).then(function(a){return a=a,e[51]=a[0],a})},function(a){return e[51]!==void 0?e[52]=e[51]:e[52]="",e[52]===""?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_mailbox_root_key is empty!"),e[90]="encrypted_mailbox_root_key is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return e[53]=e[12].get("epoch_anon_id"),d.nativeOperation(b("LSBase64Encode.nop"),e[53]).then(function(a){return a=a,e[54]=a[0],a})},function(a){return d.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),e[11],d.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),e[54]==null?"":e[54]).then(function(a){return a=a,e[55]=a[0],a})},function(a){return e[55]!==void 0?e[56]=e[55]:e[56]="",e[56]===""?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_epoch_anon_id is empty!"),e[90]="encrypted_epoch_anon_id is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return e[57]=e[12].get("epoch_root_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[57]).then(function(a){return a=a,e[58]=a[0],a})},function(a){return d.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),e[11],d.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),e[58]==null?"":e[58]).then(function(a){return a=a,e[59]=a[0],a})},function(a){return e[59]!==void 0?e[60]=e[59]:e[60]="",e[60]===""?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_epoch_root_key is empty!"),e[90]="encrypted_epoch_root_key is empty!",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[90]].join("")),e[89]=d.createArray(),void 0!==void 0?e[91]=(e[89].push(void 0),e[89]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[90],e[89],d.i64.cast([0,3]))):d.resolve()},function(a){return e[61]=new d.Map(),e[61].set("encrypted_device_private_key",e[40]),e[61].set("encrypted_epoch_storage_private_key",e[43]),e[61].set("encrypted_ocmf_client_state",e[46]),e[61].set("encrypted_orf_client_state_v2",void 0),e[61].set("encrypted_oblivious_validation_token_blob",e[49]),e[61].set("encrypted_mailbox_root_key_blob",e[52]),e[61].set("encrypted_epoch_anon_id",e[56]),e[61].set("encrypted_epoch_root_key",e[60]),d.nativeOperation(b("LSBase64Encode.nop"),e[10]).then(function(a){return a=a,e[62]=a[0],a})},function(a){return e[83]=e[62]==null?"":e[62],d.nativeOperation(b("LSBase64Encode.nop"),e[14]).then(function(a){return a=a,e[63]=a[0],a})},function(a){return e[84]=e[63]==null?"":e[63],d.nativeOperation(b("LSBase64Encode.nop"),e[16]).then(function(a){return a=a,e[64]=a[0],a})},function(a){return e[85]=e[64]==null?"":e[64],d.nativeOperation(b("LSBase64Encode.nop"),e[17]==null?d.blob("bnVsbA=="):e[17]).then(function(a){return a=a,e[65]=a[0],a})},function(a){return e[86]=e[65]==null?"":e[65],d.nativeOperation(b("LSBase64Encode.nop"),e[29]).then(function(a){return a=a,e[66]=a[0],a})},function(a){return e[87]=e[66]==null?"":e[66],d.nativeOperation(b("LSBase64Encode.nop"),e[35]).then(function(a){return a=a,e[67]=a[0],a})},function(a){return e[88]=e[67]==null?"":e[67],d.nativeOperation(b("LSGetBlobFromString.nop"),e[0]).then(function(a){return a=a,e[68]=a[0],a})},function(a){return d.blobs.neq(e[19],void 0)?d.sequence([function(a){return e[89]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[19],"private_key",e[13],d.i64.cast([0,1]),e[89]).then(function(a){return a=a,e[90]=a[0],a})},function(a){return d.blobs.neq(e[90],void 0)?e[91]=e[90]:e[91]=void 0,e[69]=e[91]}]):d.resolve(e[69]=void 0)},function(a){return d.blobs.neq(e[69],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[69]).then(function(a){return a=a,e[89]=a[0],a})},function(a){return e[70]=e[89]}]):d.resolve(e[70]=void 0)},function(a){return d.blobs.neq(e[19],void 0)?d.sequence([function(a){return e[89]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[19],"ocmf_client_state",e[34],d.i64.cast([0,1]),e[89]).then(function(a){return a=a,e[90]=a[0],a})},function(a){return d.blobs.neq(e[90],void 0)?e[91]=e[90]:e[91]=void 0,e[71]=e[91]}]):d.resolve(e[71]=void 0)},function(a){return d.blobs.neq(e[71],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[71]).then(function(a){return a=a,e[89]=a[0],a})},function(a){return e[72]=e[89]}]):d.resolve(e[72]=void 0)},function(a){return d.blobs.neq(e[19],void 0)?d.sequence([function(a){return e[89]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[19],"epoch_storage_private_key",e[15],d.i64.cast([0,1]),e[89]).then(function(a){return a=a,e[90]=a[0],a})},function(a){return d.blobs.neq(e[90],void 0)?e[91]=e[90]:e[91]=void 0,e[73]=e[91]}]):d.resolve(e[73]=void 0)},function(a){return d.blobs.neq(e[73],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[73]).then(function(a){return a=a,e[89]=a[0],a})},function(a){return e[74]=e[89]}]):d.resolve(e[74]=void 0)},function(a){return d.storedProcedure(b("LSGetViewerFBID")).then(function(a){return a=a,e[75]=a[0],a})},function(a){return d.nativeOperation(b("LSGetBlobFromString.nop"),d.i64.to_string(e[75])).then(function(a){return a=a,e[76]=a[0],a})},function(a){return d.blobs.neq(e[76],void 0)?d.sequence([function(a){return e[89]=new d.Map(),d.nativeOperation(b("LSCreateDebugToken.nop"),e[76],"recovery_code",e[68],d.i64.cast([0,1]),e[89]).then(function(a){return a=a,e[90]=a[0],a})},function(a){return d.blobs.neq(e[90],void 0)?e[91]=e[90]:e[91]=void 0,e[77]=e[91]}]):d.resolve(e[77]=void 0)},function(a){return d.blobs.neq(e[77],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[77]).then(function(a){return a=a,e[89]=a[0],a})},function(a){return e[78]=e[89]}]):d.resolve(e[78]=void 0)},function(c){return d.i64.neq(e[20],void 0)?d.sequence([function(a){return e[89]=e[12].get("epoch_id"),d.db.table(168).fetch().next().then(function(a,b){var c=a.done;a=a.value;return c?e[90]=d.i64.cast([0,1]):(b=a.item,e[95]=b.backupTenancy,d.i64.neq(e[95],void 0)?e[94]=e[95]:e[94]=d.i64.cast([0,1]),e[90]=e[94])})},function(a){return d.i64.eq(e[90],d.i64.cast([0,2]))?d.resolve(e[92]=void 0):d.sequence([function(a){return d.nativeOperation(b("LSGetArmadilloPublicKey.nop")).then(function(a){return a=a,e[94]=a[0],a})},function(a){return e[92]=e[94]}])},function(a){return d.blobs.neq(e[92],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSCreateSignatureWithArmadilloKey.nop"),e[14]).then(function(a){return a=a,e[94]=a[0],a})},function(a){return d.blobs.neq(e[94],void 0)?d.resolve(e[95]=e[94]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create labyrinth signature"),e[100]="Failed to create labyrinth signature",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",e[100]].join("")),e[99]=d.createArray(),void 0!==void 0?e[101]=(e[99].push(void 0),e[99]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",e[100],e[99],d.i64.cast([0,3]))},function(a){return e[95]=void 0}])},function(a){return d.nativeOperation(b("LSCreateSignature_v2.nop"),e[13],d.blob("Mw=="),e[92]).then(function(a){return a=a,e[96]=a[0],a})},function(a){return d.blobs.neq(e[96],void 0)?d.resolve(e[97]=e[96]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create armadillo signature"),e[100]="Failed to create armadillo signature",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",e[100]].join("")),e[99]=d.createArray(),void 0!==void 0?e[101]=(e[99].push(void 0),e[99]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",e[100],e[99],d.i64.cast([0,3]))},function(a){return e[97]=void 0}])},function(a){return d.blobs.neq(e[97],void 0)?(d.blobs.neq(e[95],void 0)?(e[100]=new d.Map(),e[100].set("armadillo_public_key",e[92]),e[100].set("armadillo_key_signature",e[97]),e[100].set("labyrinth_key_signature",e[95]),e[99]=e[100]):e[99]=void 0,e[98]=e[99]):e[98]=void 0,e[93]=e[98]}]):d.resolve(e[93]=void 0)},function(c){return e[93]!==void 0?d.sequence([function(a){return e[94]=e[93].get("armadillo_public_key"),d.nativeOperation(b("LSBase64Encode.nop"),e[94]).then(function(a){return a=a,e[95]=a[0],a})},function(a){return e[96]=e[93].get("armadillo_key_signature"),d.nativeOperation(b("LSBase64Encode.nop"),e[96]).then(function(a){return a=a,e[97]=a[0],a})},function(a){return e[98]=e[93].get("labyrinth_key_signature"),d.nativeOperation(b("LSBase64Encode.nop"),e[98]).then(function(a){return a=a,e[99]=a[0],a})},function(c){return e[100]=new d.Map(),e[100].set("backup_id",a[1]),e[100].set("request_device_id",e[20]),e[100].set("virtual_device_id",e[83]),e[100].set("encrypted_secret_values",e[61]),e[100].set("public_key",e[84]),e[100].set("epoch_storage_pubkey",e[85]),e[100].set("epoch_storage_pubkey_sig",e[86]),e[100].set("device_epoch_hmac",e[87]),e[100].set("epoch_root_key_fingerprint",e[31]),e[100].set("ocmf_rotation_token",e[88]),e[100].set("is_init",!1),e[100].set("epoch_id",e[89]),e[100].set("virtual_device_type",e[1]),e[100].set("action_type",a[0]),e[100].set("private_key_debug_token",e[70]),e[100].set("ocmf_client_state_debug_token",e[72]),e[100].set("epoch_storage_pvtkey_debug_token",e[74]),e[100].set("recovery_code_debug_token",e[78]),e[100].set("trace_id",a[3]),e[100].set("cloud_service_account",e[2]),e[100].set("hsm_pin_normalization_status",e[3]),e[100].set("security_question_type",e[4]),e[100].set("trusted_contact_id",e[5]),e[100].set("armadillo_public_key",e[95]==null?"":e[95]),e[100].set("armadillo_key_signature",e[97]==null?"":e[97]),e[100].set("labyrinth_key_signature",e[99]==null?"":e[99]),e[101]=d.toJSON(e[100]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50004]),e[101],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),a[3],d.i64.cast([0,0])).then(function(a){return a=a,e[102]=a[0],a})}]):(function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] failed to get armadillo key and device signatures"),e[94]=new d.Map(),e[94].set("backup_id",a[1]),e[94].set("request_device_id",e[20]),e[94].set("virtual_device_id",e[83]),e[94].set("encrypted_secret_values",e[61]),e[94].set("public_key",e[84]),e[94].set("epoch_storage_pubkey",e[85]),e[94].set("epoch_storage_pubkey_sig",e[86]),e[94].set("device_epoch_hmac",e[87]),e[94].set("epoch_root_key_fingerprint",e[31]),e[94].set("ocmf_rotation_token",e[88]),e[94].set("is_init",!1),e[94].set("epoch_id",e[89]),e[94].set("virtual_device_type",e[1]),e[94].set("action_type",a[0]),e[94].set("private_key_debug_token",e[70]),e[94].set("ocmf_client_state_debug_token",e[72]),e[94].set("epoch_storage_pvtkey_debug_token",e[74]),e[94].set("recovery_code_debug_token",e[78]),e[94].set("trace_id",a[3]),e[94].set("cloud_service_account",e[2]),e[94].set("hsm_pin_normalization_status",e[3]),e[94].set("security_question_type",e[4]),e[94].set("trusted_contact_id",e[5]),e[95]=d.toJSON(e[94]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50004]),e[95],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),a[3],d.i64.cast([0,0])).then(function(a){return a=a,e[96]=a[0],a}))}]):d.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[1],!1,a[3])}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Epoch keys are unavailable."),e[14]="Epoch keys are unavailable.",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[14]].join("")),e[13]=d.createArray(),void 0!==void 0?e[15]=(e[13].push(void 0),e[13]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[14],e[13],d.i64.cast([0,3]))},function(c){return d.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[1],!1,a[3])}])}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Invalid Recovery Code Provided"),e[13]="Invalid Recovery Code Provided",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[13]].join("")),e[12]=d.createArray(),void 0!==void 0?e[14]=(e[12].push(void 0),e[12]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[13],e[12],d.i64.cast([0,3]))},function(c){return d.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[1],!1,a[3])}]):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Invalid Recovery Code Provided"),e[13]="Invalid Recovery Code Provided",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",e[13]].join("")),e[12]=d.createArray(),void 0!==void 0?e[14]=(e[12].push(void 0),e[12]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",e[13],e[12],d.i64.cast([0,3]))},function(c){return d.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[1],!1,a[3])}])}])}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsCreateExtraVirtualDeviceWithRecoveryCodeDataStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];d=a;g["default"]=d}),98);
__d("LSCreateExtraVirtualDeviceWithRecoveryCodeDataStoredProcedure",["LSCreateExtraVirtualDeviceWithRecoveryCodeData","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSCreateExtraVirtualDeviceWithRecoveryCodeData"),e.actionType,e.backupId,e.recoveryCodeData,e.traceId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSOptOutOfBackup",["LSAppendDataTraceAddon","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","justknobx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(g){return d.sequence([function(f){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] Beginning execution."),c("justknobx")._("1099")?d.sequence([function(a){return d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,1469]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[11]=a[0],a})},function(a){return e[11]?e[12]=!0:e[12]=!1,e[12]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[14]="LSDataTraceMciTraceLog native op not supported",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",e[14]].join("")),e[13]=d.createArray(),void 0!==void 0?e[15]=(e[13].push(void 0),e[13]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",e[14],e[13],d.i64.cast([0,3]))):d.resolve()}])},function(c){return e[8]=new d.Map(),e[8].set("backup_id",a[0]),e[8].set("trace_id",void 0),e[9]=d.toJSON(e[8]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_opt_out",d.i64.cast([0,50019]),e[9],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,d.i64.cast([0,0])).then(function(a){return a=a,e[10]=a[0],a})},function(a){return e[1]=d.i64.cast([0,0])}]):d.resolve((function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] backup opt out flow is not enabled"),e[1]=d.i64.cast([0,1])))},function(a){return e[2]=d.i64.of_float(Date.now()),e[3]=d.i64.random(),e[5]="Finishing execution. Execution time: ",e[6]=d.i64.to_string(d.i64.sub(e[2],e[0])),e[7]=" ms",e[4]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] ",e[4],e[5],e[4],e[6],e[4],e[7]].join("")),d.i64.eq(d.i64.mod_(e[3],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[8]=",",e[9]=d.createArray(),void 0!==void 0?e[10]=(e[9].push(void 0),e[9]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsOptOutOfBackupStoredProcedure",[e[5],e[8],e[6],e[8],e[7]].join(""),e[9],d.i64.cast([0,4]))):d.resolve()},function(a){return f[0]=e[1]}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsOptOutOfBackupStoredProcedure";a.__tables__=[];d=a;g["default"]=d}),98);
__d("LSOptOutOfBackupStoredProcedure",["LSOptOutOfBackup","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSOptOutOfBackup"),e.backupId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MWEncryptedBackupsCreateExtraVirtualDeviceWithRecoveryCodeData",["LSCreateExtraVirtualDeviceWithRecoveryCodeDataStoredProcedure","LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","LSShape","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;async function a(a,b,e){var g=await d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.encrypted_backups));if(g==null)return[(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE)];var i=g.backupId;if(i!=null){await a.runInTransaction(function(a){return c("LSCreateExtraVirtualDeviceWithRecoveryCodeDataStoredProcedure")(c("LSFactory")(a),{actionType:b,backupId:i,recoveryCodeData:d("LSShape").ofRecord(e),traceId:void 0})},"readwrite",void 0,void 0,f.id+":41");return[(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").SUCCESS)]}return[(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE)]}g.initializeCreateExtraVirtualDeviceStoredProcedure=a}),98);
__d("PublicKeyCrypto",["Promise","UInt8Array","X25519"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,c){return(h||(h=b("Promise"))).all([a,c]).then(function(a){return(h||(h=b("Promise"))).resolve(a[0]!=null&&a[1]!=null?d("UInt8Array").concatBytes([a[0],a[1]]):void 0)})}function a(a,b,c){return i(d("X25519").exchangeKeys(c,a),d("X25519").exchangeKeys(c,b))}function c(a,b,c){return i(d("X25519").exchangeKeys(c,a),d("X25519").exchangeKeys(b,a))}g.senderDeriveSharedSecret=a;g.receiverDeriveSharedSecret=c}),98);
__d("WASmaxInAbPropsIQErrorResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","error");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQErrorResponseMixin=a}),98);
__d("WASmaxInAbPropsIQErrorBadRequestMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","bad-request");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",400);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorBadRequestMixin=a}),98);
__d("WASmaxInAbPropsIQErrorFeatureNotImplementedMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","feature-not-implemented");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",501);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorFeatureNotImplementedMixin=a}),98);
__d("WASmaxInAbPropsNoRetryErrors",["WAResultOrError","WASmaxInAbPropsIQErrorBadRequestMixin","WASmaxInAbPropsIQErrorFeatureNotImplementedMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInAbPropsIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"IQErrorBadRequest",value:b.value});var c=d("WASmaxInAbPropsIQErrorFeatureNotImplementedMixin").parseIQErrorFeatureNotImplementedMixin(a);return c.success?d("WAResultOrError").makeResult({name:"IQErrorFeatureNotImplemented",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["IQErrorBadRequest","IQErrorFeatureNotImplemented"],[b,c])}g.parseNoRetryErrors=a}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry",["WAResultOrError","WASmaxInAbPropsIQErrorResponseMixin","WASmaxInAbPropsNoRetryErrors","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInAbPropsIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInAbPropsNoRetryErrors").parseNoRetryErrors(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorNoRetryErrors:b.value}))}g.parseGetExperimentConfigResponseErrorNoRetry=a}),98);
__d("WASmaxInAbPropsIQErrorInternalServerErrorMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","internal-server-error");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",500);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorInternalServerErrorMixin=a}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseErrorRetry",["WAResultOrError","WASmaxInAbPropsIQErrorInternalServerErrorMixin","WASmaxInAbPropsIQErrorResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;c=d("WASmaxInAbPropsIQErrorInternalServerErrorMixin").parseIQErrorInternalServerErrorMixin(c.value);if(!c.success)return c;a=d("WASmaxInAbPropsIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({errorIQErrorInternalServerErrorMixin:c.value},a.value))}g.parseGetExperimentConfigResponseErrorRetry=a}),98);
__d("WASmaxInAbPropsExperimentConfigMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"prop");if(!b.success)return b;b=d("WASmaxParseUtils").attrIntRange(a,"config_code",1,void 0);if(!b.success)return b;var c=d("WASmaxParseUtils").attrString(a,"config_value");if(!c.success)return c;a=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,a,"config_expo_key",0,void 0);return!a.success?a:d("WAResultOrError").makeResult({configCode:b.value,configValue:c.value,configExpoKey:a.value})}g.parseExperimentConfigMixin=a}),98);
__d("WASmaxInAbPropsSamplingConfigMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"prop");if(!b.success)return b;b=d("WASmaxParseUtils").attrIntRange(a,"event_code",1,void 0);if(!b.success)return b;a=d("WASmaxParseUtils").attrIntRange(a,"sampling_weight",-1e4,1e4);return!a.success?a:d("WAResultOrError").makeResult({eventCode:b.value,samplingWeight:a.value})}g.parseSamplingConfigMixin=a}),98);
__d("WASmaxInAbPropsConfigs",["WAResultOrError","WASmaxInAbPropsExperimentConfigMixin","WASmaxInAbPropsSamplingConfigMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInAbPropsExperimentConfigMixin").parseExperimentConfigMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"ExperimentConfig",value:b.value});var c=d("WASmaxInAbPropsSamplingConfigMixin").parseSamplingConfigMixin(a);return c.success?d("WAResultOrError").makeResult({name:"SamplingConfig",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["ExperimentConfig","SamplingConfig"],[b,c])}g.parseConfigs=a}),98);
__d("WASmaxInAbPropsEnums",[],(function(a,b,c,d,e,f){a={"false":"false","true":"true"};f.ENUM_FALSE_TRUE=a}),66);
__d("WASmaxInAbPropsIQResultResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","result");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQResultResponseMixin=a}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseSuccess",["WAResultOrError","WASmaxInAbPropsConfigs","WASmaxInAbPropsEnums","WASmaxInAbPropsIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"prop");if(!b.success)return b;b=d("WASmaxInAbPropsConfigs").parseConfigs(a);return!b.success?b:d("WAResultOrError").makeResult({configs:b.value})}function i(a){var b=d("WASmaxParseUtils").assertTag(a,"erid");if(!b.success)return b;b=d("WASmaxParseUtils").contentBytesRange(a,1,100);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"props");if(!c.success)return c;var e=d("WASmaxParseUtils").optionalChildWithTag(a,"erid",i);if(!e.success)return e;var f=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,c.value,"protocol","1");if(!f.success)return f;var g=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrString,c.value,"ab_key");if(!g.success)return g;var j=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrString,c.value,"hash");if(!j.success)return j;var k=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,c.value,"refresh",0,void 0);if(!k.success)return k;var l=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,c.value,"refresh_id",0,void 0);if(!l.success)return l;var m=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrStringEnum,c.value,"delta_update",d("WASmaxInAbPropsEnums").ENUM_FALSE_TRUE);if(!m.success)return m;a=d("WASmaxInAbPropsIQResultResponseMixin").parseIQResultResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxParseUtils").mapChildrenWithTag(c.value,"prop",0,Infinity,h);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({propsProtocol:f.value,propsAbKey:g.value,propsHash:j.value,propsRefresh:k.value,propsRefreshId:l.value,propsDeltaUpdate:m.value},a.value,{erid:e.value,propsProp:b.value}))}g.parseGetExperimentConfigResponseSuccessPropsProp=h;g.parseGetExperimentConfigResponseSuccessErid=i;g.parseGetExperimentConfigResponseSuccess=a}),98);
__d("WASmaxOutAbPropsBaseIQGetRequestMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(){var a=d("WASmaxJsx").smax("iq",{id:d("WAWap").generateId(),type:"get"});return a}function a(a){var b=h();return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeBaseIQGetRequestMixin=a}),98);
__d("WASmaxOutAbPropsGetExperimentConfigRequest",["WASmaxAttrs","WASmaxJsx","WASmaxOutAbPropsBaseIQGetRequestMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(a){var b=a.propsHash;a=a.propsRefreshId;b=d("WASmaxOutAbPropsBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(d("WASmaxJsx").smax("iq",{xmlns:"abt",to:d("WAWap").S_WHATSAPP_NET},d("WASmaxJsx").smax("props",{protocol:"1",hash:d("WASmaxAttrs").OPTIONAL(d("WAWap").CUSTOM_STRING,b),refresh_id:d("WASmaxAttrs").OPTIONAL(d("WAWap").INT,a)})));return b}g.makeGetExperimentConfigRequest=a}),98);
__d("WASmaxAbPropsGetExperimentConfigRPC",["WAComms","WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry","WASmaxInAbPropsGetExperimentConfigResponseErrorRetry","WASmaxInAbPropsGetExperimentConfigResponseSuccess","WASmaxOutAbPropsGetExperimentConfigRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(a,b,c,d,e,f,g){async function a(a,b){a=d("WASmaxOutAbPropsGetExperimentConfigRequest").makeGetExperimentConfigRequest(a);b=await d("WAComms").sendSmaxStanza(a,b);var c=d("WASmaxInAbPropsGetExperimentConfigResponseSuccess").parseGetExperimentConfigResponseSuccess(b,a);if(c.success)return{name:"GetExperimentConfigResponseSuccess",value:c.value};var e=d("WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry").parseGetExperimentConfigResponseErrorNoRetry(b,a);if(e.success)return{name:"GetExperimentConfigResponseErrorNoRetry",value:e.value};b=d("WASmaxInAbPropsGetExperimentConfigResponseErrorRetry").parseGetExperimentConfigResponseErrorRetry(b,a);if(b.success)return{name:"GetExperimentConfigResponseErrorRetry",value:b.value};throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("GetExperimentConfig",{Success:c,ErrorNoRetry:e,ErrorRetry:b}))}g.sendGetExperimentConfigRPC=a}),98);
__d("WAGetAbPropsProtocol",["WALogger","WAResultOrError","WASmaxAbPropsGetExperimentConfigRPC"],(function(a,b,c,d,e,f,g){"use strict";var h;async function a(a){a=await d("WASmaxAbPropsGetExperimentConfigRPC").sendGetExperimentConfigRPC({propsHash:a});if(a.name==="GetExperimentConfigResponseSuccess"){var b=a.value,c=b.propsAbKey,e=b.propsHash,f=b.propsRefresh,g=b.propsRefreshId,j=b.propsProp;b=b.erid;j=i(j);var k=j.newProps;j=j.samplingConfigs;return d("WAResultOrError").makeResult({abKey:c,hash:e,refresh:f,refreshId:g,props:k,samplingConfigs:j,erid:b==null?void 0:b.elementValue})}d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["getAbPropsProtocol failed ",""])),a.value);return d("WAResultOrError").makeError()}function i(a){var b=[],c=[];a.forEach(function(a){a=a.configs;if(a.name==="ExperimentConfig"){var d;b.push({configCode:a.value.configCode,configValue:a.value.configValue,configExpoKey:(d=a.value.configExpoKey)==null?void 0:d.toString()})}else a.name==="SamplingConfig"&&c.push({eventCode:a.value.eventCode,samplingWeight:a.value.samplingWeight})});return{newProps:b,samplingConfigs:c}}g.getAbPropsProtocol=a}),98);
__d("WAAbPropsSync",["WAAbProps","WAAbPropsHelpers","WAGetAbPropsProtocol","WALogger","WAPromiseManagement","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;b=d("WAPromiseManagement").cacheWhilePending(function(){return"abProps"},a);function a(a){var b=a.sendHash;b=b===void 0?!0:b;var c=a.eventFlow;c==null||c.addPoint("sync_ab_props",{bool:{sendHash:b}});return b==null||b===!1?l(null,c):d("WAAbProps").getHash().then(function(a){return l(a,c)})}c=a;async function l(a,b){b==null||b.addPoint("fetch_ab_props");a=await d("WAGetAbPropsProtocol").getAbPropsProtocol(a);if(!a.success)d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["fetchAbProps failed"])));else{a=a.value;var c=a.abKey,e=a.hash,f=a.refresh;a=a.props;a=d("WAAbPropsHelpers").parseAbProps(d("WAAbProps").getConfig(),a);b==null||b.addPoint("save_ab_props");b=await m(c,e,f,a);b.success===!1&&(b.error,d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["syncAbProps: detected no hash"]))))}c=await d("WAAbProps").getRefreshSecs();return{seconds:c}}async function m(a,b,c,e){var f=await d("WAAbProps").getAbProps();a={abKey:a!=null?a:f.abKey,hash:b!=null?b:f.hash,refresh:d("WAAbPropsHelpers").maybeUpdateRefresh(c),lastSyncTime:d("WATimeUtils").unixTime(),propValues:f.propValues,propExpoKeys:f.propExpoKeys,internalExpoKeys:f.internalExpoKeys,expoKeyStr:f.expoKeyStr};if(b==null){await d("WAAbProps").setAbProps(a);d("WALogger").LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["WAAbProps.update: detected no hash"])));return d("WAResultOrError").makeError("noHash")}d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["WAAbProps.update: updating ab configs"])));c=e.values;b=e.expoKeys;e=d("WAAbPropsHelpers").maybeUpdatePropValues(c,f.propValues,d("WAAbProps").getConfig());c=d("WAAbPropsHelpers").maybeUpdateExpoKeys(b,f.propExpoKeys,d("WAAbProps").getConfig());b=c.propExpoKeys;c=c.expoKeysToDelete;var g,h;c=d("WAAbPropsHelpers").maybeUpdateInternalExpoKeys(c,f.internalExpoKeys);c!=null&&(g=c.internalExpoKeys,h=c.expoKeyStr);await d("WAAbProps").setAbProps(babelHelpers.extends({},a,{propValues:e,propExpoKeys:b,internalExpoKeys:g,expoKeyStr:h}));return d("WAResultOrError").makeResult()}g.syncAbProps=b;g.syncAbPropsDebug=c}),98);
__d("WASmaxInDevicesFetchSelfResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup").parseRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup:b.value}))}g.parseFetchSelfResponseError=a}),98);
__d("WASmaxInDevicesDeviceInfoMixin",["WAResultOrError","WASmaxInDevicesIdentityKeyMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"platform");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function i(a){var b=d("WASmaxParseUtils").assertTag(a,"manufacturer");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function j(a){var b=d("WASmaxParseUtils").assertTag(a,"model");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function k(a){var b=d("WASmaxParseUtils").assertTag(a,"seen");if(!b.success)return b;b=d("WASmaxParseUtils").contentInt(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function l(a){var b=d("WASmaxParseUtils").assertTag(a,"creation");if(!b.success)return b;b=d("WASmaxParseUtils").contentInt(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function m(a){var b=d("WASmaxParseUtils").assertTag(a,"ip");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function n(a){var b=d("WASmaxParseUtils").assertTag(a,"location");if(!b.success)return b;b=d("WASmaxParseUtils").attrString(a,"latitude");if(!b.success)return b;var c=d("WASmaxParseUtils").attrString(a,"longitude");if(!c.success)return c;a=d("WASmaxParseUtils").contentString(a);return!a.success?a:d("WAResultOrError").makeResult({latitude:b.value,longitude:c.value,elementValue:a.value})}function a(a){var b=d("WASmaxParseUtils").assertTag(a,"device");if(!b.success)return b;b=d("WASmaxParseUtils").optionalChildWithTag(a,"platform",h);if(!b.success)return b;var c=d("WASmaxParseUtils").optionalChildWithTag(a,"manufacturer",i);if(!c.success)return c;var e=d("WASmaxParseUtils").optionalChildWithTag(a,"model",j);if(!e.success)return e;var f=d("WASmaxParseUtils").optionalChildWithTag(a,"seen",k);if(!f.success)return f;var g=d("WASmaxParseUtils").optionalChildWithTag(a,"creation",l);if(!g.success)return g;var o=d("WASmaxParseUtils").optionalChildWithTag(a,"ip",m);if(!o.success)return o;var p=d("WASmaxParseUtils").optionalChildWithTag(a,"location",n);if(!p.success)return p;var q=d("WASmaxParseUtils").attrIntRange(a,"id",1,999);if(!q.success)return q;a=d("WASmaxInDevicesIdentityKeyMixin").parseIdentityKeyMixin(a);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({id:q.value},a.value,{platform:b.value,manufacturer:c.value,model:e.value,seen:f.value,creation:g.value,ip:o.value,location:p.value}))}g.parseDeviceInfoPlatform=h;g.parseDeviceInfoManufacturer=i;g.parseDeviceInfoModel=j;g.parseDeviceInfoSeen=k;g.parseDeviceInfoCreation=l;g.parseDeviceInfoIp=m;g.parseDeviceInfoLocation=n;g.parseDeviceInfoMixin=a}),98);
__d("WASmaxInDevicesFetchSelfResponseSuccess",["WAResultOrError","WASmaxInDevicesDeviceInfoMixin","WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"device");if(!b.success)return b;b=d("WASmaxInDevicesDeviceInfoMixin").parseDeviceInfoMixin(a);return!b.success?b:b}function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"self");if(!c.success)return c;a=d("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxParseUtils").mapChildrenWithTag(c.value,"device",1,25,h);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{selfDevice:b.value}))}g.parseFetchSelfResponseSuccessSelfDevice=h;g.parseFetchSelfResponseSuccess=a}),98);
__d("WASmaxOutDevicesFetchSelfRequest",["WASmaxJsx","WASmaxOutDevicesBaseIQGetRequestMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(){var a=d("WASmaxOutDevicesBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(d("WASmaxJsx").smax("iq",{to:d("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},d("WASmaxJsx").smax("self",null)));return a}g.makeFetchSelfRequest=a}),98);
__d("WASmaxDevicesFetchSelfRPC",["WAComms","WASmaxInDevicesFetchSelfResponseError","WASmaxInDevicesFetchSelfResponseSuccess","WASmaxOutDevicesFetchSelfRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(a,b,c,d,e,f,g){async function a(a){var b=d("WASmaxOutDevicesFetchSelfRequest").makeFetchSelfRequest();a=await d("WAComms").sendSmaxStanza(b,a);var c=d("WASmaxInDevicesFetchSelfResponseSuccess").parseFetchSelfResponseSuccess(a,b);if(c.success)return{name:"FetchSelfResponseSuccess",value:c.value};a=d("WASmaxInDevicesFetchSelfResponseError").parseFetchSelfResponseError(a,b);if(a.success)return{name:"FetchSelfResponseError",value:a.value};throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("FetchSelf",{Success:c,Error:a}))}g.sendFetchSelfRPC=a}),98);
__d("WAGetCurrentUserDeviceList",["WAAssertUnreachable","WAGlobals","WAJids","WALogger","WAPersistedJobManager","WASignalKeys","WASmaxDevicesFetchSelfRPC","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){if(a.isCurrentDevice&&b.isCurrentDevice){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Two devices were detected as isCurrentDevice in getCurrentUserDeviceList"])));return 0}if(a.isCurrentDevice)return-1;if(b.isCurrentDevice)return 1;if(a.lastSeen!=null&&b.lastSeen==null)return-1;if(a.lastSeen==null&&b.lastSeen!=null)return 1;if(a.lastSeen!=null&&b.lastSeen!=null){a=a.lastSeen;b=b.lastSeen;return b.getTime()-a.getTime()}return 0}async function a(a){a=await d("WASmaxDevicesFetchSelfRPC").sendFetchSelfRPC();switch(a.name){case"FetchSelfResponseError":var b=a.value.errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup;switch(b.name){case"RetryableIQError":var e=b.value.backoff;if(e!=null)throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{delay:e,type:"constant"},jitter:0});else throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{first:d("WATimeUtils").HOUR_MILLISECONDS/60,type:"exponential"},jitter:.1});default:b.name;e=b.value.code;throw c("err")("Failed with an error code "+e)}case"FetchSelfResponseSuccess":var f=d("WAJids").extractDeviceId(d("WAGlobals").getMyDeviceJid());return a.value.selfDevice.map(function(a){var b=a.creation,c=a.elementValue,e=a.id,g=a.ip,h=a.location,i=a.manufacturer,j=a.model,k=a.platform;a=a.seen;return{creationTime:b==null?null:d("WATimeUtils").toDate(d("WATimeUtils").castToUnixTime(b.elementValue)),id:d("WAJids").interpretAsDeviceId(e),identityKey:d("WASignalKeys").serializeIdentity(c),ipAddress:(b=g==null?void 0:g.elementValue)!=null?b:null,isCurrentDevice:e===f,lastSeen:a==null?null:d("WATimeUtils").toDate(d("WATimeUtils").castToUnixTime(a.elementValue)),latitude:h==null?null:parseFloat(h.latitude),location:(c=h==null?void 0:h.elementValue)!=null?c:null,longitude:h==null?null:parseFloat(h.longitude),manufacturer:(g=i==null?void 0:i.elementValue)!=null?g:null,model:(b=j==null?void 0:j.elementValue)!=null?b:null,platform:(e=k==null?void 0:k.elementValue)!=null?e:null}}).sort(i);default:return c("WAAssertUnreachable")(a.name)}}g.getCurrentUserDeviceList=a}),98);
__d("WAPublishAppDataProtocol",["FBLogger","WABridge","WAEncUserMsg","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAOdsEnums","WASmaxAppdataPublishPeerRPC","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=d("WATagsLogger").TAGS(["sendAppDataFanout"]);async function a(a,b){var e=b.messagePayload;a=b.identities;b=b.externalId;a=a.get(d("WAGlobals").getMyUserJid());if(a==null)throw c("FBLogger")("wmi").mustfixThrow("Missing my user identities");a=Array.from(a.entries()).map(function(a){var b=a[0];a=a[1];return{identity:a,jid:b}});var f=[{devicesInfo:a,user:d("WAGlobals").getMyUserJid()}];a=await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return d("WAEncUserMsg").encryptUserMsg(f,{messageBytes:e.messageBytes,type:"appdata"},{cryptoManager:a})},{operationType:"encrypt",flush:!0});var g=a.phash,k=!1,l=[];a.participants!=null&&a.participants.forEach(function(a){a.type==="pkmsg"&&(k=!0),l.push({toJid:a.to,encTypeIndividualMixinArgs:{encType:a.type,encElementValue:a.ciphertext},encVersionFutureproofMixinArgs:{encV:parseInt(a.v,10)}})});a={appdataTo:d("WAGlobals").getMyUserJid(),toArgs:l};a={peerPeerFanout:a};var m=void 0;if(k){var n=await d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo();n=n==null?void 0:n.identityKey;if(n==null){j.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"])));throw c("FBLogger")("wmi").mustfixThrow("No public identity key")}m={deviceIdentityElementValue:n}}n={appdataDeviceListCheck:"true"};b={appdataId:b,peerMsgTypesArgs:a,deviceIdentityMixinArgs:m,withDeviceListCheckMixinArgs:n};a=await d("WASmaxAppdataPublishPeerRPC").sendPeerRPC(b);switch(a.name){case"PeerResponseSuccess":n=(m=a.value.deviceListStaleMixin)==null?void 0:m.phash;if(n!=null&&g!=null&&n!==g){j.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Got phash mismatch on appdata, local[","] server[","]"])),g,n);d("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.PHASH_MISMATCH,key:"appdata"});return{type:"success",ts:d("WATimeUtils").castToUnixTime(a.value.t),phash:{type:"mismatch",local:g,server:n},count:null,reportingMeta:null}}else return{type:"success",ts:d("WATimeUtils").castToUnixTime(a.value.t),phash:{type:"ok"},count:null,reportingMeta:null};default:a.name;throw c("FBLogger")("wmi").mustfixThrow("Failed to send appdata %s",a.value.error)}}g.publishAppData=a}),98);
__d("WASaveReceiptApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"saveReceipt",function(a){return function(b){return a.receipts.put({msgId:b.id.externalId.toString(),permittedIdentitiesPerDevice:b.permittedIdentitiesPerDevice,recipientDevices:b.recipientDevices,waMsgId:d("WAMsg").craftWAMsgIdString(b.id)}).then(function(){})}});g.saveReceipt=a}),98);
__d("WAPublishMessage",["FBLogger","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMsg","WASaveReceiptApi","WASendMsgInternal","WASentBytesCache","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i;async function j(a,b){var c=a.identities;a=a.messagePayload;a={author:a.protocolMsgId.author,chat:a.protocolMsgId.chat,externalId:a.protocolMsgId.externalId};var e=await d("WALoadReceiptApi").loadReceipt(a);if(e.success)return e.value;e=new Map();for(c of c){c[0];var f=c[1];for(f of f){var g=f[0],h=f[1];if(g===d("WAGlobals").getMyDeviceJid())continue;e.set(g,{pubKey:h})}}g=new Set();h={permittedIdentitiesPerDevice:e,recipientDevices:g,id:a};b.addPoint("save_receipts_start");await d("WASaveReceiptApi").saveReceipt(h);b.addPoint("save_receipts_end");return h}async function a(a,b){var e=a.messagePayload,f=a.identities;a=a.sendIdentity;a=a===void 0?!1:a;b.addPoint("prepare_receipt_start");f=await j({messagePayload:e,identities:f},b);b.addPoint("prepare_receipt_end");b.addPoint("calculate_recipients_start");var g=e.frankingKey,i=e.frankingVersion,m=e.messageBytes,n=e.backupDirective,o=e.messageType;e=e.protocolMsgId;f=k(f.permittedIdentitiesPerDevice);f=o.type==="text"&&o.invitedParticipantUserJid!=null?f.filter(function(a){return a.user===o.invitedParticipantUserJid||a.user===d("WAGlobals").getMyUserJid()}):f;b.addPoint("calculate_recipients_end",{int:{recipientsCount:f.length}});var p=o.type==="text"&&o.invitedParticipantUserJid!=null?o.invitedParticipantUserJid:e.chat,q=e.chat===d("WAGlobals").getMyUserJid();if(f.length===0&&!q)throw c("FBLogger")("wmi").mustfixThrow("Trying to send a message with no recipients");else if(f.length===0&&q)return{serverResponse:{type:"success",ts:d("WATimeUtils").unixTime(),phash:{type:"ok"},count:null,reportingMeta:null},encryption:{type:"user",messageTo:d("WAGlobals").getMyUserJid(),participants:[],phash:""}};q=a?await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return l(a)},{operationType:"get_my_device_identity",flush:!1,afterInit:!0}):null;a=await (o.isRevoked===!0?Promise.resolve(null):d("WAGenReportingMeta").genReportingMeta(m.bytes,g,i));p=await d("WASendMsgInternal").sendMessageV2({type:"chat",messageBytes:m,chat:p,deviceIdentity:q,messageType:o,protocolMsgId:e,externalId:e.externalId,recipients:f,reportingMeta:a,backupDirective:n},b);q=p.serverResponse;q.type==="success"&&await d("WASentBytesCache").sentBytesCache().saveSentBytes({ts:q.ts,frankingKey:g,frankingVersion:i,messageBytes:m,backupDirective:n,messageType:o,protocolMsgId:e,waMsgId:d("WAMsg").craftWAMsgIdString({author:e.author,chat:e.chat,externalId:e.externalId})}).catch(function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg failed to save sent bytes to cache: ",""])),a)});return p}function k(a){var b=new Map();a.forEach(function(a,c){a=a.pubKey;var e=d("WAJids").extractUserJid(c);a={identity:a,jid:c};c=b.get(e)||[];c.push(a);b.set(e,c)});return Array.from(b,function(a){var b=a[0];a=a[1];return{devicesInfo:a,user:b}})}async function l(a){try{a=await a.storage.loadIdentities(d("WAGlobals").getMyUserJid());a=a.get(d("WAGlobals").getMyDeviceJid());if(a!=null)return a;throw c("err")("missing-identity")}catch(a){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Error loading current device identity ",""])),a)}}g.publishMessage=a}),98);
__d("WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup",["WAResultOrError","WASmaxInDevicesIQErrorBadRequestMixin","WASmaxInDevicesIQErrorItemNotFoundMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInDevicesIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"IQErrorBadRequest",value:b.value});var c=d("WASmaxInDevicesIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(a);return c.success?d("WAResultOrError").makeResult({name:"IQErrorItemNotFound",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["IQErrorBadRequest","IQErrorItemNotFound"],[b,c])}g.parseIQErrorBadRequestOrItemNotFoundMixinGroup=a}),98);
__d("WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin",["WAResultOrError","WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup").parseIQErrorBadRequestOrItemNotFoundMixinGroup(a);return!b.success?b:d("WAResultOrError").makeResult({iQErrorBadRequestOrItemNotFoundMixinGroup:b.value})}g.parseNonRetryableRemoveDeviceIQErrorMixin=a}),98);
__d("WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup",["WAResultOrError","WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin","WASmaxInDevicesRetryableIQErrorMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInDevicesRetryableIQErrorMixin").parseRetryableIQErrorMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"RetryableIQError",value:b.value});var c=d("WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin").parseNonRetryableRemoveDeviceIQErrorMixin(a);return c.success?d("WAResultOrError").makeResult({name:"NonRetryableRemoveDeviceIQError",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["RetryableIQError","NonRetryableRemoveDeviceIQError"],[b,c])}g.parseRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup=a}),98);
__d("WASmaxInDevicesRemoveResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup").parseRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup:b.value}))}g.parseRemoveResponseError=a}),98);
__d("WASmaxInDevicesRemoveResponseSuccess",["WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(a,b);return!c.success?c:c}g.parseRemoveResponseSuccess=a}),98);
__d("WASmaxOutDevicesKeyDataMixin",["WASmaxJsx","WASmaxMixins"],(function(a,b,c,d,e,f,g){function h(a){a=a.anyElementValue;a=d("WASmaxJsx").smax("smax$any",null,a);return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeKeyDataMixin=a}),98);
__d("WASmaxOutDevicesIdentityKeyMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutDevicesKeyDataMixin"],(function(a,b,c,d,e,f,g){function h(a){a=d("WASmaxJsx").smax("smax$any",null,d("WASmaxOutDevicesKeyDataMixin").mergeKeyDataMixin(d("WASmaxJsx").smax("identity",null),a));return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeIdentityKeyMixin=a}),98);
__d("WASmaxOutDevicesRemoveRequest",["WASmaxJsx","WASmaxOutDevicesBaseIQSetRequestMixin","WASmaxOutDevicesIdentityKeyMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(a){var b=a.removeId;a=a.identityKeyMixinArgs;b=d("WASmaxOutDevicesBaseIQSetRequestMixin").mergeBaseIQSetRequestMixin(d("WASmaxJsx").smax("iq",{to:d("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},d("WASmaxOutDevicesIdentityKeyMixin").mergeIdentityKeyMixin(d("WASmaxJsx").smax("remove",{id:d("WAWap").INT(b)}),a)));return b}g.makeRemoveRequest=a}),98);
__d("WASmaxDevicesRemoveRPC",["WAComms","WASmaxInDevicesRemoveResponseError","WASmaxInDevicesRemoveResponseSuccess","WASmaxOutDevicesRemoveRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(a,b,c,d,e,f,g){async function a(a,b){a=d("WASmaxOutDevicesRemoveRequest").makeRemoveRequest(a);b=await d("WAComms").sendSmaxStanza(a,b);var c=d("WASmaxInDevicesRemoveResponseSuccess").parseRemoveResponseSuccess(b,a);if(c.success)return{name:"RemoveResponseSuccess",value:c.value};b=d("WASmaxInDevicesRemoveResponseError").parseRemoveResponseError(b,a);if(b.success)return{name:"RemoveResponseError",value:b.value};throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("Remove",{Success:c,Error:b}))}g.sendRemoveRPC=a}),98);
__d("WARemoveDevice",["WALogger","WAPersistedJobManager","WAPushSafeTypes","WAResultOrError","WASignalOther","WASmaxDevicesRemoveRPC","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i;async function a(a,b){a=d("WAPushSafeTypes").unsafeNotNullable(b);b=a.deviceId;a=a.identity;d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["removeDevice called for device "," and identity ",""])),b,a);a=d("WASignalOther").sliceBytes(a,1,32);a=await d("WASmaxDevicesRemoveRPC").sendRemoveRPC({removeId:b,identityKeyMixinArgs:{anyElementValue:a}});d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["removeDevice result for ",": "," "])),b,a);if(a.name==="RemoveResponseSuccess")return d("WAResultOrError").makeResult();else{a.name;b=a.value.errorRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup;if(b.name!=="RetryableIQError")return d("WAResultOrError").makeError();b.name;a=b.value.backoff;if(a!=null)throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{type:"constant",delay:a},jitter:0});else throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{type:"exponential",first:d("WATimeUtils").HOUR_MILLISECONDS/60},jitter:.1})}}g.removeDevice=a}),98);
__d("WARemoveCurrentDevice",["WAGetCurrentUserDeviceInfoApi","WAGlobals","WALogger","WARemoveDevice","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=async function(a){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["removeCurrentDevice called for current device"])));var b=await d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo();if(b==null){d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["There is no stored user info, it was already deleted or this job was called twice, possibly from another tab"])));return d("WAResultOrError").makeResult()}var c=b.deviceId;b=b.identityKey;a=await d("WARemoveDevice").removeDevice(a,{deviceId:c,identity:b});if(a.success){await d("WAGlobals").getDependencies().clearSignalAndTempStores();return d("WAResultOrError").makeResult()}return d("WAResultOrError").makeResult()};g.removeCurrentDevice=a}),98);
__d("WASendAppDataFanoutProtocol",["WAAsMessageApplication","WABridge","WAConvertAppData","WAEncUserMsg","WAErrorMessage","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAMsgApplication.pb","WAOdsEnums","WAResultOrError","WASmaxAppdataPublishPeerRPC","WATagsLogger","WATimeUtils","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o=d("WATagsLogger").TAGS(["sendAppDataFanout"]),p=24;function a(a,b){a=b.contents;var c=b.externalId,e=b.permittedIdentitiesPerDevice;b=b.checkPhash;b=b===void 0?"checkPhash":b;return q(a,c,e,b).catch(function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);o.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata to devices with error: ",""])),a);return d("WAResultOrError").makeError("runtime-error")})}async function q(a,b,c,e){e===void 0&&(e="checkPhash");o.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Sending appdata, externalId: ",""])),b);a=d("WAConvertAppData").convertAppData(a);var f={bytes:d("WAAsMessageApplication").castToMessageApplicationBytes(d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArrayView()),version:"v3"},g=[];a=Array.from(c.entries()).map(function(a){var b=a[0];a=a[1];return{identity:a.pubKey,jid:b}});c=p;a.length>c&&(o.WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Attempting to send an appData stanza to "," devices"])),a.length),o.ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Attempting to send an appData stanza to more than the allowed "," devices"])),c),a=a.slice(0,c));var h=[{devicesInfo:a,user:d("WAGlobals").getMyUserJid()}];c=await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return d("WAEncUserMsg").encryptUserMsg(h,{messageBytes:f,type:"appdata"},{cryptoManager:a})},{operationType:"encrypt",flush:!0});a=c.phash;var q=!1;c.participants!=null&&c.participants.forEach(function(a){a.type==="pkmsg"&&(q=!0),g.push({toJid:a.to,encTypeIndividualMixinArgs:{encType:a.type,encElementValue:a.ciphertext},encVersionFutureproofMixinArgs:{encV:parseInt(a.v,10)}})});c={appdataTo:d("WAGlobals").getMyUserJid(),toArgs:g};c={peerPeerFanout:c};var r=void 0;if(q){var s=await d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo();s=s==null?void 0:s.identityKey;if(s==null){o.ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"])));return d("WAResultOrError").makeError("no-public-identity")}r={deviceIdentityElementValue:s}}s={appdataDeviceListCheck:e==="checkPhash"?"true":"false"};e={appdataId:b,peerMsgTypesArgs:c,deviceIdentityMixinArgs:r,withDeviceListCheckMixinArgs:s};b=await d("WASmaxAppdataPublishPeerRPC").sendPeerRPC(e);switch(b.name){case"PeerResponseSuccess":r=(c=b.value.deviceListStaleMixin)==null?void 0:c.phash;if(r!=null&&a!=null&&r!==a){o.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Got phash mismatch on appdata, local[","] server[","]"])),a,r);d("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.PHASH_MISMATCH,key:"appdata"});return d("WAResultOrError").makeResult({phashMismatch:!0,serverTs:d("WATimeUtils").castToUnixTime(b.value.t)})}else return d("WAResultOrError").makeResult({phashMismatch:!1,serverTs:d("WATimeUtils").castToUnixTime(b.value.t)});default:b.name;o.ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata. Error: ",""])),b.value.error);return d("WAResultOrError").makeError("ack-failure")}}g.MAX_APPDATA_RECIPIENTS=p;g.sendAppDataToDevicesProtocol=a}),98);
__d("WASendMsgUtilV2",["WADevicesState","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMsg","WAResultOrError","WASaveReceiptApi","WASendMsgInternal","WASentBytesCache","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n;function o(a){return Promise.resolve()}function p(a,b){return d("WADevicesState").getDevicesState().waitForUserDevices(Array.from(new Set([a,d("WAGlobals").getMyUserJid()])),"GetDevicesBeforeSend: "+b)}function q(a,b){a=b.chatJid;var c=b.reason;return d("WAJids").switchOnChatJidType(a,{group:function(a){return o(a)},interopUser:function(a){return p(a,c)},lidUser:function(a){return p(a,c)},msgrUser:function(a){return p(a,c)},phoneUser:function(a){return p(a,c)}}).catch(function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Error during get devices before sending: ",""])),a);return Promise.resolve()})}async function r(a,b){var c=a.messagePayload;a=a.loadThreadParticipants;var e={author:c.protocolMsgId.author,chat:c.protocolMsgId.chat,externalId:c.protocolMsgId.externalId},f=await d("WALoadReceiptApi").loadReceipt(e);if(f.success)return f;b.addPoint("get_devices_before_send_start");await q(void 0,{chatJid:c.protocolMsgId.chat,reason:"prepareReceipt"});b.addPoint("get_devices_before_send_end");var g=await a(c.protocolMsgId.chat);b.addPoint("get_identities_start");f=await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return a.storage.bulkLoadIdentities(g)},{flush:!1,afterInit:!0,operationType:"prepare_receipt_load_identities"});a=[];if(f.size===0)a=[].concat(g);else for(c of f){var h=c[0],j=c[1];j.size===0&&a.push(h)}a.length>0&&(await d("WADevicesState").getDevicesState().waitForUserDevices(a,"GetDevicesBeforeSend: prepareReceipt",!0),f=await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return a.storage.bulkLoadIdentities(g)},{afterInit:!0,flush:!1,operationType:"prepare_receipt_load_identities"}));j=new Map();for(h of f){h[0];c=h[1];for(a of c){f=a[0];c=a[1];if(f===d("WAGlobals").getMyDeviceJid())continue;j.set(f,{pubKey:c})}}b.addPoint("get_identities_end");f=new Set();c={permittedIdentitiesPerDevice:j,recipientDevices:f,id:e};b.addPoint("save_receipts_start");await d("WASaveReceiptApi").saveReceipt(c).catch(function(a){b.addPoint("save_receipts_fail");d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to save receipt for message with error ",""])),a);return d("WAResultOrError").makeError("missing-receipt")});b.addPoint("save_receipts_end");return d("WAResultOrError").makeResult(c)}async function a(a,b,c){a=b.messagePayload;var e=b.loadThreadParticipants,f=b.sendIdentity;f=f===void 0?!1:f;b=b.isInstamadillo;b=b===void 0?!1:b;c.addPoint("prepare_receipt_start");e=await r({messagePayload:a,loadThreadParticipants:e},c);if(e.success===!1){c.addPoint("prepare_receipt_fail");d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message that does not have a receipt in db"])));return d("WAResultOrError").makeError({type:"missing-receipt"})}c.addPoint("prepare_receipt_end");e=e.value;var g=a.frankingKey,h=a.frankingVersion,i=a.messageBytes,n=a.backupDirective,o=a.messageType,p=a.protocolMsgId;a=s(e.permittedIdentitiesPerDevice);e=o.type==="text"&&o.invitedParticipantUserJid!=null?a.filter(function(a){return a.user===o.invitedParticipantUserJid||a.user===d("WAGlobals").getMyUserJid()}):a;c.addPoint("recipients-calculated",{int:{recipientsCount:e.length},string:{msgType:o.type}});a=o.type==="text"&&o.invitedParticipantUserJid!=null?o.invitedParticipantUserJid:p.chat;var q=p.chat===d("WAGlobals").getMyUserJid();if(e.length===0&&!q){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message with no recipients"])));return d("WAResultOrError").makeError({type:"no-recipients",isRetriable:!1})}else if(e.length===0&&q){d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message with no recipients, but it is a self thread"])));return d("WAResultOrError").makeResult({baseKey:null,reportingMeta:null,serverTs:d("WATimeUtils").unixTime()})}q=f?await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return t(a)},{operationType:"get_my_device_identity",flush:!1,afterInit:!0}):null;f=await (o.isRevoked===!0?Promise.resolve(null):d("WAGenReportingMeta").genReportingMeta(i.bytes,g,h));return d("WASendMsgInternal").sendMessage({type:"chat",messageBytes:i,chat:a,deviceIdentity:q,messageType:o,protocolMsgId:p,externalId:p.externalId,recipients:e,reportingMeta:f,backupDirective:n},c,b).then(function(a){if(a.success)return d("WASentBytesCache").sentBytesCache().saveSentBytes({ts:a.value.serverTs,frankingKey:g,frankingVersion:h,messageBytes:i,backupDirective:n,messageType:o,protocolMsgId:p,waMsgId:d("WAMsg").craftWAMsgIdString({author:p.author,chat:p.chat,externalId:p.externalId})}).catch(function(a){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg failed to save sent bytes to cache: ",""])),a)}).then(function(){return a});else return a})}function s(a){var b=new Map();a.forEach(function(a,c){a=a.pubKey;var e=d("WAJids").extractUserJid(c);a={identity:a,jid:c};c=b.get(e)||[];c.push(a);b.set(e,c)});return Array.from(b,function(a){var b=a[0];a=a[1];return{devicesInfo:a,user:b}})}async function t(a){try{a=await a.storage.loadIdentities(d("WAGlobals").getMyUserJid());a=a.get(d("WAGlobals").getMyDeviceJid());if(a!=null)return a;throw c("err")("missing-identity")}catch(a){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Error loading current device identity ",""])),a)}}g.getDevicesBeforeSend=q;g.sendChatMessage=a}),98);
__d("WASetClockSkewApi",["WASetMetaApi"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){a=a.clockSkew;return d("WASetMetaApi").setMeta({clockSkew:a})};g.setClockSkew=a}),98);
__d("WASendPing",["WAComms","WALogger","WASetClockSkewApi","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendPing: sending"]))),d("WAComms").sendPing()}async function b(a,b){a=b.clockSkew;d("WATimeUtils").setClockSkew(a);await d("WASetClockSkewApi").setClockSkew({clockSkew:a})}g.sendPing=a;g.updateClockSkew=b}),98);
__d("WASyncAbProps",["WAAbPropsSync","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;async function a(a,b){b=b.sendHash;d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Syncing ABProps"])));await d("WAAbPropsSync").syncAbProps({sendHash:b,eventFlow:a!=null?a:void 0})}g.syncAbProps=a}),98);
__d("encryptedBackupsOptOutOfBackup",["LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","LSOptOutOfBackupStoredProcedure","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.encrypted_backups)).then(function(b){if(b==null)return[(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE)];var e=b.backupId;return e!=null?a.runInTransaction(function(a){return c("LSOptOutOfBackupStoredProcedure")(c("LSFactory")(a),{backupId:e})},"readwrite",void 0,void 0,f.id+":32"):[(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE)]})}g.optOutOfBackupStoredProcedure=a}),98);